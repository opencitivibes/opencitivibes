# docker-compose.yml
# OpenCitiVibes Production Configuration
# Instance-specific values loaded from environment variables
name: ${COMPOSE_PROJECT_NAME:-opencitivibes}

services:
  # ============================================
  # Reverse Proxy
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: ${CONTAINER_PREFIX:-ocv}-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ssl_certs:/etc/nginx/ssl:ro
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
      ntfy:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Backend API
  # ============================================
  backend:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_REPOSITORY:-opencitivibes}/backend:${IMAGE_TAG:-latest}
    container_name: ${CONTAINER_PREFIX:-ocv}-backend
    restart: unless-stopped
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./data/opencitivibes.db}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - CORS_ORIGINS=${CORS_ORIGINS:-["http://localhost:3000"]}
      - PLATFORM_CONFIG_PATH=${PLATFORM_CONFIG_PATH:-./config/platform.config.json}
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_RELEASE=${IMAGE_TAG:-latest}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Ntfy notification configuration
      - NTFY_URL=${NTFY_INTERNAL_URL:-http://ntfy:80}
      - NTFY_TOPIC_PREFIX=${NTFY_TOPIC_PREFIX:-admin}
      - APP_URL=${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      # Admin seed credentials (used on first startup)
      - ADMIN_EMAIL=${ADMIN_EMAIL:-}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
      # SMTP Email Configuration
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-console}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - SMTP_USE_SSL=${SMTP_USE_SSL:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-OpenCitiVibes}
    volumes:
      - backend_data:/app/data
      - backend_logs:/app/logs
      - ./backend/config:/app/config:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Frontend
  # ============================================
  frontend:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_REPOSITORY:-opencitivibes}/frontend:${IMAGE_TAG:-latest}
    container_name: ${CONTAINER_PREFIX:-ocv}-frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000/api}
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      - NEXT_PUBLIC_INSTANCE_NAME=${NEXT_PUBLIC_INSTANCE_NAME:-OpenCitiVibes}
      - NEXT_PUBLIC_SENTRY_DSN=${NEXT_PUBLIC_SENTRY_DSN:-}
      - NEXT_PUBLIC_ENVIRONMENT=${ENVIRONMENT:-production}
    volumes:
      - ./instance-assets:/app/public/instance:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ============================================
  # Ntfy - Push Notifications
  # ============================================
  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: ${CONTAINER_PREFIX:-ocv}-ntfy
    restart: unless-stopped
    command:
      - serve
    environment:
      - TZ=${TZ:-America/Montreal}
      - NTFY_BASE_URL=${NTFY_BASE_URL:-https://ntfy.localhost}
      - NTFY_BEHIND_PROXY=true
      - NTFY_CACHE_FILE=/var/cache/ntfy/cache.db
      - NTFY_CACHE_DURATION=${NTFY_CACHE_DURATION:-24h}
      - NTFY_AUTH_DEFAULT_ACCESS=deny-all
      - NTFY_AUTH_FILE=/var/lib/ntfy/user.db
      - NTFY_ATTACHMENT_CACHE_DIR=/var/cache/ntfy/attachments
      - NTFY_ENABLE_SIGNUP=false
      - NTFY_ENABLE_LOGIN=true
    volumes:
      - ntfy_cache:/var/cache/ntfy
      - ntfy_data:/var/lib/ntfy
      - ./ntfy/server.yml:/etc/ntfy/server.yml:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/v1/health"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M

  # ============================================
  # PostgreSQL (Optional - enable with --profile postgres)
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: ${CONTAINER_PREFIX:-ocv}-postgres
    restart: unless-stopped
    profiles:
      - postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-opencitivibes}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-opencitivibes}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-opencitivibes} -d ${POSTGRES_DB:-opencitivibes}"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

# ============================================
# Networks
# ============================================
networks:
  app-network:
    driver: bridge
    name: ${NETWORK_NAME:-ocv-network}

# ============================================
# Volumes
# ============================================
volumes:
  backend_data:
    name: ${VOLUME_PREFIX:-ocv}-backend-data
  backend_logs:
    name: ${VOLUME_PREFIX:-ocv}-backend-logs
  postgres_data:
    name: ${VOLUME_PREFIX:-ocv}-postgres-data
  ssl_certs:
    name: ${VOLUME_PREFIX:-ocv}-ssl-certs
  ntfy_cache:
    name: ${VOLUME_PREFIX:-ocv}-ntfy-cache
  ntfy_data:
    name: ${VOLUME_PREFIX:-ocv}-ntfy-data
