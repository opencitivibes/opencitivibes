rules:
  # Dangerous innerHTML
  - id: dangerous-innerhtml
    patterns:
      - pattern-either:
          - pattern: "dangerouslySetInnerHTML={{ __html: $VAR }}"
          - pattern: "dangerouslySetInnerHTML={$OBJ}"
      - pattern-not-inside: |
          sanitizeHtml($VAR)
          ...
    message: "dangerouslySetInnerHTML may lead to XSS if not sanitized"
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-79"

  # localStorage sensitive data
  - id: localstorage-sensitive-data
    patterns:
      - pattern-either:
          - pattern: localStorage.setItem("...", $PASSWORD)
          - pattern: localStorage.setItem("...", $SECRET)
          - pattern: localStorage.setItem("password", ...)
          - pattern: localStorage.setItem("secret", ...)
    message: "Storing sensitive data in localStorage is insecure"
    languages: [typescript, tsx, javascript, jsx]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-922"

  # Hardcoded API keys
  - id: hardcoded-api-key
    patterns:
      - pattern-regex: "(api[_-]?key|apikey|API_KEY)\\s*[:=]\\s*['\"][^'\"]{10,}['\"]"
    message: "Hardcoded API key detected"
    languages: [typescript, tsx, javascript, jsx]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798"

  # eval usage
  - id: eval-usage
    pattern-either:
      - pattern: eval(...)
      - pattern: new Function(...)
    message: "eval() and Function() can lead to code injection"
    languages: [typescript, tsx, javascript, jsx]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-95"

  # Insecure random
  - id: insecure-random
    patterns:
      - pattern: Math.random()
      - pattern-not-inside: |
          // non-security context
          ...
    message: "Math.random() is not cryptographically secure"
    languages: [typescript, tsx, javascript, jsx]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-338"

  # Missing CSRF token
  - id: missing-csrf-protection
    patterns:
      - pattern: |
          axios.post($URL, $DATA)
      - pattern-not: |
          axios.post($URL, $DATA, { headers: { "X-CSRF-Token": ... } })
    message: "POST request may be missing CSRF protection"
    languages: [typescript, tsx, javascript, jsx]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-352"

  # ==========================================================================
  # React-Specific Security
  # ==========================================================================

  - id: unsafe-target-blank
    patterns:
      - pattern: |
          <a ... target="_blank" ... >
      - pattern-not: |
          <a ... target="_blank" rel="noopener noreferrer" ... >
      - pattern-not: |
          <a ... rel="noopener noreferrer" target="_blank" ... >
    message: |
      Links with target="_blank" should have rel="noopener noreferrer"
      to prevent tabnabbing attacks.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      cwe: "CWE-1022"
      category: security

  - id: unvalidated-redirect
    patterns:
      - pattern-either:
          - pattern: router.push($URL)
          - pattern: router.replace($URL)
          - pattern: redirect($URL)
      - pattern-not: router.push("/...")
      - pattern-not: router.replace("/...")
    message: |
      Potentially unvalidated redirect. Ensure URL is from trusted source.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      category: security

  # ==========================================================================
  # Additional XSS Patterns
  # ==========================================================================

  - id: javascript-href-xss
    patterns:
      - pattern: <a href={$URL} ...>
      - metavariable-pattern:
          metavariable: $URL
          patterns:
            - pattern-not: "https://..."
            - pattern-not: "http://..."
            - pattern-not: "/..."
    message: |
      Potential XSS via javascript: protocol in href. Validate URLs.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      category: security

  - id: window-location-manipulation
    patterns:
      - pattern-either:
          - pattern: window.location = $URL
          - pattern: window.location.href = $URL
          - pattern: document.location = $URL
    message: |
      Direct window.location manipulation may lead to open redirect.
      Validate the URL before navigation.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      category: security

  # ==========================================================================
  # Console Logging Security
  # ==========================================================================

  - id: console-log-sensitive-data
    patterns:
      - pattern: console.log(..., $VAR, ...)
      - metavariable-regex:
          metavariable: $VAR
          regex: ".*(token|password|secret|key|auth|credential).*"
    message: |
      Logging potentially sensitive data. Remove before production.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      category: security

  # ==========================================================================
  # Authentication Patterns
  # ==========================================================================

  - id: jwt-decode-without-verify
    patterns:
      - pattern: jwtDecode($TOKEN)
    message: |
      JWT decoded without signature verification on client.
      Ensure JWT is verified by backend before trusting claims.
    languages: [typescript, tsx, javascript, jsx]
    severity: INFO
    metadata:
      category: security

  - id: token-in-localstorage
    patterns:
      - pattern-either:
          - pattern: localStorage.setItem("token", ...)
          - pattern: localStorage.setItem("accessToken", ...)
          - pattern: localStorage.setItem("access_token", ...)
          - pattern: localStorage.setItem("jwt", ...)
    message: |
      Storing authentication tokens in localStorage is vulnerable to XSS.
      Consider using httpOnly cookies instead.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      cwe: "CWE-922"
      category: security

  # ==========================================================================
  # Input Validation
  # ==========================================================================

  - id: innerHTML-assignment
    patterns:
      - pattern: $ELEMENT.innerHTML = $VALUE
    message: |
      Direct innerHTML assignment is vulnerable to XSS.
      Use textContent or sanitize the HTML content with DOMPurify.
    languages: [typescript, tsx, javascript, jsx]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      category: security

  - id: regex-dos
    patterns:
      - pattern: new RegExp($PATTERN)
      - pattern-inside: |
          function $FUNC(...):
              ...
    message: |
      Dynamic regex with user input may be vulnerable to ReDoS.
      Validate and sanitize regex patterns.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      category: security

  # ==========================================================================
  # API Configuration
  # ==========================================================================

  - id: hardcoded-localhost-url
    patterns:
      - pattern-either:
          - pattern: axios.get("http://localhost:...")
          - pattern: fetch("http://localhost:...")
          - pattern: axios.defaults.baseURL = "http://localhost:..."
    message: |
      Hardcoded localhost URL. Use environment variables for configuration.
    languages: [typescript, tsx, javascript, jsx]
    severity: WARNING
    metadata:
      category: security
