rules:
  # ==========================================================================
  # SQL Injection Prevention Rules
  # ==========================================================================

  - id: sqlalchemy-raw-sql-injection
    patterns:
      - pattern-either:
          - pattern: $DB.execute($SQL.format(...))
          - pattern: $DB.execute($SQL % ...)
          - pattern: $DB.execute(f"...")
          - pattern: session.execute($SQL.format(...))
          - pattern: session.execute(text(f"..."))
    message: |
      Potential SQL injection via string formatting in SQLAlchemy query.
      Use parameterized queries or SQLAlchemy ORM methods instead.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 - Injection"
      category: security

  - id: dangerous-filter-bypass
    patterns:
      - pattern-either:
          - pattern: $MODEL.filter(**$PARAM)
          - pattern: $QUERY.filter_by(**$PARAM)
    message: |
      User-controlled dict passed to filter/filter_by can modify query behavior.
      Validate and whitelist allowed filter parameters.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-943"
      category: security

  # ==========================================================================
  # Authentication & Authorization Rules
  # ==========================================================================

  - id: jwt-secret-hardcoded
    patterns:
      - pattern-either:
          - pattern: jwt.encode(..., "...", ...)
          - pattern: jwt.decode(..., "...", ...)
    message: |
      Hardcoded JWT secret detected. Use environment variables for secrets.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      category: security

  # ==========================================================================
  # Input Validation Rules
  # ==========================================================================

  - id: fastapi-path-traversal
    patterns:
      - pattern-either:
          - pattern: open($PATH + ...)
          - pattern: open(f"...{$PATH}...")
          - pattern: os.path.join(..., $PATH)
    message: |
      User-controlled path parameter used in file operations.
      Validate and sanitize path to prevent directory traversal.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021 - Broken Access Control"
      category: security

  - id: ssrf-via-user-url
    patterns:
      - pattern-either:
          - pattern: requests.get($URL, ...)
          - pattern: requests.post($URL, ...)
          - pattern: httpx.get($URL, ...)
    message: |
      User-controlled URL passed to HTTP client.
      Validate URL against allowlist to prevent SSRF.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 - Server-Side Request Forgery"
      category: security

  # ==========================================================================
  # Sensitive Data Exposure
  # ==========================================================================

  - id: debug-mode-enabled
    patterns:
      - pattern-either:
          - pattern: debug=True
          - pattern: DEBUG = True
          - pattern: app = FastAPI(..., debug=True, ...)
    message: |
      Debug mode enabled. Disable in production.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-489"
      category: security

  # ==========================================================================
  # CORS Security
  # ==========================================================================

  - id: cors-allow-all-origins
    patterns:
      - pattern-either:
          - pattern: allow_origins=["*"]
          - pattern: CORSMiddleware(..., allow_origins=["*"], ...)
    message: |
      CORS configured to allow all origins. Restrict to specific origins in production.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-942"
      owasp: "A05:2021 - Security Misconfiguration"
      category: security

  - id: cors-allow-credentials-with-wildcard
    patterns:
      - pattern: CORSMiddleware(..., allow_origins=["*"], ..., allow_credentials=True, ...)
    message: |
      CORS allows credentials with wildcard origin. This is a security risk.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-942"
      category: security

  # ==========================================================================
  # JWT Security Rules
  # ==========================================================================

  - id: jwt-weak-algorithm-none
    patterns:
      - pattern-either:
          - pattern: jwt.encode(..., algorithm="none", ...)
          - pattern: Algorithm = "none"
          - pattern: ALGORITHM = "none"
    message: |
      JWT using 'none' algorithm. This completely disables signature verification.
      Use RS256 or ES256 for production, HS256 minimum with strong secret.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-327"
      category: security

  # ==========================================================================
  # Rate Limiting Bypass
  # ==========================================================================

  - id: rate-limit-header-trust
    patterns:
      - pattern-either:
          - pattern: request.headers.get("X-Forwarded-For", ...)
          - pattern: request.headers["X-Real-IP"]
    message: |
      Rate limiting using client-provided headers can be bypassed.
      Use the actual client IP from the connection if behind trusted proxy.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-290"
      category: security

  # ==========================================================================
  # Open Redirect
  # ==========================================================================

  - id: open-redirect-fastapi
    patterns:
      - pattern-either:
          - pattern: RedirectResponse(url=$URL, ...)
          - pattern: RedirectResponse($URL, ...)
      - pattern-inside: |
          def $FUNC(...):
              ...
      - metavariable-pattern:
          metavariable: $URL
          patterns:
            - pattern-not: "..."
    message: |
      Possible open redirect. Validate redirect URLs against an allowlist.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-601"
      owasp: "A01:2021 - Broken Access Control"
      category: security

  # ==========================================================================
  # Sensitive Data Exposure
  # ==========================================================================

  - id: password-in-response
    patterns:
      - pattern-either:
          - pattern: 'return {..., "password": ..., ...}'
          - pattern: 'return {..., "hashed_password": ..., ...}'
    message: |
      Password field in API response. Remove sensitive fields from responses.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-200"
      category: security

  - id: sensitive-data-in-logs
    patterns:
      - pattern-either:
          - pattern: logger.$METHOD(..., password=..., ...)
          - pattern: print(..., password=..., ...)
          - pattern: logging.$METHOD(... + $PASSWORD + ...)
    message: |
      Sensitive data may be logged. Remove passwords and tokens from log statements.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-532"
      category: security

  # ==========================================================================
  # Command Injection
  # ==========================================================================

  - id: subprocess-shell-injection
    patterns:
      - pattern-either:
          - pattern: subprocess.run($CMD, shell=True, ...)
          - pattern: subprocess.Popen($CMD, shell=True, ...)
          - pattern: os.system($CMD)
    message: |
      Potential command injection. Avoid shell=True with user input.
      Use subprocess with a list of arguments instead.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021 - Injection"
      category: security

  # ==========================================================================
  # Insecure Deserialization
  # ==========================================================================

  - id: pickle-deserialization
    patterns:
      - pattern-either:
          - pattern: pickle.loads(...)
          - pattern: pickle.load(...)
    message: |
      Pickle deserialization is dangerous with untrusted data.
      Consider using JSON or a safer serialization format.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021 - Software and Data Integrity Failures"
      category: security

  # ==========================================================================
  # File Upload Vulnerabilities
  # ==========================================================================

  - id: unsafe-file-upload
    patterns:
      - pattern: $FILE.filename
      - pattern-inside: |
          async def $FUNC(..., $FILE: UploadFile, ...):
              ...
      - pattern-not-inside: |
          ... = secure_filename($FILE.filename)
    message: |
      File upload using unsanitized filename. Use werkzeug.utils.secure_filename
      or validate the filename to prevent path traversal.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-22"
      category: security

  # ==========================================================================
  # XML External Entity (XXE)
  # ==========================================================================

  - id: xxe-vulnerable-parser
    patterns:
      - pattern-either:
          - pattern: etree.parse(...)
          - pattern: ElementTree.parse(...)
    message: |
      XML parser may be vulnerable to XXE attacks.
      Disable external entity resolution with resolve_entities=False.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2021 - Security Misconfiguration"
      category: security
