# docker-compose.pentest.yml
# OpenCitiVibes Penetration Testing Environment

name: opencitivibes-pentest

services:
  # Full pentest container with all tools (default)
  pentest:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_PLAYWRIGHT: "true"
        INSTALL_SCHEMATHESIS: "true"
        INSTALL_SYFT: "true"
    image: opencitivibes-pentest:latest
    container_name: ocv-pentest
    hostname: pentest
    profiles: ["full", "default"]
    stdin_open: true
    tty: true
    privileged: true  # Required for some network tools

    # Network access to target containers
    networks:
      - dev-network

    # Volume mounts
    volumes:
      # Source code (read-only)
      - ../:/app/source:ro
      # Results output
      - ./results:/app/results
      # Custom wordlists
      - ./wordlists:/app/wordlists
      # Custom scripts
      - ./scripts:/app/scripts
      # Database access (for white-box testing)
      - ../backend/data:/app/data:ro
      # Persistent tool configurations
      - pentest-config:/root/.config
      - pentest-cache:/root/.cache

    # Environment variables
    environment:
      - TZ=America/Montreal
      - TARGET_BACKEND=http://ocv-socenv-backend-dev:8000
      - TARGET_FRONTEND=http://ocv-socenv-frontend-dev:3000
      - TARGET_API=http://ocv-socenv-backend-dev:8000/api
      - RESULTS_DIR=/app/results
      - SOURCE_DIR=/app/source

    # Capabilities for network tools
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_PTRACE

    # Security options
    security_opt:
      - seccomp:unconfined

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G

    # Keep container running
    command: ["tail", "-f", "/dev/null"]

  # Light pentest container for CI (no Playwright, smaller image)
  pentest-light:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_PLAYWRIGHT: "false"
        INSTALL_SYFT: "false"
        INSTALL_SCHEMATHESIS: "true"
    image: opencitivibes-pentest:light
    container_name: ocv-pentest-light
    hostname: pentest-light
    profiles: ["light", "ci"]
    stdin_open: true
    tty: true
    # No privileged mode for CI
    networks:
      - dev-network
    volumes:
      - ../:/app/source:ro
      - ./results:/app/results
      - ./scripts:/app/scripts
    environment:
      - TZ=America/Montreal
      - TARGET_BACKEND=http://ocv-socenv-backend-dev:8000
      - TARGET_FRONTEND=http://ocv-socenv-frontend-dev:3000
      - TARGET_API=http://ocv-socenv-backend-dev:8000/api
      - RESULTS_DIR=/app/results
      - SOURCE_DIR=/app/source
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    command: ["tail", "-f", "/dev/null"]

networks:
  dev-network:
    external: true
    name: idees-mtl-dev-network

volumes:
  pentest-config:
    name: ocv-pentest-config
  pentest-cache:
    name: ocv-pentest-cache
