# OWASP ZAP Automation Framework Configuration
# OpenCitiVibes Penetration Testing
# Phase 2: Automated Scanning Infrastructure

env:
  contexts:
    - name: "OpenCitiVibes API"
      urls:
        - "http://backend:8000/api"
      includePaths:
        - "http://backend:8000/api.*"
      excludePaths:
        - "http://backend:8000/api/health"
        - "http://backend:8000/docs.*"
        - "http://backend:8000/redoc.*"
      authentication:
        method: "json"
        parameters:
          loginPageUrl: "http://backend:8000/api/auth/login"
          loginRequestUrl: "http://backend:8000/api/auth/login"
          loginRequestBody: '{"username":"{%username%}","password":"{%password%}"}'
          tokenName: "access_token"
          tokenJsonPath: "$.access_token"
        verification:
          method: "response"
          loggedInRegex: "\\Qaccess_token\\E"
      users:
        - name: "admin"
          credentials:
            username: "${ADMIN_EMAIL}"
            password: "${ADMIN_PASSWORD}"
        - name: "regular_user"
          credentials:
            username: "${TEST_USER_EMAIL}"
            password: "${TEST_USER_PASSWORD}"

jobs:
  # Spider the application
  - type: spider
    parameters:
      context: "OpenCitiVibes API"
      user: "admin"
      maxDuration: 10
      maxDepth: 10
      maxChildren: 0

  # Ajax Spider for SPA content
  - type: spiderAjax
    parameters:
      context: "OpenCitiVibes API"
      user: "admin"
      maxDuration: 10
      maxCrawlDepth: 10
      numberOfBrowsers: 2

  # Passive scan
  - type: passiveScan-wait
    parameters:
      maxDuration: 5

  # Active scan
  - type: activeScan
    parameters:
      context: "OpenCitiVibes API"
      user: "admin"
      policy: "API-Scan-Policy"
      maxRuleDurationInMins: 5
      maxScanDurationInMins: 60

  # Generate reports
  - type: report
    parameters:
      template: "traditional-html"
      reportDir: "/app/results/zap"
      reportFile: "zap-report"
      reportTitle: "OpenCitiVibes Security Scan Report"
      reportDescription: "DAST scan results for OpenCitiVibes API"
    risks:
      - high
      - medium
      - low
      - informational

  - type: report
    parameters:
      template: "traditional-json"
      reportDir: "/app/results/zap"
      reportFile: "zap-report"
