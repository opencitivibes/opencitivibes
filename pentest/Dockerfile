# ============================================================================
# OpenCitiVibes Penetration Testing Container
# Base Image: Kali Linux Rolling
# ============================================================================
FROM kalilinux/kali-rolling:latest

LABEL maintainer="security@opencitivibes.com"
LABEL description="Penetration testing container for OpenCitiVibes"
LABEL version="2.0.0"

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=America/Montreal

# ============================================================================
# Build Configuration ARGs (for flexible CI builds)
# ============================================================================
ARG INSTALL_PLAYWRIGHT=true
ARG INSTALL_SCHEMATHESIS=true
ARG INSTALL_SYFT=true

# ============================================================================
# STAGE 1: System Updates and Base Packages
# ============================================================================

RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    # Essential system utilities
    curl \
    wget \
    git \
    vim \
    nano \
    tmux \
    screen \
    htop \
    tree \
    jq \
    yq \
    unzip \
    zip \
    p7zip-full \
    ca-certificates \
    gnupg \
    lsb-release \
    software-properties-common \
    # Networking tools
    net-tools \
    iputils-ping \
    dnsutils \
    whois \
    traceroute \
    netcat-openbsd \
    socat \
    tcpdump \
    wireshark-common \
    tshark \
    # Development essentials
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    autoconf \
    automake \
    libtool \
    pkg-config \
    # Python build dependencies
    libffi-dev \
    libssl-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libpq-dev \
    # Other dependencies
    libpcap-dev \
    libmagic1 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# STAGE 2: Python 3.13 Installation (from Kali repos if available, else source)
# ============================================================================

# Try to use system Python 3.13 from Kali repos first (faster)
# Fall back to source build only if needed
RUN apt-get update && \
    if apt-cache show python3.13 2>/dev/null; then \
        apt-get install -y python3.13 python3.13-venv python3-pip && \
        ln -sf /usr/bin/python3.13 /usr/local/bin/python && \
        ln -sf /usr/bin/python3.13 /usr/local/bin/python3; \
    else \
        # Build from source without PGO for faster builds (use --enable-optimizations for prod)
        cd /tmp && \
        wget https://www.python.org/ftp/python/3.13.1/Python-3.13.1.tgz && \
        tar xzf Python-3.13.1.tgz && \
        cd Python-3.13.1 && \
        ./configure --with-ensurepip=install && \
        make -j$(nproc) && \
        make altinstall && \
        cd / && rm -rf /tmp/Python-3.13.1* && \
        ln -sf /usr/local/bin/python3.13 /usr/local/bin/python && \
        ln -sf /usr/local/bin/python3.13 /usr/local/bin/python3 && \
        ln -sf /usr/local/bin/pip3.13 /usr/local/bin/pip && \
        ln -sf /usr/local/bin/pip3.13 /usr/local/bin/pip3; \
    fi && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Upgrade pip and install essential Python packages
# Use --break-system-packages for Kali's PEP 668 compliance
RUN pip install --break-system-packages --upgrade pip setuptools wheel && \
    pip install --break-system-packages --no-cache-dir \
    virtualenv \
    pipx \
    poetry \
    httpx \
    aiohttp \
    requests \
    beautifulsoup4 \
    lxml \
    pyyaml \
    python-dotenv \
    rich \
    click \
    typer \
    pwntools

# ============================================================================
# STAGE 3: Node.js 20 Installation
# ============================================================================

RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g npm@latest && \
    npm install -g pnpm yarn

# ============================================================================
# STAGE 4: Go Installation (for many security tools)
# ============================================================================

ARG GO_VERSION=1.22.5

RUN wget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz && \
    rm go${GO_VERSION}.linux-amd64.tar.gz

ENV PATH=$PATH:/usr/local/go/bin:/root/go/bin
ENV GOPATH=/root/go

# ============================================================================
# STAGE 5: Kali Meta-Packages (Selective Installation)
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    # Web application testing
    nikto \
    dirb \
    gobuster \
    wfuzz \
    whatweb \
    wafw00f \
    # Network scanning
    nmap \
    masscan \
    # Password cracking
    hydra \
    john \
    hashcat \
    # Exploitation frameworks
    metasploit-framework \
    # Database tools
    sqlmap \
    # SSL/TLS testing
    sslscan \
    sslyze \
    testssl.sh \
    # Proxy tools
    mitmproxy \
    # Wordlists
    wordlists \
    seclists \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# STAGE 6: Additional Go-based Tools
# ============================================================================

# Install Go-based security tools
RUN go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest && \
    go install github.com/projectdiscovery/httpx/cmd/httpx@latest && \
    go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest && \
    go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest && \
    go install github.com/ffuf/ffuf/v2@latest && \
    go install github.com/tomnomnom/gf@latest && \
    go install github.com/tomnomnom/waybackurls@latest && \
    go install github.com/lc/gau/v2/cmd/gau@latest && \
    go install github.com/hakluke/hakrawler@latest

# Install gitleaks via pre-built binary (module path issues with go install)
RUN curl -sSfL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_8.30.0_linux_x64.tar.gz | tar xz -C /usr/local/bin gitleaks

# Install trufflehog via pre-built binary (go install fails due to replace directives)
RUN curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

# ============================================================================
# STAGE 7: Python Security Tools
# ============================================================================

RUN pip install --break-system-packages --no-cache-dir --ignore-installed \
    # Static analysis
    bandit \
    semgrep \
    safety \
    pip-audit \
    # Web testing
    wapiti3 \
    # JWT tools
    pyjwt \
    python-jose \
    # HTTP tools
    httpie \
    # Exploitation
    impacket

# Install jwt_tool from GitHub
RUN git clone https://github.com/ticarpi/jwt_tool.git /opt/jwt_tool && \
    pip install --break-system-packages termcolor cprint pycryptodomex && \
    ln -s /opt/jwt_tool/jwt_tool.py /usr/local/bin/jwt_tool

# ============================================================================
# STAGE 7.5: Playwright Browser Automation (Optional - adds ~400MB)
# ============================================================================

ARG INSTALL_PLAYWRIGHT
RUN if [ "$INSTALL_PLAYWRIGHT" = "true" ]; then \
    pip install --break-system-packages --no-cache-dir playwright && \
    # Install system dependencies for Playwright browsers
    apt-get update && apt-get install -y --no-install-recommends \
        libnss3 \
        libnspr4 \
        libatk1.0-0 \
        libatk-bridge2.0-0 \
        libcups2 \
        libdrm2 \
        libxkbcommon0 \
        libxcomposite1 \
        libxdamage1 \
        libxfixes3 \
        libxrandr2 \
        libgbm1 \
        libasound2t64 \
        libpango-1.0-0 \
        libcairo2 \
        libatspi2.0-0 \
    && apt-get clean && rm -rf /var/lib/apt/lists/* && \
    # Install Chromium browser for Playwright
    playwright install chromium; \
fi

# ============================================================================
# STAGE 7.6: Schemathesis API Fuzzing (Optional)
# ============================================================================

ARG INSTALL_SCHEMATHESIS
RUN if [ "$INSTALL_SCHEMATHESIS" = "true" ]; then \
    pip install --break-system-packages --no-cache-dir schemathesis; \
fi

# ============================================================================
# STAGE 8: Container Security Tools
# ============================================================================

# Trivy
RUN curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# Grype
RUN curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

# Syft (SBOM generator - Optional)
ARG INSTALL_SYFT
ARG SYFT_VERSION=1.5.0
RUN if [ "$INSTALL_SYFT" = "true" ]; then \
    curl -sSfL https://github.com/anchore/syft/releases/download/v${SYFT_VERSION}/syft_${SYFT_VERSION}_linux_amd64.tar.gz \
    | tar -xzf - -C /usr/local/bin syft; \
fi

# ============================================================================
# STAGE 9: OWASP ZAP (Headless)
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    openjdk-21-jre-headless \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN wget -q https://github.com/zaproxy/zaproxy/releases/download/v2.17.0/ZAP_2.17.0_Linux.tar.gz && \
    tar -xzf ZAP_2.17.0_Linux.tar.gz -C /opt && \
    rm ZAP_2.17.0_Linux.tar.gz && \
    ln -s /opt/ZAP_2.17.0/zap.sh /usr/local/bin/zap

# ============================================================================
# STAGE 10: Directory Structure and Permissions
# ============================================================================

WORKDIR /app

RUN mkdir -p /app/source \
             /app/results \
             /app/wordlists \
             /app/scripts \
             /app/data \
             /app/logs \
             /app/reports \
             /app/exploits \
             /app/nuclei-templates \
             /app/semgrep-rules

# Download nuclei templates
RUN nuclei -update-templates

# ============================================================================
# STAGE 11: Custom Scripts and Configuration
# ============================================================================

# Copy custom scripts
COPY scripts/ /app/scripts/
RUN chmod +x /app/scripts/*.sh /app/scripts/*.py 2>/dev/null || true

# Copy custom wordlists
COPY wordlists/ /app/wordlists/

# Copy configuration files
COPY config/ /app/config/

# Set environment variables
ENV RESULTS_DIR=/app/results
ENV SOURCE_DIR=/app/source
ENV WORDLISTS_DIR=/app/wordlists
ENV SCRIPTS_DIR=/app/scripts

# ============================================================================
# STAGE 12: Entrypoint
# ============================================================================

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]
