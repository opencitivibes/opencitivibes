# OpenCitiVibes Penetration Testing Suite

A comprehensive, Docker-based penetration testing framework designed specifically for security assessment of the OpenCitiVibes (IdeesPourMontreal) civic engagement platform. This suite provides automated scanning, manual testing tools, and reporting capabilities for both black-box and white-box security assessments.

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Directory Structure](#directory-structure)
- [Phase 1: Container Setup](#phase-1-container-setup)
- [Phase 2: Automated Scanning](#phase-2-automated-scanning)
- [Phase 3: Web Application Testing](#phase-3-web-application-testing)
- [Phase 4: White-Box Analysis](#phase-4-white-box-analysis)
- [Phase 5: Exploitation](#phase-5-exploitation)
- [Phase 6: Reporting](#phase-6-reporting)
- [Script Reference](#script-reference)
- [Results Location](#results-location)
- [Configuration](#configuration)
- [Ethical Considerations](#ethical-considerations)
- [Troubleshooting](#troubleshooting)

---

## Overview

This penetration testing suite is tailored for the OpenCitiVibes application stack:

**Target Application:**
- **Backend:** FastAPI 0.121.3 (Python 3.13) with SQLAlchemy/SQLite
- **Frontend:** Next.js 16 (App Router) with React 19
- **Authentication:** JWT (HS256) with bcrypt password hashing
- **Infrastructure:** Docker Compose with nginx reverse proxy

**Testing Capabilities:**
- Dynamic Application Security Testing (DAST)
- Static Application Security Testing (SAST)
- Dependency vulnerability scanning
- Secret detection
- JWT security testing
- SQL injection testing
- XSS and IDOR testing
- Container security analysis
- Automated report generation

---

## Prerequisites

### System Requirements

| Requirement | Minimum | Recommended |
|-------------|---------|-------------|
| Docker | 24.0+ | Latest |
| Docker Compose | 2.20+ | Latest |
| RAM | 4GB | 8GB |
| Disk Space | 10GB | 20GB |
| CPU Cores | 2 | 4+ |

### Network Requirements

- Access to the target application network (`idees-mtl-dev-network`)
- Target containers must be running before testing
- No firewall blocking container-to-container communication

### Authorization Requirements

**IMPORTANT:** Only test systems you have explicit authorization to test.

- Written authorization from the system owner
- Defined scope of testing
- Emergency contact information
- Agreed-upon testing windows

---

## Quick Start

### 1. Start Target Environment

First, ensure the OpenCitiVibes development environment is running. Choose the instance you want to test:

```bash
# From the project root
cd /home/matt/projects/IdeesPourMontreal

# Start ONE of the following instances:
docker-compose -f Docker/docker-compose.socenv.dev.yml up -d    # socenv (demo)
docker-compose -f Docker/docker-compose.montreal.dev.yml up -d  # montreal
docker-compose -f Docker/docker-compose.quebec.dev.yml up -d    # quebec
docker-compose -f Docker/docker-compose.calgary.dev.yml up -d   # calgary
```

> **Note:** Phase 2 scripts will automatically detect which instance is running.

### 2. Build the Pentest Container

```bash
cd pentest/
docker-compose -f docker-compose.pentest.yml build
```

### 3. Start the Pentest Container

```bash
docker-compose -f docker-compose.pentest.yml up -d
```

### 4. Access the Container

```bash
docker exec -it ocv-pentest bash
```

### 5. Run a Quick Scan

```bash
# Inside the container
/app/scripts/quick-scan.sh
```

### 6. Run Full Assessment

```bash
# Inside the container
/app/scripts/full-scan.sh
```

### 7. View Results

Results are saved to `/app/results/<timestamp>/` inside the container and mounted to `./results/` on the host.

---

## Directory Structure

```
pentest/
|-- Dockerfile                    # Container build definition
|-- docker-compose.pentest.yml    # Container orchestration
|-- entrypoint.sh                 # Container initialization script
|-- config/                       # Tool configuration files
|   |-- .env.example              # Environment template
|   |-- bandit.yaml               # Bandit SAST configuration
|   |-- eslint-security.config.js # ESLint security rules
|   |-- semgrep-config.yaml       # Semgrep configuration
|   |-- zap-config.yaml           # OWASP ZAP configuration
|   |-- zap-api-policy.policy     # ZAP scan policy
|   +-- mitmproxy/                # Proxy configuration
|       +-- config.yaml
|-- scripts/                      # Automation scripts
|   |-- helpers/                  # Helper libraries
|   |   |-- colors.sh             # Terminal color definitions
|   |   +-- auth_discovery.py     # Auth endpoint discovery
|   |-- mitmproxy/                # Proxy scripts
|   |   +-- auth_interceptor.py   # Request interception
|   |-- reporting/                # Report generation pipeline
|   |   |-- aggregate_findings.py # Aggregates findings from all tools
|   |   |-- cve_lookup.py         # CVE database integration (NVD API)
|   |   |-- generate_report.py    # Generates HTML, CSV, JSON, MD reports
|   |   +-- remediation_engine.py # Provides specific remediation recommendations
|   |-- recon.sh                  # Reconnaissance
|   |-- quick-scan.sh             # Fast vulnerability scan
|   |-- full-scan.sh              # Comprehensive scan
|   |-- generate-report.sh        # Master reporting script
|   |-- run-zap.sh                # OWASP ZAP automation
|   |-- run-nuclei.sh             # Nuclei scanning
|   |-- run-bandit.sh             # Python SAST
|   |-- run-semgrep.sh            # Multi-language SAST
|   |-- run-eslint-security.sh    # TypeScript SAST
|   |-- sast-full.sh              # Complete SAST suite
|   |-- dep-audit.sh              # Dependency scanning
|   |-- secret-scan.sh            # Secret detection
|   |-- container-scan.sh         # Container security
|   |-- api-fuzz.sh               # API fuzzing
|   |-- sqlmap-test.sh            # SQL injection testing
|   |-- start-proxy.sh            # Proxy launcher
|   |-- jwt-test.py               # JWT security testing
|   |-- auth-test.py              # Authentication testing
|   |-- idor-test.py              # IDOR vulnerability testing
|   |-- xss-test.py               # XSS testing
|   |-- analyze-python-patterns.py # Custom pattern analysis
|   |-- exploit-chain.sh          # Exploitation suite
|   |-- crack-hashes.sh           # Password cracking
|   |-- privesc-test.sh           # Privilege escalation
|   +-- collect-evidence.py       # Evidence collection
|-- exploits/                     # Custom exploit scripts
|   |-- jwt_alg_confusion.py      # JWT attack script
|   +-- sqli_exploit.py           # SQL injection exploit
|-- nuclei-templates/             # Custom Nuclei templates
|   +-- opencitivibes/
|       |-- admin-access.yaml     # Admin panel tests
|       |-- idor-ideas.yaml       # IDOR testing
|       |-- jwt-algo-confusion.yaml # JWT tests
|       +-- rate-limit-bypass.yaml  # Rate limit tests
|-- semgrep-rules/                # Custom Semgrep rules
|   |-- fastapi-security.yaml     # FastAPI patterns
|   +-- react-security.yaml       # React patterns
|-- wordlists/                    # Custom wordlists
|   |-- jwt-secrets.txt           # Common JWT secrets
|   +-- project-specific/
|       +-- opencitivibes-paths.txt # API endpoints
+-- results/                      # Scan output directory
```

---

## Phase 1: Container Setup

### Building the Container

The pentest container is based on Kali Linux and includes:

- Python 3.13 with security tools
- Node.js 20 for frontend analysis
- Go 1.22 for modern security tools
- Pre-installed Kali security packages

```bash
cd pentest/
docker-compose -f docker-compose.pentest.yml build
```

**Build time:** Approximately 15-30 minutes (first build)

### Container Features

| Category | Tools Included |
|----------|---------------|
| Scanning | nmap, masscan, nikto, nuclei, OWASP ZAP |
| Web Testing | sqlmap, ffuf, gobuster, dirb, wfuzz |
| SAST | bandit, semgrep, pip-audit |
| Secrets | gitleaks, trufflehog |
| Container | trivy, grype |
| Password | hydra, john, hashcat |
| Exploitation | metasploit, impacket |
| Proxy | mitmproxy |

### Network Configuration

The container connects to `idees-mtl-dev-network` to access:

| Service | Address |
|---------|---------|
| Backend API | `http://ocv-socenv-backend-dev:8000` |
| Frontend | `http://ocv-socenv-frontend-dev:3000` |

### Volume Mounts

| Host Path | Container Path | Purpose |
|-----------|---------------|---------|
| `../` | `/app/source` | Source code (read-only) |
| `./results` | `/app/results` | Scan outputs |
| `./scripts` | `/app/scripts` | Custom scripts |
| `./wordlists` | `/app/wordlists` | Wordlists |
| `../backend/data` | `/app/data` | Database (read-only) |

---

## Phase 2: Automated Scanning

### Automatic Instance Detection

Phase 2 scripts automatically detect the running instance by checking active Docker containers. The detection determines:

- **Target URLs** (backend, frontend, API endpoints)
- **Admin credentials** for authenticated testing
- **Database location** for white-box analysis
- **Instance-specific wordlists** and payloads

```bash
# Scripts auto-detect which instance is running:
# - Checks for ocv-socenv-*, ocv-montreal-*, ocv-quebec-*, ocv-calgary-*
# - Sets TARGET_BACKEND, TARGET_API, ADMIN_EMAIL automatically
# - Falls back to environment variables if detection fails

# To manually override detection:
export TARGET_INSTANCE=montreal
export TARGET_BACKEND=http://ocv-montreal-backend-dev:8000
export TARGET_API=http://ocv-montreal-backend-dev:8000/api
export ADMIN_EMAIL=admin@idees-montreal.ca
```

### Reconnaissance

Initial target enumeration and fingerprinting:

```bash
/app/scripts/recon.sh
```

**What it does:**
- Discovers API endpoints via OpenAPI/Swagger
- Fingerprints technologies (WhatWeb)
- Analyzes HTTP security headers
- Detects WAF presence (wafw00f)
- Performs port scanning (nmap)
- Quick directory enumeration (gobuster)

**Output:** `$SCAN_DIR/recon/`

### OWASP ZAP Scanning

Dynamic application security testing:

```bash
# Baseline scan (fast)
/app/scripts/run-zap.sh baseline

# Full scan (comprehensive)
/app/scripts/run-zap.sh full

# API-specific scan
/app/scripts/run-zap.sh api

# Authenticated scan
/app/scripts/run-zap.sh auth
```

**Output:** `$SCAN_DIR/zap/`

### Nuclei Vulnerability Scanning

Template-based vulnerability detection:

```bash
# Quick scan (critical/high only)
/app/scripts/run-nuclei.sh quick

# Standard scan (includes medium)
/app/scripts/run-nuclei.sh standard

# Full scan (all templates)
/app/scripts/run-nuclei.sh full

# Custom templates only
/app/scripts/run-nuclei.sh custom
```

**Custom templates location:** `/app/nuclei-templates/opencitivibes/`

**Output:** `$SCAN_DIR/nuclei/`

### Dependency Vulnerability Scanning

```bash
/app/scripts/dep-audit.sh
```

**What it scans:**
- Python dependencies (pip-audit, safety)
- Node.js dependencies (pnpm audit, npm audit)

**Output:** `$SCAN_DIR/dependencies/`

### Secret Detection

```bash
/app/scripts/secret-scan.sh
```

**Tools used:**
- Gitleaks
- TruffleHog
- Custom pattern matching

**Output:** `$SCAN_DIR/secrets/`

### Container Security

```bash
/app/scripts/container-scan.sh
```

**What it analyzes:**
- Docker image vulnerabilities (Trivy, Grype)
- Docker Compose configuration
- Container security posture

**Output:** `$SCAN_DIR/container/`

### Full Automated Scan

Run all Phase 2 scanners in sequence:

```bash
/app/scripts/full-scan.sh
```

---

## Phase 3: Web Application Testing

### Proxy-Based Testing

Start mitmproxy for request interception:

```bash
/app/scripts/start-proxy.sh
```

**Access:**
- Proxy port: 8081
- Web interface: http://localhost:8082

### SQL Injection Testing

```bash
/app/scripts/sqlmap-test.sh
```

**Tests:**
- GET parameter injection
- POST body injection
- JSON payload injection
- Authentication bypass attempts

**Output:** `$SCAN_DIR/sqlmap/`

### JWT Security Testing

```bash
python /app/scripts/jwt-test.py
```

**Tests performed:**
- Algorithm 'none' bypass
- Weak secret brute force
- Token manipulation
- Expiration validation
- Signature stripping

**Output:** `$SCAN_DIR/jwt-test-results.json`

### Authentication Testing

```bash
python /app/scripts/auth-test.py
```

**Tests performed:**
- Rate limiting effectiveness
- Account enumeration
- Password policy validation
- Concurrent session handling
- Logout token invalidation

**Output:** `$SCAN_DIR/auth-test-results.json`

### IDOR Testing

```bash
python /app/scripts/idor-test.py
```

**Tests performed:**
- Idea access control
- User profile access
- Vote manipulation
- Admin endpoint protection

**Output:** `$SCAN_DIR/idor-test-results.json`

### XSS Testing

```bash
python /app/scripts/xss-test.py
```

**Tests performed:**
- Stored XSS in ideas
- Stored XSS in comments
- Reflected XSS in search

**Output:** `$SCAN_DIR/xss-test-results.json`

### API Fuzzing

```bash
/app/scripts/api-fuzz.sh
```

**What it does:**
- Hidden endpoint discovery
- Parameter fuzzing
- IDOR via ID enumeration
- HTTP method testing
- Content-Type fuzzing

**Output:** `$SCAN_DIR/fuzzing/`

---

## Phase 4: White-Box Analysis

### Bandit (Python SAST)

```bash
/app/scripts/run-bandit.sh
```

**Checks for:**
- SQL injection patterns
- Command injection
- Hardcoded secrets
- Weak cryptography
- Debug mode issues

**Output:** `$SCAN_DIR/sast/bandit-report.json`

### Semgrep Analysis

```bash
/app/scripts/run-semgrep.sh
```

**Custom rules include:**
- SQLAlchemy injection patterns
- JWT security issues
- Missing authentication
- CORS misconfiguration
- React XSS patterns

**Output:** `$SCAN_DIR/sast/semgrep-*.json`

### ESLint Security

```bash
/app/scripts/run-eslint-security.sh
```

**Checks for:**
- XSS vulnerabilities
- Hardcoded secrets
- Unsafe patterns
- React-specific issues

**Output:** `$SCAN_DIR/sast/eslint-security.json`

### Custom Pattern Analysis

```bash
python /app/scripts/analyze-python-patterns.py
```

**Project-specific checks:**
- Direct DB queries in routers
- JWT without algorithm specification
- Hardcoded secrets in variables

**Output:** `$SCAN_DIR/sast/custom-python-analysis.json`

### Full SAST Suite

Run all static analysis tools:

```bash
/app/scripts/sast-full.sh
```

---

## Phase 5: Exploitation

### Metasploit Setup

```bash
/app/scripts/setup-metasploit.sh
```

### JWT Exploitation

```bash
python /app/exploits/jwt_alg_confusion.py \
    --target http://ocv-socenv-backend-dev:8000/api \
    --username admin@idees-montreal.ca \
    --password Admin2024!Mtl
```

**Exploit attempts:**
- Algorithm confusion (none)
- Weak secret discovery
- Privilege escalation via token manipulation

### SQL Injection Exploitation

```bash
python /app/exploits/sqli_exploit.py \
    --target http://ocv-socenv-backend-dev:8000/api
```

**Techniques:**
- Error-based injection
- UNION-based injection
- Boolean blind injection
- Time-based blind injection

### Password Cracking

```bash
/app/scripts/crack-hashes.sh
```

**Attempts:**
- Extract hashes from database
- John the Ripper attack
- Hashcat dictionary attack

**Output:** `$SCAN_DIR/cracking/`

### Privilege Escalation Testing

```bash
/app/scripts/privesc-test.sh
```

**Checks:**
- Container environment analysis
- SUID/SGID binaries
- Docker socket access
- Capability analysis
- Container escape vectors

**Output:** `$SCAN_DIR/privesc/`

### Full Exploitation Chain

```bash
/app/scripts/exploit-chain.sh
```

### Evidence Collection

```bash
python /app/scripts/collect-evidence.py
```

---

## Phase 6: Reporting and Remediation System

The Phase 6 reporting system provides a comprehensive pipeline for aggregating, enriching, and generating professional security assessment reports from all previous scanning and testing phases.

### Report Generation Pipeline

The reporting system consists of four stages that process findings sequentially:

```
Scanner Outputs -> Aggregation -> CVE Enrichment -> Remediation -> Report Generation
```

#### Master Script

The `generate-report.sh` script orchestrates the entire reporting pipeline:

```bash
/app/scripts/generate-report.sh
```

This master script runs all four stages in sequence and provides progress output for each phase.

#### Stage 1: Findings Aggregation

**Script:** `reporting/aggregate_findings.py`

Aggregates findings from all scanning tools into a unified format:

```bash
python /app/scripts/reporting/aggregate_findings.py
```

**Input sources parsed:**
- Nuclei JSON output (`**/nuclei*.json`)
- Bandit SAST results (`**/bandit*.json`)
- Semgrep analysis (`**/semgrep*.json`)
- OWASP ZAP reports (`**/zap*.json`)
- Custom test results (`**/jwt-test*.json`, `**/auth-test*.json`, `**/idor-test*.json`, `**/xss-test*.json`)

**Features:**
- Automatic deduplication of findings
- Standardized finding format with ID, severity, category, and evidence
- CWE mapping where available
- Severity breakdown statistics

**Output:** `$SCAN_DIR/aggregated_findings.json`

#### Stage 2: CVE Enrichment

**Script:** `reporting/cve_lookup.py`

Correlates findings with the NVD (National Vulnerability Database) for CVE data:

```bash
python /app/scripts/reporting/cve_lookup.py
```

**Features:**
- Queries NVD REST API v2.0 for CVE details
- Extracts CVSS scores (v3.1, v3.0, v2.0)
- Caches CVE lookups to `$SCAN_DIR/cve_cache/` for performance
- Auto-upgrades severity based on CVSS scores
- Adds vulnerability descriptions, references, and weakness classifications

**Output:** `$SCAN_DIR/enriched_findings.json`

#### Stage 3: Remediation Recommendations

**Script:** `reporting/remediation_engine.py`

Adds specific, actionable remediation guidance for each finding:

```bash
python /app/scripts/reporting/remediation_engine.py
```

**Built-in remediation categories:**
- SQL Injection (parameterized queries, ORM usage)
- JWT vulnerabilities (algorithm specification, secret strength)
- XSS (sanitization, CSP headers)
- IDOR (authorization checks, indirect references)
- Rate Limiting (SlowAPI implementation)
- CORS misconfiguration (origin whitelisting)
- Hardcoded Secrets (environment variables, secrets managers)

**Features:**
- Pattern matching against finding titles, categories, and descriptions
- Code examples for fixes (Python/TypeScript)
- OWASP cheat sheet references
- Generic fallback for unmatched findings

**Output:** `$SCAN_DIR/findings_with_remediations.json`

#### Stage 4: Report Generation

**Script:** `reporting/generate_report.py`

Generates professional reports in multiple formats:

```bash
python /app/scripts/reporting/generate_report.py
```

**Formats generated:**
- **HTML** (`reports/security_report.html`) - Interactive web report with styling
- **CSV** (`reports/findings.csv`) - Spreadsheet-compatible export
- **JSON** (`reports/findings.json`) - Machine-readable complete data
- **Markdown** (`reports/EXECUTIVE_SUMMARY.md`) - Management summary

### Output Files

The reporting pipeline produces the following files:

| File | Location | Description |
|------|----------|-------------|
| `aggregated_findings.json` | `$SCAN_DIR/` | Raw aggregated findings from all tools |
| `enriched_findings.json` | `$SCAN_DIR/` | Findings with CVE data |
| `findings_with_remediations.json` | `$SCAN_DIR/` | Findings with detailed fix recommendations |
| `security_report.html` | `$SCAN_DIR/reports/` | Full interactive HTML report |
| `findings.csv` | `$SCAN_DIR/reports/` | CSV export for spreadsheets |
| `findings.json` | `$SCAN_DIR/reports/` | Final JSON report |
| `EXECUTIVE_SUMMARY.md` | `$SCAN_DIR/reports/` | Management-level summary |

### Report Content

#### HTML Report Features

The HTML report includes:
- **Header** with assessment date and target information
- **Summary cards** showing findings by severity (Critical, High, Medium, Low)
- **Executive summary** with key observations
- **Table of contents** with anchor links
- **Detailed findings** including:
  - Finding ID and title
  - Severity badge
  - Category, component, and source tool
  - CWE reference (where applicable)
  - Description
  - Reproduction steps
  - Evidence
  - Remediation recommendations
  - References
- **Methodology section** listing tools used
- Print-friendly styling

#### Executive Summary Content

The Markdown executive summary provides:
- Assessment date and total findings count
- Severity breakdown table
- Risk assessment narrative
- Prioritized recommendations (immediate, short-term, long-term)
- Conclusion with next steps

### Usage Examples

#### Generate Complete Report Suite

```bash
# Inside the pentest container

# Option 1: Use the master script
/app/scripts/generate-report.sh

# Option 2: Run stages individually for more control
export SCAN_DIR=/app/results/$(ls -t /app/results/ | head -1)
python /app/scripts/reporting/aggregate_findings.py
python /app/scripts/reporting/cve_lookup.py
python /app/scripts/reporting/remediation_engine.py
python /app/scripts/reporting/generate_report.py
```

#### Generate Reports for a Specific Scan

```bash
# Set SCAN_DIR to a specific timestamped results folder
export SCAN_DIR=/app/results/20260101_143000
/app/scripts/generate-report.sh
```

#### Export Reports to Host Machine

```bash
# From host machine (outside container)
docker cp ocv-pentest:/app/results/ ./pentest-reports/

# Copy specific scan results
docker cp ocv-pentest:/app/results/20260101_143000/reports/ ./security-reports/
```

#### View HTML Report

```bash
# Inside container - copy to host first
exit

# From host - open in browser
xdg-open ./results/*/reports/security_report.html  # Linux
open ./results/*/reports/security_report.html      # macOS
```

#### Import CSV to Spreadsheet

The `findings.csv` can be imported directly into:
- Microsoft Excel
- Google Sheets
- LibreOffice Calc
- Any CSV-compatible tool

Columns: ID, Severity, Title, Category, Component, CWE, Description, Remediation, Source Tool

### Customizing Reports

#### Adding Custom Remediations

Edit `reporting/remediation_engine.py` to add new remediation categories:

```python
REMEDIATIONS = {
    "Your Category": {
        "description": "Description of the vulnerability class",
        "fix": """
Steps to fix with code examples...
""",
        "references": ["https://example.com/reference"]
    },
    # ... existing categories
}
```

#### Modifying HTML Template

The HTML template is embedded in `reporting/generate_report.py` using Jinja2 templating. Modify the `Template` string in the `generate_html()` method to customize:
- Branding and colors (CSS variables)
- Layout and structure
- Additional sections
- Company logo and footer

---

## Script Reference

### Reconnaissance Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `recon.sh` | Initial reconnaissance | `/app/scripts/recon.sh` |
| `quick-scan.sh` | Fast vulnerability scan | `/app/scripts/quick-scan.sh` |
| `full-scan.sh` | Comprehensive scan | `/app/scripts/full-scan.sh` |

### DAST Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `run-zap.sh` | OWASP ZAP scanning | `/app/scripts/run-zap.sh [baseline\|full\|api\|auth]` |
| `run-nuclei.sh` | Nuclei scanning | `/app/scripts/run-nuclei.sh [quick\|standard\|full\|custom]` |
| `api-fuzz.sh` | API endpoint fuzzing | `/app/scripts/api-fuzz.sh` |
| `sqlmap-test.sh` | SQL injection testing | `/app/scripts/sqlmap-test.sh` |

### SAST Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `run-bandit.sh` | Python security analysis | `/app/scripts/run-bandit.sh` |
| `run-semgrep.sh` | Multi-language SAST | `/app/scripts/run-semgrep.sh` |
| `run-eslint-security.sh` | TypeScript/React SAST | `/app/scripts/run-eslint-security.sh` |
| `sast-full.sh` | Complete SAST suite | `/app/scripts/sast-full.sh` |
| `analyze-python-patterns.py` | Custom pattern analysis | `python /app/scripts/analyze-python-patterns.py` |

### Security Testing Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `dep-audit.sh` | Dependency scanning | `/app/scripts/dep-audit.sh` |
| `secret-scan.sh` | Secret detection | `/app/scripts/secret-scan.sh` |
| `container-scan.sh` | Container security | `/app/scripts/container-scan.sh` |
| `jwt-test.py` | JWT security testing | `python /app/scripts/jwt-test.py` |
| `auth-test.py` | Authentication testing | `python /app/scripts/auth-test.py` |
| `idor-test.py` | IDOR testing | `python /app/scripts/idor-test.py` |
| `xss-test.py` | XSS testing | `python /app/scripts/xss-test.py` |

### Exploitation Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `exploit-chain.sh` | Full exploitation suite | `/app/scripts/exploit-chain.sh` |
| `crack-hashes.sh` | Password cracking | `/app/scripts/crack-hashes.sh` |
| `privesc-test.sh` | Privilege escalation | `/app/scripts/privesc-test.sh` |
| `setup-metasploit.sh` | Metasploit initialization | `/app/scripts/setup-metasploit.sh` |
| `collect-evidence.py` | Evidence collection | `python /app/scripts/collect-evidence.py` |

### Exploit Modules

| Script | Description | Usage |
|--------|-------------|-------|
| `exploits/jwt_alg_confusion.py` | JWT attack script | `python /app/exploits/jwt_alg_confusion.py --target URL` |
| `exploits/sqli_exploit.py` | SQL injection exploit | `python /app/exploits/sqli_exploit.py --target URL` |

### Reporting Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `generate-report.sh` | Master reporting script (runs all stages) | `/app/scripts/generate-report.sh` |
| `reporting/aggregate_findings.py` | Aggregate findings from all tools | `python /app/scripts/reporting/aggregate_findings.py` |
| `reporting/cve_lookup.py` | CVE database integration (NVD API) | `python /app/scripts/reporting/cve_lookup.py` |
| `reporting/generate_report.py` | Generate HTML, CSV, JSON, MD reports | `python /app/scripts/reporting/generate_report.py` |
| `reporting/remediation_engine.py` | Add remediation recommendations | `python /app/scripts/reporting/remediation_engine.py` |

### Utility Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `start-proxy.sh` | Launch mitmproxy | `/app/scripts/start-proxy.sh` |
| `helpers/colors.sh` | Terminal colors | Source in scripts |

---

## Results Location

All scan results are stored in timestamped directories:

```
/app/results/
+-- YYYYMMDD_HHMMSS/
    |-- scans/                          # Raw scanner outputs
    |-- exploits/                       # Exploitation results
    |-- evidence/                       # Collected evidence
    |-- reports/                        # Generated reports (Phase 6)
    |   |-- security_report.html        #   Interactive HTML report
    |   |-- findings.csv                #   CSV export for spreadsheets
    |   |-- findings.json               #   Machine-readable JSON
    |   +-- EXECUTIVE_SUMMARY.md        #   Management summary
    |-- recon/                          # Reconnaissance data
    |-- nuclei/                         # Nuclei scan results
    |-- zap/                            # ZAP scan results
    |-- sast/                           # Static analysis results
    |-- dependencies/                   # Dependency audit results
    |-- secrets/                        # Secret detection results
    |-- container/                      # Container security results
    |-- fuzzing/                        # API fuzzing results
    |-- cracking/                       # Password cracking results
    |-- privesc/                        # Privilege escalation results
    |-- cve_cache/                      # Cached CVE lookups (Phase 6)
    |-- aggregated_findings.json        # Aggregated findings (Phase 6)
    |-- enriched_findings.json          # CVE-enriched findings (Phase 6)
    |-- findings_with_remediations.json # Findings with fixes (Phase 6)
    +-- SUMMARY.md                      # Scan summary
```

### Accessing Results

```bash
# Inside container
ls -la /app/results/

# From host
ls -la ./results/

# Copy specific scan
docker cp ocv-pentest:/app/results/20260101_120000/ ./my-scan/
```

---

## Configuration

### Multi-Instance Architecture

OpenCitiVibes supports multiple deployment instances. The pentest suite can target any of them:

| Instance | Description | Docker Prefix | Admin Email |
|----------|-------------|---------------|-------------|
| `socenv` | Social Environment (dev/demo) | `ocv-socenv-*` | `admin@socenv.ca` |
| `montreal` | Idées pour Montréal | `ocv-montreal-*` | `admin@idees-montreal.ca` |
| `quebec` | Idées pour Québec | `ocv-quebec-*` | `admin@idees-quebec.ca` |
| `calgary` | Ideas for Calgary | `ocv-calgary-*` | `admin@ideas-calgary.ca` |

**Dynamic Instance Detection:** Phase 2 scripts automatically detect the running instance by checking which containers are active. No manual configuration is required in most cases.

### Environment Variables

Copy the example and customize for your target instance:

```bash
cp config/.env.example config/.env
```

**Key variables (adjust for your instance):**

```bash
# ============================================================================
# INSTANCE SELECTION - Choose ONE of the following configurations
# ============================================================================

# --- For SOCENV (Social Environment / Demo) ---
TARGET_BACKEND=http://ocv-socenv-backend-dev:8000
TARGET_FRONTEND=http://ocv-socenv-frontend-dev:3000
TARGET_API=http://ocv-socenv-backend-dev:8000/api
ADMIN_EMAIL=admin@socenv.ca
ADMIN_PASSWORD=Admin2024!Socenv

# --- For MONTREAL ---
# TARGET_BACKEND=http://ocv-montreal-backend-dev:8000
# TARGET_FRONTEND=http://ocv-montreal-frontend-dev:3000
# TARGET_API=http://ocv-montreal-backend-dev:8000/api
# ADMIN_EMAIL=admin@idees-montreal.ca
# ADMIN_PASSWORD=Admin2024!Mtl

# --- For QUEBEC ---
# TARGET_BACKEND=http://ocv-quebec-backend-dev:8000
# TARGET_FRONTEND=http://ocv-quebec-frontend-dev:3000
# TARGET_API=http://ocv-quebec-backend-dev:8000/api
# ADMIN_EMAIL=admin@idees-quebec.ca
# ADMIN_PASSWORD=Admin2024!Qc

# --- For CALGARY ---
# TARGET_BACKEND=http://ocv-calgary-backend-dev:8000
# TARGET_FRONTEND=http://ocv-calgary-frontend-dev:3000
# TARGET_API=http://ocv-calgary-backend-dev:8000/api
# ADMIN_EMAIL=admin@ideas-calgary.ca
# ADMIN_PASSWORD=Admin2024!Cgy

# ============================================================================
# Rate limiting (to avoid DoS)
# ============================================================================
REQUEST_DELAY_MS=100
MAX_CONCURRENT_REQUESTS=10
```

### Starting Different Instances

Each instance has its own Docker Compose file:

```bash
# Start SOCENV instance
docker-compose -f Docker/docker-compose.socenv.dev.yml up -d

# Start MONTREAL instance
docker-compose -f Docker/docker-compose.montreal.dev.yml up -d

# Start QUEBEC instance
docker-compose -f Docker/docker-compose.quebec.dev.yml up -d

# Start CALGARY instance
docker-compose -f Docker/docker-compose.calgary.dev.yml up -d
```

### Instance Configuration Files

Each instance has a platform configuration at:

```
instances/<instance>/platform.config.json
```

This file defines:
- Instance ID and display name
- Database filename
- Contact emails
- Branding (colors, logos)
- Enabled features
- Localization settings

### Tool Configurations

| File | Tool | Purpose |
|------|------|---------|
| `config/bandit.yaml` | Bandit | Python SAST settings |
| `config/semgrep-config.yaml` | Semgrep | Rule configuration |
| `config/eslint-security.config.js` | ESLint | JS/TS security rules |
| `config/zap-config.yaml` | OWASP ZAP | Scan configuration |
| `config/zap-api-policy.policy` | OWASP ZAP | API scan policy |
| `config/mitmproxy/config.yaml` | mitmproxy | Proxy settings |

### Custom Nuclei Templates

Add project-specific templates to:

```
nuclei-templates/opencitivibes/
```

### Custom Semgrep Rules

Add custom rules to:

```
semgrep-rules/
```

### Custom Wordlists

Add project-specific wordlists to:

```
wordlists/project-specific/
```

---

## Ethical Considerations

### Before Testing

1. **Authorization:** Obtain explicit written permission
2. **Scope:** Define exactly what systems can be tested
3. **Timing:** Agree on testing windows
4. **Contacts:** Have emergency contacts ready
5. **Data:** Understand data handling requirements

### During Testing

1. **Do not** exfiltrate real sensitive data
2. **Do not** cause denial of service
3. **Do not** test outside the agreed scope
4. **Do** document all activities
5. **Do** report critical issues immediately

### After Testing

1. **Report** all findings responsibly
2. **Verify** findings are accurate
3. **Provide** actionable remediation
4. **Clean up** any test data or accounts
5. **Delete** sensitive data when authorized

### Responsible Disclosure

- Report critical vulnerabilities immediately
- Allow reasonable time for remediation
- Do not disclose publicly without authorization
- Follow the organization's disclosure policy

---

## Troubleshooting

### Container Build Fails

**Python build issues:**
```bash
# Check build dependencies are available
apt-get update && apt-get install -y build-essential libffi-dev libssl-dev
```

**Go tools fail to install:**
```bash
# Some Go tools need to be installed via pre-built binaries
# Check Dockerfile for alternative installation methods
```

### Network Connectivity Issues

**Cannot reach backend:**
```bash
# Verify target containers are running (replace INSTANCE with your target)
docker ps | grep ocv-INSTANCE
# Examples:
docker ps | grep ocv-socenv      # For socenv instance
docker ps | grep ocv-montreal    # For montreal instance
docker ps | grep ocv-quebec      # For quebec instance
docker ps | grep ocv-calgary     # For calgary instance

# Check network exists
docker network ls | grep idees-mtl-dev-network

# Inspect network
docker network inspect idees-mtl-dev-network
```

**Ping fails:**
```bash
# Try curl instead (replace with your instance's backend URL)
curl http://ocv-socenv-backend-dev:8000/api/health      # socenv
curl http://ocv-montreal-backend-dev:8000/api/health    # montreal
curl http://ocv-quebec-backend-dev:8000/api/health      # quebec
curl http://ocv-calgary-backend-dev:8000/api/health     # calgary
```

**Wrong instance detected:**
```bash
# If auto-detection picks the wrong instance, set explicitly:
export TARGET_INSTANCE=montreal
export TARGET_BACKEND=http://ocv-montreal-backend-dev:8000
```

### Permission Issues

**Cannot write to results:**
```bash
# Inside container
chmod -R 755 /app/results
```

**Cannot execute scripts:**
```bash
chmod +x /app/scripts/*.sh /app/scripts/*.py
```

### Tool-Specific Issues

**Nuclei templates not found:**
```bash
# Update templates
nuclei -update-templates
```

**ZAP fails to start:**
```bash
# Check Java version
java -version

# Verify ZAP installation
/opt/ZAP_*/zap.sh -version
```

**SQLMap hangs:**
```bash
# Use shorter timeouts
sqlmap --timeout=10 --retries=1
```

### Memory Issues

**Container runs out of memory:**
```bash
# Increase memory limit in docker-compose.pentest.yml
deploy:
  resources:
    limits:
      memory: 16G
```

---

## Complete Assessment Workflow

```bash
# 1. Start target environment
cd /home/matt/projects/IdeesPourMontreal
docker-compose -f Docker/docker-compose.socenv.dev.yml up -d

# 2. Build and start pentest container
cd pentest/
docker-compose -f docker-compose.pentest.yml up -d

# 3. Access container
docker exec -it ocv-pentest bash

# 4. Run reconnaissance
/app/scripts/recon.sh

# 5. Run full automated scan
/app/scripts/full-scan.sh

# 6. Run SAST analysis
/app/scripts/sast-full.sh

# 7. Run web application tests
python /app/scripts/jwt-test.py
python /app/scripts/auth-test.py
python /app/scripts/idor-test.py
python /app/scripts/xss-test.py

# 8. Run API fuzzing
/app/scripts/api-fuzz.sh

# 9. Run exploitation tests (if authorized)
/app/scripts/exploit-chain.sh

# 10. Generate reports (Phase 6)
# Uses master script to run all reporting stages
/app/scripts/generate-report.sh

# Or run individual stages manually:
# export SCAN_DIR=/app/results/$(ls -t /app/results/ | head -1)
# python /app/scripts/reporting/aggregate_findings.py
# python /app/scripts/reporting/cve_lookup.py
# python /app/scripts/reporting/remediation_engine.py
# python /app/scripts/reporting/generate_report.py

# 11. Export reports to host
exit
docker cp ocv-pentest:/app/results/ ./pentest-results/
```

---

## Support

For issues with this penetration testing suite:

1. Check the troubleshooting section above
2. Review the phase-specific documentation in `claude-docs/plans/pentest-*.md`
3. Examine tool-specific logs in the results directory

---

**Version:** 1.0.0
**Last Updated:** 2026-01-01
**Maintained by:** Security Team
