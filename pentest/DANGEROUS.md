# Dangerous Operations Approval Workflow

This document outlines the approval workflow for security testing operations that could potentially cause harm if misused. These safeguards ensure that aggressive testing is intentional and authorized.

---

## Classification of Operations

### Level 1: Safe (No Approval Required)
Operations that are read-only or have no side effects:

- Static code analysis (Semgrep, Bandit)
- Dependency scanning (pip-audit, pnpm audit)
- Container image scanning (Trivy, Grype)
- Secret detection in source (Gitleaks, Trufflehog)
- Passive reconnaissance
- JWT token analysis in `--no-exec` mode

### Level 2: Standard (Implicit Approval)
Operations that interact with the target but are non-destructive:

- Active scanning (Nmap, Nuclei)
- API fuzzing with safe defaults (Schemathesis)
- Authenticated API testing
- ZAP baseline scans
- Header/configuration checks

These operations run automatically in CI and scheduled scans.

### Level 3: Aggressive (Explicit Approval Required)
Operations that could affect application state or availability:

| Operation | Risk | Required Approval |
|-----------|------|-------------------|
| SQL Injection testing (sqlmap) | Database modification | `APPROVE_SQLI=1` |
| Brute force attacks (Hydra) | Account lockout | `APPROVE_BRUTE=1` |
| Full ZAP active scan | Heavy traffic, data modification | `APPROVE_ZAP_ACTIVE=1` |
| Schemathesis in aggressive mode | State changes, crashes | `APPROVE_SCHEMA_AGGRESSIVE=1` |
| Container escape attempts | Host access | `APPROVE_CONTAINER_ESCAPE=1` |

### Level 4: Destructive (Written Authorization Only)
Operations that could cause data loss or system compromise:

| Operation | Risk | Required Authorization |
|-----------|------|------------------------|
| Password cracking (John, Hashcat) | Legal implications | Written pentest agreement |
| Exploitation (Metasploit) | System compromise | Written pentest agreement |
| Denial of service testing | Service outage | Written pentest agreement + stakeholder notification |
| Data exfiltration tests | Data breach simulation | Written pentest agreement + data handling plan |

---

## Approval Mechanisms

### Environment Variable Flags

For Level 3 operations, set the appropriate flag:

```bash
# Allow SQL injection testing
APPROVE_SQLI=1 /app/scripts/sqlmap-test.sh

# Allow brute force testing
APPROVE_BRUTE=1 /app/scripts/crack-hashes.sh

# Allow aggressive API fuzzing
APPROVE_SCHEMA_AGGRESSIVE=1 /app/scripts/run-schemathesis.sh aggressive

# Allow container escape checks
APPROVE_CONTAINER_ESCAPE=1 /app/scripts/container-escape-checks.sh
```

### Interactive Confirmation

Scripts requiring approval will prompt for confirmation:

```bash
[!] WARNING: This operation may modify database state.
[!] Target: http://backend:8000/api
[!] Operation: SQL Injection Testing (sqlmap)
[!]
[?] Type 'APPROVED' to continue, or Ctrl+C to cancel:
```

### Approval File

For batch operations, create an approval file:

```bash
# Create approval file
cat > /app/config/approvals.json << EOF
{
  "approved_by": "security-team@example.com",
  "approved_at": "$(date -Iseconds)",
  "operations": [
    "sqli",
    "brute",
    "zap-active"
  ],
  "target": "http://backend:8000",
  "expires": "$(date -d '+24 hours' -Iseconds)"
}
EOF
```

---

## Pre-Operation Checklist

Before running Level 3 or Level 4 operations:

- [ ] Confirm you have authorization to test the target
- [ ] Verify the target is a test/staging environment (not production)
- [ ] Ensure backup exists if testing against data
- [ ] Notify relevant stakeholders
- [ ] Set appropriate rate limits
- [ ] Have rollback plan ready
- [ ] Document test scope and boundaries

---

## Script Implementation Guidelines

Scripts should implement the following pattern:

```bash
#!/bin/bash

# Check for approval flag
if [ "${APPROVE_OPERATION}" != "1" ]; then
    echo "[!] This operation requires explicit approval."
    echo "[!] Set APPROVE_OPERATION=1 to continue."
    echo ""
    echo "[?] Type 'APPROVED' to continue, or Ctrl+C to cancel:"
    read -r confirmation
    if [ "$confirmation" != "APPROVED" ]; then
        echo "[-] Operation cancelled."
        exit 1
    fi
fi

# Log the approval
echo "[*] Operation approved at $(date)"
echo "[*] User: $(whoami)"
echo "[*] Target: ${TARGET}"

# Continue with operation...
```

Python equivalent:

```python
import os
import sys

def require_approval(operation_name: str, env_var: str):
    """Require explicit approval for dangerous operations."""
    if os.environ.get(env_var) == "1":
        return True

    print(f"[!] This operation requires explicit approval: {operation_name}")
    print(f"[!] Set {env_var}=1 to bypass this prompt.")
    print()
    confirmation = input("[?] Type 'APPROVED' to continue: ")

    if confirmation.strip() != "APPROVED":
        print("[-] Operation cancelled.")
        sys.exit(1)

    return True
```

---

## Audit Logging

All Level 3+ operations are logged:

```json
{
  "timestamp": "2024-01-15T14:30:00Z",
  "operation": "sqli-test",
  "target": "http://backend:8000/api/ideas",
  "approved_by": "operator",
  "approval_method": "env_var",
  "scan_id": "20240115_143000",
  "findings": 0,
  "duration_seconds": 120
}
```

Log location: `/app/results/{scan_id}/audit.log`

---

## CI/CD Integration

### GitHub Actions

For automated testing, approvals are managed via secrets:

```yaml
jobs:
  aggressive-scan:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'aggressive'
    runs-on: self-hosted
    environment: pentest-aggressive  # Requires approval
    steps:
      - name: Run aggressive scan
        env:
          APPROVE_SQLI: ${{ secrets.APPROVE_SQLI }}
          APPROVE_ZAP_ACTIVE: ${{ secrets.APPROVE_ZAP_ACTIVE }}
        run: |
          docker exec ocv-pentest /app/scripts/full-scan.sh aggressive
```

### Protected Environments

Configure GitHub environments with:
- Required reviewers
- Wait timer (optional)
- Deployment branch restrictions
- Secret scope limitations

---

## Incident Response

If an aggressive test causes unintended impact:

1. **Stop the operation immediately**
   ```bash
   docker stop ocv-pentest
   ```

2. **Document what happened**
   - Timestamp
   - Operation that caused impact
   - Observed symptoms
   - Affected systems

3. **Notify stakeholders**
   - Development team
   - Operations team
   - Security team lead

4. **Preserve evidence**
   - Copy scan results
   - Save application logs
   - Screenshot any errors

5. **Remediate**
   - Restore from backup if needed
   - Restart affected services
   - Clear any test data created

---

## Version History

| Date | Version | Changes |
|------|---------|---------|
| 2024-01-15 | 1.0 | Initial version |

---

*This document is part of the OpenCitiVibes Penetration Testing Framework*
