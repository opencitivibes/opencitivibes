#!/usr/bin/env python3
"""
IDOR (Insecure Direct Object Reference) Testing for OpenCitiVibes

Tests access control on:
- Ideas (view, edit, delete)
- Comments (view, edit, delete)
- User profiles
- Votes
- Admin endpoints

Uses dynamic credential discovery - no hardcoded credentials.
"""

import requests
import json
import os
import sys
from pathlib import Path
from datetime import datetime

# Add helpers to path
sys.path.insert(0, str(Path(__file__).parent / "helpers"))
from auth_discovery import (
    get_authenticated_session,
    create_second_test_user,
    TARGET_API
)

SCAN_DIR = os.environ.get("SCAN_DIR", "/app/results/idor")


class IDORTester:
    def __init__(self):
        self.results = []
        self.admin_token = None
        self.user_token = None
        self.admin_info = {}
        self.user_info = {}
        Path(SCAN_DIR).mkdir(parents=True, exist_ok=True)

    def log(self, level: str, message: str):
        timestamp = datetime.now().isoformat()
        print(f"[{timestamp}] [{level}] {message}")
        self.results.append({"timestamp": timestamp, "level": level, "message": message})

    def setup_tokens(self):
        """Get tokens for admin and regular user using dynamic discovery."""
        # Get primary authenticated session (tries env vars first, then creates user)
        session, token, user_info = get_authenticated_session(require_admin=True)

        if token:
            if user_info.get("is_admin"):
                self.admin_token = token
                self.admin_info = user_info
                self.log("INFO", f"Admin token obtained: {user_info.get('email')}")
            else:
                # Got a regular user, use as user token
                self.user_token = token
                self.user_info = user_info
                self.log("INFO", f"User token obtained: {user_info.get('email')}")
        else:
            self.log("WARNING", "Could not get primary token")

        # Create a second test user for IDOR testing (testing cross-user access)
        if not self.user_token:
            self.log("INFO", "Creating second test user for IDOR comparison...")
            email, password, second_token = create_second_test_user(session)
            if second_token:
                self.user_token = second_token
                self.user_info = {"email": email, "is_admin": False}
                self.log("INFO", f"Second test user token obtained: {email}")
            else:
                self.log("WARNING", "Could not create second test user")

    def test_idea_idor(self):
        """Test IDOR on ideas."""
        self.log("INFO", "Testing IDOR on ideas...")

        # First, get an idea created by admin
        response = requests.get(
            f"{TARGET_API}/ideas/leaderboard?limit=5",
            headers={"Authorization": f"Bearer {self.admin_token}"}
        )

        if response.status_code != 200 or not response.json():
            self.log("WARNING", "No ideas found to test")
            return

        idea = response.json()[0]
        idea_id = idea.get("id")
        self.log("INFO", f"Testing with idea ID: {idea_id}")

        # Try to edit as different user
        if self.user_token:
            response = requests.put(
                f"{TARGET_API}/ideas/{idea_id}",
                headers={
                    "Authorization": f"Bearer {self.user_token}",
                    "Content-Type": "application/json"
                },
                json={"title": "IDOR Test - Unauthorized Edit"}
            )

            if response.status_code == 200:
                self.log("CRITICAL", f"IDOR: Able to edit idea {idea_id} as different user!")
            elif response.status_code == 403:
                self.log("INFO", f"Idea {idea_id} protected from unauthorized edit (good)")
            else:
                self.log("INFO", f"Edit returned status {response.status_code}")

            # Try to delete as different user
            response = requests.delete(
                f"{TARGET_API}/ideas/{idea_id}",
                headers={"Authorization": f"Bearer {self.user_token}"}
            )

            if response.status_code == 200:
                self.log("CRITICAL", f"IDOR: Able to delete idea {idea_id} as different user!")
            elif response.status_code == 403:
                self.log("INFO", f"Idea {idea_id} protected from unauthorized delete (good)")

    def test_user_profile_idor(self):
        """Test IDOR on user profiles."""
        self.log("INFO", "Testing IDOR on user profiles...")

        # Try to access admin user data
        for user_id in range(1, 10):
            response = requests.get(
                f"{TARGET_API}/admin/users/{user_id}",
                headers={"Authorization": f"Bearer {self.user_token}"} if self.user_token else {}
            )

            if response.status_code == 200:
                user_data = response.json()
                if "email" in user_data or "hashed_password" in user_data:
                    self.log("CRITICAL", f"IDOR: Can access user {user_id} sensitive data!")
            elif response.status_code == 401:
                self.log("INFO", "User profile requires authentication (good)")
                break
            elif response.status_code == 403:
                self.log("INFO", "User profile access denied for non-admin (good)")
                break

    def test_vote_idor(self):
        """Test IDOR on votes."""
        self.log("INFO", "Testing IDOR on votes...")

        # Try to manipulate votes on ideas
        for idea_id in range(1, 5):
            # Try to vote multiple times
            for i in range(3):
                response = requests.post(
                    f"{TARGET_API}/votes/{idea_id}",
                    headers={
                        "Authorization": f"Bearer {self.user_token or self.admin_token}",
                        "Content-Type": "application/json"
                    },
                    json={"vote_type": "upvote"}
                )

                if response.status_code == 200:
                    self.log("WARNING", f"Multiple votes on idea {idea_id} attempt {i+1}")

    def test_admin_endpoints(self):
        """Test access control on admin endpoints."""
        self.log("INFO", "Testing admin endpoint access control...")

        admin_endpoints = [
            "/admin/ideas/pending",
            "/admin/users",
            "/admin/categories",
            "/admin/analytics/overview",
            "/admin/moderation/queue",
            "/admin/moderation/penalties",
            "/admin/officials",
        ]

        for endpoint in admin_endpoints:
            # Test without auth
            response = requests.get(f"{TARGET_API}{endpoint}")
            if response.status_code == 200:
                self.log("CRITICAL", f"Admin endpoint accessible without auth: {endpoint}")

            # Test with regular user auth
            if self.user_token:
                response = requests.get(
                    f"{TARGET_API}{endpoint}",
                    headers={"Authorization": f"Bearer {self.user_token}"}
                )
                if response.status_code == 200:
                    self.log("CRITICAL", f"Admin endpoint accessible by regular user: {endpoint}")
                elif response.status_code == 403:
                    self.log("INFO", f"Admin endpoint protected: {endpoint} (good)")

    def run_all_tests(self):
        """Run all IDOR tests."""
        self.log("INFO", "=" * 50)
        self.log("INFO", "IDOR Security Testing Suite")
        self.log("INFO", "=" * 50)

        self.setup_tokens()
        self.test_idea_idor()
        self.test_user_profile_idor()
        self.test_vote_idor()
        self.test_admin_endpoints()

        # Save results
        results_file = Path(SCAN_DIR) / "idor-test-results.json"
        with open(results_file, "w") as f:
            json.dump(self.results, f, indent=2)

        self.log("INFO", f"Results saved to: {results_file}")


if __name__ == "__main__":
    tester = IDORTester()
    tester.run_all_tests()
