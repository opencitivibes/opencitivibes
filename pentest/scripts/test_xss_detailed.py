#!/usr/bin/env python3
"""Detailed XSS test to understand idea creation responses."""

import requests

BASE = "http://127.0.0.1:8000/api"

# Login first
login = requests.post(
    f"{BASE}/auth/login",
    data={"username": "pentest_retest@test.com", "password": "Pentest123!@#"}
)
token = login.json().get("access_token")
print(f"Token obtained: {token[:50]}...")

# Test XSS payloads
payloads = [
    '<script>alert(1)</script>',
    '<img src=x onerror=alert(1)>',
    'Normal title without XSS',
]

for payload in payloads:
    print(f"\n--- Testing: {payload[:40]}... ---")
    resp = requests.post(
        f"{BASE}/ideas/",
        headers={
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        },
        json={
            "title": f"XSS Test {payload}",
            "description": f"Description with {payload}",
            "category_id": 1,
            "tags": []
        }
    )
    print(f"Status: {resp.status_code}")
    print(f"Response: {resp.text[:300]}")

    if resp.status_code == 200:
        idea = resp.json()
        stored_title = idea.get("title", "")
        stored_desc = idea.get("description", "")

        # Check if XSS was sanitized
        if "<script>" in stored_title or "<script>" in stored_desc:
            print("WARNING: XSS payload stored unsanitized!")
        elif "<" in stored_title and ">" in stored_title:
            print("WARNING: HTML tags may be present")
        else:
            print("OK: Content appears sanitized or plain text")

        # Cleanup
        del_resp = requests.delete(
            f"{BASE}/ideas/{idea['id']}",
            headers={"Authorization": f"Bearer {token}"}
        )
        print(f"Cleanup: {del_resp.status_code}")
