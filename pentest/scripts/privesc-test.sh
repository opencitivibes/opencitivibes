#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/privesc"

log_info "Privilege Escalation Testing"

# ============================================================================
# Container Environment Analysis
# ============================================================================

log_info "Analyzing container environment..."

{
    echo "# Container Environment Analysis"
    echo "Date: $(date)"
    echo ""

    echo "## User Information"
    id
    whoami
    echo ""

    echo "## Environment Variables"
    env | grep -i "secret\|key\|password\|token" | sed 's/=.*/=***REDACTED***/'
    echo ""

    echo "## Mounted Volumes"
    mount | grep -E "^/dev|docker"
    echo ""

    echo "## Network Configuration"
    ip addr 2>/dev/null || ifconfig
    echo ""

    echo "## Running Processes"
    ps aux
    echo ""

    echo "## Capabilities"
    capsh --print 2>/dev/null || cat /proc/self/status | grep Cap
    echo ""

    echo "## SUID/SGID Binaries"
    find / -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null
    echo ""

    echo "## Docker Socket"
    if [ -S /var/run/docker.sock ]; then
        echo "WARNING: Docker socket is mounted!"
        ls -la /var/run/docker.sock
    else
        echo "Docker socket not mounted (good)"
    fi
    echo ""

    echo "## Sensitive Files"
    for file in /etc/passwd /etc/shadow /root/.ssh /home/*/.ssh; do
        if [ -r "$file" ]; then
            echo "Readable: $file"
        fi
    done

} > "${SCAN_DIR}/privesc/container-analysis.md"

cat "${SCAN_DIR}/privesc/container-analysis.md"

# ============================================================================
# LinPEAS Scan
# ============================================================================

log_info "Running LinPEAS..."

if [ -f /app/scripts/linpeas.sh ]; then
    /app/scripts/linpeas.sh -a 2>&1 | tee "${SCAN_DIR}/privesc/linpeas.txt"
else
    log_warning "LinPEAS not found, downloading..."
    curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh \
        -o /tmp/linpeas.sh
    chmod +x /tmp/linpeas.sh
    /tmp/linpeas.sh -a 2>&1 | tee "${SCAN_DIR}/privesc/linpeas.txt"
fi

# ============================================================================
# Container Escape Checks
# ============================================================================

log_info "Checking for container escape vectors..."

{
    echo "# Container Escape Analysis"
    echo ""

    echo "## Docker Socket Access"
    if [ -S /var/run/docker.sock ]; then
        echo "CRITICAL: Docker socket mounted - escape possible via:"
        echo '  docker run -v /:/mnt --rm -it alpine chroot /mnt sh'
    else
        echo "Docker socket not accessible (good)"
    fi
    echo ""

    echo "## Privileged Mode"
    if [ -w /dev/sda ] || capsh --print 2>/dev/null | grep -q "cap_sys_admin"; then
        echo "CRITICAL: Container may be privileged"
    else
        echo "Container does not appear privileged (good)"
    fi
    echo ""

    echo "## Sensitive Host Paths"
    for path in /etc/shadow /etc/passwd /root; do
        if [ -r "/host${path}" ] 2>/dev/null; then
            echo "WARNING: Can read /host${path}"
        fi
    done
    echo ""

    echo "## cgroups Escape"
    if [ -d /sys/fs/cgroup ]; then
        echo "cgroups accessible:"
        ls /sys/fs/cgroup/
    fi

} > "${SCAN_DIR}/privesc/container-escape.md"

cat "${SCAN_DIR}/privesc/container-escape.md"

log_success "Privilege escalation testing complete!"
log_info "Results in ${SCAN_DIR}/privesc/"
