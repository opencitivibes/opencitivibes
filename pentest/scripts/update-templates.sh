#!/bin/bash
# Nuclei Template Maintenance Script
# Updates and validates Nuclei templates
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh

TEMPLATES_DIR="${TEMPLATES_DIR:-/app/nuclei-templates}"
CUSTOM_TEMPLATES="${TEMPLATES_DIR}/opencitivibes"

log_info "Nuclei Template Maintenance"
log_info "==========================="
echo ""

# Step 1: Update official templates
log_info "[1/4] Updating official Nuclei templates..."
nuclei -update-templates 2>&1 | tee /tmp/nuclei-update.log

if grep -q "Templates updated\|Successfully" /tmp/nuclei-update.log; then
    log_success "Official templates updated successfully"
else
    log_warning "No template updates available or update failed"
fi

# Step 2: Validate custom templates
log_info ""
log_info "[2/4] Validating custom OpenCitiVibes templates..."

if [ -d "${CUSTOM_TEMPLATES}" ]; then
    VALIDATION_ERRORS=0
    VALID_COUNT=0

    for template in "${CUSTOM_TEMPLATES}"/*.yaml; do
        if [ -f "${template}" ]; then
            TEMPLATE_NAME=$(basename "${template}")
            if nuclei -validate -t "${template}" 2>&1 | grep -q "Error"; then
                log_error "Invalid template: ${TEMPLATE_NAME}"
                VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
            else
                echo "  [+] Valid: ${TEMPLATE_NAME}"
                VALID_COUNT=$((VALID_COUNT + 1))
            fi
        fi
    done

    if [ $VALIDATION_ERRORS -eq 0 ]; then
        log_success "All ${VALID_COUNT} custom templates are valid"
    else
        log_error "${VALIDATION_ERRORS} template(s) have validation errors"
    fi
else
    log_warning "Custom templates directory not found: ${CUSTOM_TEMPLATES}"
    log_info "Creating directory..."
    mkdir -p "${CUSTOM_TEMPLATES}"
fi

# Step 3: List template statistics
log_info ""
log_info "[3/4] Template statistics..."

echo ""
echo "Official templates:"
if command -v nuclei &> /dev/null; then
    # Count templates by severity
    TOTAL=$(find ~/.local/nuclei-templates -name "*.yaml" 2>/dev/null | wc -l || echo "?")
    echo "  Total templates: ${TOTAL}"
fi

echo ""
echo "Custom templates:"
if [ -d "${CUSTOM_TEMPLATES}" ]; then
    CUSTOM_COUNT=$(ls -1 "${CUSTOM_TEMPLATES}"/*.yaml 2>/dev/null | wc -l || echo 0)
    echo "  Total: ${CUSTOM_COUNT}"
    if [ "${CUSTOM_COUNT}" -gt 0 ]; then
        echo "  Templates:"
        ls -1 "${CUSTOM_TEMPLATES}"/*.yaml 2>/dev/null | while read f; do
            echo "    - $(basename $f)"
        done
    fi
else
    echo "  None found"
fi

# Step 4: Test templates against a dry target
log_info ""
log_info "[4/4] Dry-run validation against target..."

if [ -n "${TARGET_API}" ]; then
    log_info "Testing templates against ${TARGET_API} (dry-run)..."

    if [ -d "${CUSTOM_TEMPLATES}" ] && [ "$(ls -A ${CUSTOM_TEMPLATES}/*.yaml 2>/dev/null)" ]; then
        nuclei -u "${TARGET_API}" \
            -t "${CUSTOM_TEMPLATES}" \
            -validate \
            -silent \
            -dry-run 2>&1 | head -20

        log_success "Template dry-run complete"
    else
        log_info "No custom templates to test"
    fi
else
    log_warning "TARGET_API not set, skipping dry-run"
fi

# Generate summary
log_info ""
log_success "Template maintenance complete!"

{
    echo "# Nuclei Template Maintenance Report"
    echo ""
    echo "**Date:** $(date)"
    echo ""
    echo "## Update Status"
    echo ""
    cat /tmp/nuclei-update.log 2>/dev/null | tail -10
    echo ""
    echo "## Custom Templates"
    echo ""
    echo "- Valid: ${VALID_COUNT:-0}"
    echo "- Invalid: ${VALIDATION_ERRORS:-0}"
    echo ""
} > /tmp/template-maintenance-report.md

log_info "Report saved to: /tmp/template-maintenance-report.md"
