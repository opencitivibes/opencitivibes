#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/sast"

SOURCE_DIR="${SOURCE_DIR:-/app/source}"

log_info "Starting Bandit security analysis..."

# Run Bandit on backend
log_info "Scanning Python backend..."

bandit -r "${SOURCE_DIR}/backend" \
    -c /app/config/bandit.yaml \
    -f json \
    -o "${SCAN_DIR}/sast/bandit-report.json" \
    --exclude "${SOURCE_DIR}/backend/.venv,${SOURCE_DIR}/backend/tests,${SOURCE_DIR}/backend/migrations" \
    2>&1 | tee "${SCAN_DIR}/sast/bandit.log"

# Also generate HTML report
bandit -r "${SOURCE_DIR}/backend" \
    -c /app/config/bandit.yaml \
    -f html \
    -o "${SCAN_DIR}/sast/bandit-report.html" \
    --exclude "${SOURCE_DIR}/backend/.venv,${SOURCE_DIR}/backend/tests,${SOURCE_DIR}/backend/migrations" \
    2>/dev/null

# Generate text summary
bandit -r "${SOURCE_DIR}/backend" \
    -c /app/config/bandit.yaml \
    -f txt \
    -o "${SCAN_DIR}/sast/bandit-summary.txt" \
    --exclude "${SOURCE_DIR}/backend/.venv,${SOURCE_DIR}/backend/tests,${SOURCE_DIR}/backend/migrations" \
    2>/dev/null

# Parse results
if [ -f "${SCAN_DIR}/sast/bandit-report.json" ]; then
    HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' "${SCAN_DIR}/sast/bandit-report.json" 2>/dev/null || echo 0)
    MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' "${SCAN_DIR}/sast/bandit-report.json" 2>/dev/null || echo 0)
    LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' "${SCAN_DIR}/sast/bandit-report.json" 2>/dev/null || echo 0)

    log_success "Bandit scan complete!"
    echo ""
    log_info "Summary:"
    echo "  High severity: ${HIGH}"
    echo "  Medium severity: ${MEDIUM}"
    echo "  Low severity: ${LOW}"

    if [ "${HIGH}" -gt 0 ]; then
        log_warning "High severity issues found! Review immediately."
        echo ""
        log_info "High severity findings:"
        jq -r '.results[] | select(.issue_severity == "HIGH") | "\(.filename):\(.line_number) - \(.issue_text)"' \
            "${SCAN_DIR}/sast/bandit-report.json"
    fi
fi

log_info "Results in ${SCAN_DIR}/sast/"
