#!/usr/bin/env python3
"""
Post-Exploitation Evidence Collection for OpenCitiVibes

Collects and documents:
- Sensitive data accessed
- User credentials
- Configuration files
- Database contents
- Session information
"""

import json
import os
import sqlite3
import hashlib
from datetime import datetime
from pathlib import Path

SCAN_DIR = os.environ.get("SCAN_DIR", "/app/results/evidence")
SOURCE_DIR = os.environ.get("SOURCE_DIR", "/app/source")
DATA_DIR = "/app/data"


class EvidenceCollector:
    def __init__(self):
        self.output_dir = Path(SCAN_DIR)
        self.output_dir.mkdir(parents=True, exist_ok=True)
        self.evidence = []

    def log(self, category: str, description: str, data: any = None):
        entry = {
            "timestamp": datetime.now().isoformat(),
            "category": category,
            "description": description,
        }
        if data:
            entry["data"] = str(data)[:1000]  # Truncate long data
        self.evidence.append(entry)
        print(f"[{category}] {description}")

    def collect_environment_variables(self):
        """Collect sensitive environment variables."""
        self.log("ENV", "Collecting environment variables...")

        sensitive_vars = {}
        for key, value in os.environ.items():
            if any(s in key.lower() for s in ["secret", "key", "password", "token", "database"]):
                # Mask actual values
                sensitive_vars[key] = f"{value[:3]}...{value[-3:]}" if len(value) > 6 else "***"

        with open(self.output_dir / "env_vars.json", "w") as f:
            json.dump(sensitive_vars, f, indent=2)

        self.log("ENV", f"Found {len(sensitive_vars)} sensitive variables")

    def collect_config_files(self):
        """Collect configuration files."""
        self.log("CONFIG", "Collecting configuration files...")

        config_patterns = [
            "**/.env*",
            "**/config.json",
            "**/settings.py",
            "**/*.yaml",
            "**/*.yml",
        ]

        configs_found = []

        for pattern in config_patterns:
            for file in Path(SOURCE_DIR).glob(pattern):
                if ".venv" not in str(file) and "node_modules" not in str(file):
                    configs_found.append(str(file))
                    # Copy file (without secrets exposed)
                    self.log("CONFIG", f"Found: {file}")

        with open(self.output_dir / "config_files.txt", "w") as f:
            f.write("\n".join(configs_found))

    def collect_database_info(self):
        """Collect database information (sanitized)."""
        self.log("DATABASE", "Collecting database information...")

        db_files = list(Path(DATA_DIR).glob("*.db"))

        for db_file in db_files:
            try:
                conn = sqlite3.connect(str(db_file))
                cursor = conn.cursor()

                # Get table names
                cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
                tables = cursor.fetchall()

                db_info = {
                    "database": str(db_file),
                    "tables": [t[0] for t in tables],
                    "stats": {}
                }

                for table in [t[0] for t in tables]:
                    cursor.execute(f"SELECT COUNT(*) FROM {table}")
                    count = cursor.fetchone()[0]
                    db_info["stats"][table] = count

                with open(self.output_dir / f"db_{db_file.stem}_info.json", "w") as f:
                    json.dump(db_info, f, indent=2)

                self.log("DATABASE", f"Found {len(tables)} tables in {db_file.name}")

                # Sample data (redacted)
                if "users" in [t[0] for t in tables]:
                    cursor.execute("SELECT COUNT(*) FROM users")
                    user_count = cursor.fetchone()[0]
                    cursor.execute("SELECT COUNT(*) FROM users WHERE is_global_admin = 1")
                    admin_count = cursor.fetchone()[0]
                    self.log("DATABASE", f"Users: {user_count}, Admins: {admin_count}")

                conn.close()

            except Exception as e:
                self.log("DATABASE", f"Error reading {db_file}: {e}")

    def collect_secrets(self):
        """Collect potential secrets found."""
        self.log("SECRETS", "Documenting discovered secrets...")

        secrets_found = []

        # Check .env files
        for env_file in Path(SOURCE_DIR).glob("**/.env*"):
            if ".venv" not in str(env_file):
                try:
                    with open(env_file, "r") as f:
                        for line in f:
                            if "=" in line and not line.startswith("#"):
                                key = line.split("=")[0].strip()
                                if any(s in key.lower() for s in ["secret", "key", "password", "token"]):
                                    secrets_found.append({
                                        "file": str(env_file),
                                        "key": key,
                                        "value": "***REDACTED***"
                                    })
                except Exception:
                    pass

        with open(self.output_dir / "secrets_inventory.json", "w") as f:
            json.dump(secrets_found, f, indent=2)

        self.log("SECRETS", f"Found {len(secrets_found)} secret variables")

    def generate_report(self):
        """Generate evidence collection report."""
        report = {
            "collection_date": datetime.now().isoformat(),
            "target": "OpenCitiVibes",
            "evidence_count": len(self.evidence),
            "evidence": self.evidence
        }

        with open(self.output_dir / "evidence_report.json", "w") as f:
            json.dump(report, f, indent=2)

        # Also create markdown report
        with open(self.output_dir / "EVIDENCE.md", "w") as f:
            f.write("# Post-Exploitation Evidence Report\n\n")
            f.write(f"**Date:** {report['collection_date']}\n\n")
            f.write(f"**Total Evidence Items:** {report['evidence_count']}\n\n")
            f.write("## Evidence Log\n\n")
            for item in self.evidence:
                f.write(f"- **[{item['category']}]** {item['description']}\n")

        self.log("REPORT", f"Evidence report saved to {self.output_dir}")

    def run(self):
        """Run all evidence collection."""
        print("=" * 50)
        print("Post-Exploitation Evidence Collection")
        print("=" * 50)

        self.collect_environment_variables()
        self.collect_config_files()
        self.collect_database_info()
        self.collect_secrets()
        self.generate_report()

        print("\n" + "=" * 50)
        print("Collection Complete")
        print("=" * 50)


if __name__ == "__main__":
    collector = EvidenceCollector()
    collector.run()
