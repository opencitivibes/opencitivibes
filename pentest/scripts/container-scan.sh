#!/bin/bash
# Container Security Scanning Script
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/container"

SOURCE_DIR="${SOURCE_DIR:-/app/source}"

log_info "Starting container security scan..."

# Default image names (can be overridden via environment)
BACKEND_IMAGE="${BACKEND_IMAGE:-opencitivibes-backend:dev}"
FRONTEND_IMAGE="${FRONTEND_IMAGE:-opencitivibes-frontend:dev}"

# ============================================================================
# Trivy Scans
# ============================================================================

log_info "============================================"
log_info "Running Trivy vulnerability scans..."
log_info "============================================"

if command -v trivy &> /dev/null; then
    # Scan backend image
    log_info "Scanning backend image: ${BACKEND_IMAGE}..."
    if docker image inspect "${BACKEND_IMAGE}" &>/dev/null; then
        trivy image "${BACKEND_IMAGE}" \
            --format json \
            --output "${SCAN_DIR}/container/trivy-backend.json" 2>/dev/null

        trivy image "${BACKEND_IMAGE}" \
            --format table \
            --output "${SCAN_DIR}/container/trivy-backend.txt" 2>/dev/null

        log_success "Backend image scanned"
    else
        log_warning "Backend image not found: ${BACKEND_IMAGE}"
    fi

    # Scan frontend image
    log_info "Scanning frontend image: ${FRONTEND_IMAGE}..."
    if docker image inspect "${FRONTEND_IMAGE}" &>/dev/null; then
        trivy image "${FRONTEND_IMAGE}" \
            --format json \
            --output "${SCAN_DIR}/container/trivy-frontend.json" 2>/dev/null

        trivy image "${FRONTEND_IMAGE}" \
            --format table \
            --output "${SCAN_DIR}/container/trivy-frontend.txt" 2>/dev/null

        log_success "Frontend image scanned"
    else
        log_warning "Frontend image not found: ${FRONTEND_IMAGE}"
    fi

    # Scan source filesystem
    log_info "Scanning source filesystem..."
    trivy fs "${SOURCE_DIR}" \
        --format json \
        --output "${SCAN_DIR}/container/trivy-fs.json" \
        --scanners vuln,secret,misconfig 2>/dev/null

    trivy fs "${SOURCE_DIR}" \
        --format table \
        --output "${SCAN_DIR}/container/trivy-fs.txt" \
        --scanners vuln,secret,misconfig 2>/dev/null

    log_success "Filesystem scanned"

    # Scan for misconfigurations in IaC files
    log_info "Scanning for IaC misconfigurations..."
    trivy config "${SOURCE_DIR}" \
        --format json \
        --output "${SCAN_DIR}/container/trivy-config.json" 2>/dev/null

    trivy config "${SOURCE_DIR}" \
        --format table \
        --output "${SCAN_DIR}/container/trivy-config.txt" 2>/dev/null

else
    log_error "Trivy not installed"
fi

# ============================================================================
# Grype Scans
# ============================================================================

log_info ""
log_info "============================================"
log_info "Running Grype vulnerability scans..."
log_info "============================================"

if command -v grype &> /dev/null; then
    # Scan backend
    if docker image inspect "${BACKEND_IMAGE}" &>/dev/null; then
        log_info "Grype scanning backend image..."
        grype "${BACKEND_IMAGE}" \
            -o json \
            --file "${SCAN_DIR}/container/grype-backend.json" 2>/dev/null

        grype "${BACKEND_IMAGE}" \
            -o table \
            --file "${SCAN_DIR}/container/grype-backend.txt" 2>/dev/null
    fi

    # Scan frontend
    if docker image inspect "${FRONTEND_IMAGE}" &>/dev/null; then
        log_info "Grype scanning frontend image..."
        grype "${FRONTEND_IMAGE}" \
            -o json \
            --file "${SCAN_DIR}/container/grype-frontend.json" 2>/dev/null

        grype "${FRONTEND_IMAGE}" \
            -o table \
            --file "${SCAN_DIR}/container/grype-frontend.txt" 2>/dev/null
    fi

    # Scan filesystem
    log_info "Grype scanning source directory..."
    grype "dir:${SOURCE_DIR}" \
        -o json \
        --file "${SCAN_DIR}/container/grype-fs.json" 2>/dev/null

else
    log_warning "Grype not installed"
fi

# ============================================================================
# Docker Compose Security Analysis
# ============================================================================

log_info ""
log_info "============================================"
log_info "Analyzing Docker Compose configuration..."
log_info "============================================"

{
    echo "# Docker Compose Security Analysis"
    echo "Date: $(date)"
    echo ""

    # Find all docker-compose files
    for compose_file in $(find "${SOURCE_DIR}" -name "docker-compose*.yml" -o -name "docker-compose*.yaml" 2>/dev/null); do
        echo "## $(basename ${compose_file})"
        echo "Path: ${compose_file}"
        echo ""

        # Check for privileged containers
        echo "### Privileged Mode Check:"
        if grep -q "privileged:\s*true" "${compose_file}" 2>/dev/null; then
            echo "**WARNING**: Privileged containers detected!"
            grep -n "privileged:\s*true" "${compose_file}"
        else
            echo "OK: No privileged containers"
        fi
        echo ""

        # Check for host network mode
        echo "### Network Mode Check:"
        if grep -q "network_mode:\s*host" "${compose_file}" 2>/dev/null; then
            echo "**WARNING**: Host network mode detected!"
            grep -n "network_mode:\s*host" "${compose_file}"
        else
            echo "OK: No host network mode"
        fi
        echo ""

        # Check for sensitive volume mounts
        echo "### Sensitive Volume Mount Check:"
        if grep -q "/var/run/docker.sock" "${compose_file}" 2>/dev/null; then
            echo "**WARNING**: Docker socket mounted!"
            grep -n "/var/run/docker.sock" "${compose_file}"
        else
            echo "OK: No Docker socket mount"
        fi

        if grep -q "/etc/shadow\|/etc/passwd" "${compose_file}" 2>/dev/null; then
            echo "**WARNING**: System files mounted!"
            grep -n "/etc/shadow\|/etc/passwd" "${compose_file}"
        fi
        echo ""

        # Check for capability additions
        echo "### Capabilities Check:"
        if grep -q "cap_add" "${compose_file}" 2>/dev/null; then
            echo "**WARNING**: Additional capabilities added:"
            grep -A5 "cap_add" "${compose_file}"
        else
            echo "OK: No additional capabilities"
        fi
        echo ""

        # Check for environment variable exposure
        echo "### Environment Variables Check:"
        SENSITIVE_VARS=$(grep -E "(PASSWORD|SECRET|KEY|TOKEN|CREDENTIAL)" "${compose_file}" 2>/dev/null | grep -v "#")
        if [ -n "${SENSITIVE_VARS}" ]; then
            echo "**WARNING**: Sensitive environment variables in compose file:"
            echo "${SENSITIVE_VARS}" | sed 's/=.*/=***REDACTED***/'
        else
            echo "OK: No sensitive variables in plain text"
        fi
        echo ""
        echo "---"
        echo ""
    done

} > "${SCAN_DIR}/container/docker-compose-analysis.md"

# ============================================================================
# Dockerfile Security Analysis
# ============================================================================

log_info "Analyzing Dockerfiles..."

{
    echo "# Dockerfile Security Analysis"
    echo "Date: $(date)"
    echo ""

    for dockerfile in $(find "${SOURCE_DIR}" -name "Dockerfile*" 2>/dev/null); do
        echo "## $(basename ${dockerfile})"
        echo "Path: ${dockerfile}"
        echo ""

        # Check for root user
        echo "### User Check:"
        if grep -q "^USER " "${dockerfile}" 2>/dev/null; then
            echo "OK: Non-root user specified:"
            grep "^USER " "${dockerfile}"
        else
            echo "**WARNING**: Container may run as root (no USER directive)"
        fi
        echo ""

        # Check for latest tag
        echo "### Base Image Tag Check:"
        if grep -E "^FROM.*:latest" "${dockerfile}" 2>/dev/null; then
            echo "**WARNING**: Using :latest tag (unpinned version):"
            grep "^FROM.*:latest" "${dockerfile}"
        else
            echo "OK: No :latest tags found"
        fi
        echo ""

        # Check for exposed secrets
        echo "### Secret Exposure Check:"
        if grep -E "(ARG|ENV).*(PASSWORD|SECRET|KEY)" "${dockerfile}" 2>/dev/null; then
            echo "**WARNING**: Potential secret exposure in build args/env:"
            grep -E "(ARG|ENV).*(PASSWORD|SECRET|KEY)" "${dockerfile}"
        else
            echo "OK: No obvious secrets in Dockerfile"
        fi
        echo ""
        echo "---"
        echo ""
    done

} > "${SCAN_DIR}/container/dockerfile-analysis.md"

# ============================================================================
# Summary
# ============================================================================

log_success "Container security scan complete!"

# Count vulnerabilities
BACKEND_CRITICAL=0
BACKEND_HIGH=0
FRONTEND_CRITICAL=0
FRONTEND_HIGH=0

if [ -f "${SCAN_DIR}/container/trivy-backend.json" ]; then
    BACKEND_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' \
        "${SCAN_DIR}/container/trivy-backend.json" 2>/dev/null || echo 0)
    BACKEND_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' \
        "${SCAN_DIR}/container/trivy-backend.json" 2>/dev/null || echo 0)
fi

if [ -f "${SCAN_DIR}/container/trivy-frontend.json" ]; then
    FRONTEND_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' \
        "${SCAN_DIR}/container/trivy-frontend.json" 2>/dev/null || echo 0)
    FRONTEND_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' \
        "${SCAN_DIR}/container/trivy-frontend.json" 2>/dev/null || echo 0)
fi

echo ""
log_info "Vulnerability Summary:"
echo ""
echo "  Backend Image (${BACKEND_IMAGE}):"
echo "    Critical: ${BACKEND_CRITICAL}"
echo "    High: ${BACKEND_HIGH}"
echo ""
echo "  Frontend Image (${FRONTEND_IMAGE}):"
echo "    Critical: ${FRONTEND_CRITICAL}"
echo "    High: ${FRONTEND_HIGH}"
echo ""

# Generate summary file
{
    echo "# Container Security Scan Summary"
    echo "Date: $(date)"
    echo ""
    echo "## Vulnerability Counts"
    echo ""
    echo "| Image | Critical | High |"
    echo "|-------|----------|------|"
    echo "| Backend | ${BACKEND_CRITICAL} | ${BACKEND_HIGH} |"
    echo "| Frontend | ${FRONTEND_CRITICAL} | ${FRONTEND_HIGH} |"
    echo ""
    echo "## Reports Generated"
    echo ""
    ls -la "${SCAN_DIR}/container/" | while read line; do
        echo "- ${line}"
    done
} > "${SCAN_DIR}/container/SUMMARY.md"

log_info "Full results in: ${SCAN_DIR}/container/"
ls -la "${SCAN_DIR}/container/"
