#!/bin/bash
# Comprehensive Web Application Security Testing
# Orchestrates Playwright crawling -> Scanner seeding -> Results aggregation
# OpenCitiVibes Penetration Testing - Phase 3

source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}"

SCAN_MODE="${1:-standard}"  # quick, standard, full

log_info "Web Application Security Testing Suite"
log_info "======================================="
log_info "Mode: ${SCAN_MODE}"
log_info "Scan directory: ${SCAN_DIR}"
echo ""

START_TIME=$(date +%s)

# Configure based on mode
case $SCAN_MODE in
    "quick")
        PLAYWRIGHT_MAX_DEPTH=1
        MAX_URLS=100
        ZAP_MODE="baseline"
        NUCLEI_MODE="quick"
        ;;
    "standard")
        PLAYWRIGHT_MAX_DEPTH=3
        MAX_URLS=500
        ZAP_MODE="api"
        NUCLEI_MODE="standard"
        ;;
    "full")
        PLAYWRIGHT_MAX_DEPTH=5
        MAX_URLS=2000
        ZAP_MODE="seeded"
        NUCLEI_MODE="full"
        ;;
    *)
        log_error "Unknown mode: $SCAN_MODE"
        echo ""
        echo "Usage: $0 [quick|standard|full]"
        echo ""
        echo "Modes:"
        echo "  quick    - Fast scan (~5 min), 100 URLs max"
        echo "  standard - Default scan (~20 min), 500 URLs max"
        echo "  full     - Comprehensive scan (~60 min), 2000 URLs max"
        exit 1
        ;;
esac

export PLAYWRIGHT_MAX_DEPTH MAX_URLS SCAN_MODE

# ============================================================================
# Phase 1: Reconnaissance and URL Discovery
# ============================================================================

log_info "[1/5] Running reconnaissance..."
mkdir -p "${SCAN_DIR}/recon"

# Run Playwright crawler if available
if command -v playwright &> /dev/null || python3 -c "import playwright" 2>/dev/null; then
    log_info "Running Playwright SPA crawler..."

    CRAWL_CREDS=""
    if [ -n "${ADMIN_EMAIL}" ] && [ -n "${ADMIN_PASSWORD}" ]; then
        CRAWL_CREDS="--login ${ADMIN_EMAIL}:${ADMIN_PASSWORD}"
    fi

    python3 /app/scripts/run-playwright-crawl.py \
        --start-url "${TARGET_FRONTEND:-http://frontend:3000}" \
        --output-file "${SCAN_DIR}/recon/playwright-urls.txt" \
        --max-depth ${PLAYWRIGHT_MAX_DEPTH} \
        --headless true \
        ${CRAWL_CREDS} 2>&1 | tee "${SCAN_DIR}/recon/playwright.log"

    if [ -f "${SCAN_DIR}/recon/playwright-urls.txt" ]; then
        CRAWLED_COUNT=$(wc -l < "${SCAN_DIR}/recon/playwright-urls.txt")
        log_success "Playwright discovered ${CRAWLED_COUNT} URLs"
    fi
else
    log_warning "Playwright not available, skipping SPA crawl"
fi

# Run recon script if available
if [ -f "/app/scripts/recon.sh" ]; then
    /app/scripts/recon.sh 2>&1 | tee -a "${SCAN_DIR}/recon/recon.log"
fi

# Merge and dedupe URLs
log_info "Normalizing discovered URLs..."
if [ -f "${SCAN_DIR}/recon/playwright-urls.txt" ] || [ -f "${SCAN_DIR}/recon/endpoints.txt" ]; then
    cat "${SCAN_DIR}/recon/playwright-urls.txt" "${SCAN_DIR}/recon/endpoints.txt" 2>/dev/null | \
        /app/scripts/helpers/dedupe-urls.sh /dev/stdin "${SCAN_DIR}/recon/normalized-urls.txt" "${MAX_URLS}"
fi

# ============================================================================
# Phase 2: Frontend Security Testing
# ============================================================================

log_info ""
log_info "[2/5] Running frontend security tests..."

python3 /app/scripts/frontend-security-test.py \
    --url "${TARGET_FRONTEND:-http://frontend:3000}" \
    --output "${SCAN_DIR}/frontend"

# ============================================================================
# Phase 3: Nuclei Scanning with Discovered URLs
# ============================================================================

log_info ""
log_info "[3/5] Running Nuclei with discovered URLs..."

if [ -f "${SCAN_DIR}/recon/normalized-urls.txt" ] && [ -s "${SCAN_DIR}/recon/normalized-urls.txt" ]; then
    URL_COUNT=$(wc -l < "${SCAN_DIR}/recon/normalized-urls.txt")
    log_info "Scanning ${URL_COUNT} discovered URLs..."
    /app/scripts/run-nuclei.sh seeded "${SCAN_DIR}/recon/normalized-urls.txt"
else
    log_warning "No discovered URLs, running standard Nuclei scan"
    /app/scripts/run-nuclei.sh ${NUCLEI_MODE}
fi

# ============================================================================
# Phase 4: OWASP ZAP Scanning
# ============================================================================

log_info ""
log_info "[4/5] Running OWASP ZAP scan..."

if [ "${ZAP_MODE}" = "seeded" ] && [ -f "${SCAN_DIR}/recon/normalized-urls.txt" ]; then
    /app/scripts/run-zap.sh seeded "${SCAN_DIR}/recon/normalized-urls.txt"
else
    /app/scripts/run-zap.sh ${ZAP_MODE}
fi

# ============================================================================
# Phase 5: Results Aggregation
# ============================================================================

log_info ""
log_info "[5/5] Aggregating results..."

if [ -f "/app/scripts/reporting/aggregate_findings.py" ]; then
    python3 /app/scripts/reporting/aggregate_findings.py
fi

# ============================================================================
# Summary
# ============================================================================

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

{
    echo "# Web Application Security Test Summary"
    echo ""
    echo "**Mode:** ${SCAN_MODE}"
    echo "**Duration:** ${DURATION} seconds"
    echo "**Date:** $(date)"
    echo ""
    echo "## URL Discovery"
    echo ""
    if [ -f "${SCAN_DIR}/recon/playwright-urls.txt" ]; then
        echo "- Playwright URLs: $(wc -l < ${SCAN_DIR}/recon/playwright-urls.txt 2>/dev/null || echo 0)"
    fi
    if [ -f "${SCAN_DIR}/recon/normalized-urls.txt" ]; then
        echo "- Normalized URLs: $(wc -l < ${SCAN_DIR}/recon/normalized-urls.txt 2>/dev/null || echo 0)"
    fi
    echo ""
    echo "## Findings by Tool"
    echo ""

    # Count findings per tool
    for tool in nuclei zap frontend; do
        if [ -d "${SCAN_DIR}/${tool}" ]; then
            COUNT=$(find "${SCAN_DIR}/${tool}" -name "*.json" -exec cat {} \; 2>/dev/null | \
                grep -c '"severity"' || echo 0)
            echo "- ${tool}: ${COUNT} findings"
        fi
    done

    echo ""
    echo "## Files Generated"
    echo ""
    find "${SCAN_DIR}" -type f \( -name "*.json" -o -name "*.txt" -o -name "*.md" \) 2>/dev/null | \
        sort | while read f; do
            echo "- ${f#${SCAN_DIR}/}"
        done

} > "${SCAN_DIR}/WEBAPP_TEST_SUMMARY.md"

log_success ""
log_success "Web Application Testing Complete!"
log_success "================================="
log_info "Duration: ${DURATION} seconds"
log_info "Summary: ${SCAN_DIR}/WEBAPP_TEST_SUMMARY.md"
echo ""

cat "${SCAN_DIR}/WEBAPP_TEST_SUMMARY.md"
