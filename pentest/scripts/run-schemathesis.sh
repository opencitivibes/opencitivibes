#!/bin/bash
# Schemathesis API Fuzzing Script
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/schemathesis"
mkdir -p "${SCAN_DIR}/schemathesis/failures"

TARGET_API="${TARGET_API:-http://backend:8000}"
SCHEMA_FILE="${SCHEMA_FILE:-${TARGET_API}/openapi.json}"
MAX_EXAMPLES="${MAX_EXAMPLES:-100}"
AUTH_TOKEN="${AUTH_TOKEN:-}"
SCAN_MODE="${1:-standard}"  # quick, standard, full

log_info "Starting Schemathesis API fuzzing..."
log_info "Schema: ${SCHEMA_FILE}"
log_info "Mode: ${SCAN_MODE}"

# Set max_examples based on mode
case $SCAN_MODE in
    "quick")
        MAX_EXAMPLES=30
        CHECKS="not_a_server_error,status_code_conformance"
        ;;
    "standard")
        MAX_EXAMPLES=100
        CHECKS="all"
        ;;
    "full")
        MAX_EXAMPLES=200
        CHECKS="all"
        ;;
    *)
        log_error "Unknown mode: $SCAN_MODE"
        echo ""
        echo "Usage: $0 [quick|standard|full]"
        echo ""
        echo "Modes:"
        echo "  quick    - 30 examples, basic checks (for PRs)"
        echo "  standard - 100 examples, all checks (default)"
        echo "  full     - 200 examples, all checks (nightly)"
        exit 1
        ;;
esac

log_info "Max examples per endpoint: ${MAX_EXAMPLES}"

# Verify schema is accessible
if ! curl -sf "${SCHEMA_FILE}" > /tmp/schema-check.json 2>/dev/null; then
    log_error "Cannot access OpenAPI schema at ${SCHEMA_FILE}"
    log_info "Attempting discovery at common paths..."

    for path in "/openapi.json" "/api/openapi.json" "/docs/openapi.json" "/swagger.json"; do
        ALT_SCHEMA="${TARGET_API}${path}"
        if curl -sf "${ALT_SCHEMA}" > /dev/null 2>/dev/null; then
            log_success "Found schema at ${ALT_SCHEMA}"
            SCHEMA_FILE="${ALT_SCHEMA}"
            break
        fi
    done
fi

# Get auth token if not provided
if [ -z "${AUTH_TOKEN}" ] && [ -n "${ADMIN_EMAIL}" ] && [ -n "${ADMIN_PASSWORD}" ]; then
    log_info "Obtaining authentication token..."
    AUTH_RESPONSE=$(curl -sf -X POST "${TARGET_API}/api/auth/login" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=${ADMIN_EMAIL}&password=${ADMIN_PASSWORD}")

    if [ -n "${AUTH_RESPONSE}" ]; then
        AUTH_TOKEN=$(echo "${AUTH_RESPONSE}" | jq -r '.access_token // empty')
        if [ -n "${AUTH_TOKEN}" ]; then
            log_success "Token obtained successfully"
        fi
    fi
fi

# Check if schemathesis is available
if ! command -v schemathesis &> /dev/null; then
    log_error "Schemathesis not installed"
    log_info "Install with: pip install schemathesis"
    exit 1
fi

# Build schemathesis command
SCHEMATHESIS_CMD="schemathesis run ${SCHEMA_FILE} \
    --checks ${CHECKS} \
    --max-examples ${MAX_EXAMPLES} \
    --hypothesis-phases=generate \
    --stateful=links \
    --base-url ${TARGET_API} \
    --cassette-path ${SCAN_DIR}/schemathesis/cassette.yaml"

# Add auth if available
if [ -n "${AUTH_TOKEN}" ]; then
    SCHEMATHESIS_CMD="${SCHEMATHESIS_CMD} -H 'Authorization: Bearer ${AUTH_TOKEN}'"
fi

# Run Schemathesis
log_info "Running Schemathesis..."
eval ${SCHEMATHESIS_CMD} 2>&1 | tee "${SCAN_DIR}/schemathesis/output.log"
EXIT_CODE=${PIPESTATUS[0]}

# Extract and format failures
if [ -f "${SCAN_DIR}/schemathesis/cassette.yaml" ]; then
    log_info "Processing failures from cassette..."

    # Convert cassette YAML to JSON for easier processing
    python3 << 'PYTHON_SCRIPT'
import yaml
import json
import os
from pathlib import Path

scan_dir = os.environ.get("SCAN_DIR", "/app/results")
cassette_path = Path(scan_dir) / "schemathesis" / "cassette.yaml"
failures_dir = Path(scan_dir) / "schemathesis" / "failures"

if cassette_path.exists():
    try:
        with open(cassette_path) as f:
            cassette = yaml.safe_load(f)

        if cassette and "interactions" in cassette:
            for i, interaction in enumerate(cassette["interactions"]):
                failure_file = failures_dir / f"failure_{i:03d}.json"
                with open(failure_file, "w") as f:
                    json.dump(interaction, f, indent=2)

            print(f"Extracted {len(cassette['interactions'])} interaction(s)")
    except Exception as e:
        print(f"Warning: Could not parse cassette: {e}")
PYTHON_SCRIPT
fi

# Generate summary report
{
    echo "# Schemathesis API Fuzzing Summary"
    echo ""
    echo "## Configuration"
    echo ""
    echo "| Setting | Value |"
    echo "|---------|-------|"
    echo "| Target API | ${TARGET_API} |"
    echo "| Schema | ${SCHEMA_FILE} |"
    echo "| Mode | ${SCAN_MODE} |"
    echo "| Max Examples | ${MAX_EXAMPLES} |"
    echo "| Authenticated | $([ -n \"${AUTH_TOKEN}\" ] && echo 'Yes' || echo 'No') |"
    echo "| Date | $(date) |"
    echo ""
    echo "## Results"
    echo ""

    if [ $EXIT_CODE -eq 0 ]; then
        echo "**Status:** All checks passed"
        echo ""
    else
        echo "**Status:** Failures detected"
        echo ""
        echo "### Failure Categories"
        echo ""

        # Count failures by type
        SERVER_ERRORS=$(grep -c "server_error\|5[0-9][0-9]" "${SCAN_DIR}/schemathesis/output.log" 2>/dev/null || echo 0)
        STATUS_MISMATCHES=$(grep -c "status_code_conformance" "${SCAN_DIR}/schemathesis/output.log" 2>/dev/null || echo 0)
        SCHEMA_VIOLATIONS=$(grep -c "response_schema_conformance" "${SCAN_DIR}/schemathesis/output.log" 2>/dev/null || echo 0)

        [ "$SERVER_ERRORS" -gt 0 ] && echo "- Server errors (5xx): ${SERVER_ERRORS}"
        [ "$STATUS_MISMATCHES" -gt 0 ] && echo "- Status code mismatches: ${STATUS_MISMATCHES}"
        [ "$SCHEMA_VIOLATIONS" -gt 0 ] && echo "- Schema violations: ${SCHEMA_VIOLATIONS}"

        echo ""
        echo "### Sample Failures"
        echo ""
        echo '```'
        grep -A 5 "FAILED\|Failure\|Error" "${SCAN_DIR}/schemathesis/output.log" 2>/dev/null | head -50 || echo "No detailed failure messages"
        echo '```'
    fi

    echo ""
    echo "## Output Files"
    echo ""
    echo "- Full log: \`schemathesis/output.log\`"
    echo "- Request/Response cassette: \`schemathesis/cassette.yaml\`"
    echo "- Individual failures: \`schemathesis/failures/\`"

} > "${SCAN_DIR}/schemathesis/SUMMARY.md"

log_success "Schemathesis scan complete!"
log_info "Summary: ${SCAN_DIR}/schemathesis/SUMMARY.md"

# Return success regardless of test failures (non-blocking)
exit 0
