#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/sast"

SOURCE_DIR="${SOURCE_DIR:-/app/source}"

log_info "Starting ESLint security analysis..."

cd "${SOURCE_DIR}/frontend"

# Install security plugins if not present
npm install --save-dev \
    eslint-plugin-security \
    eslint-plugin-no-secrets \
    eslint-plugin-xss \
    @typescript-eslint/parser \
    @typescript-eslint/eslint-plugin \
    2>/dev/null

# Run ESLint with security config
log_info "Running ESLint security scan..."

npx eslint \
    --config /app/config/eslint-security.config.js \
    --format json \
    --output-file "${SCAN_DIR}/sast/eslint-security.json" \
    src/ \
    2>&1 | tee "${SCAN_DIR}/sast/eslint-security.log" || true

# Also generate readable report
npx eslint \
    --config /app/config/eslint-security.config.js \
    --format stylish \
    src/ \
    > "${SCAN_DIR}/sast/eslint-security.txt" 2>&1 || true

# Parse results
if [ -f "${SCAN_DIR}/sast/eslint-security.json" ]; then
    ERRORS=$(jq '[.[].messages[] | select(.severity == 2)] | length' "${SCAN_DIR}/sast/eslint-security.json" 2>/dev/null || echo 0)
    WARNINGS=$(jq '[.[].messages[] | select(.severity == 1)] | length' "${SCAN_DIR}/sast/eslint-security.json" 2>/dev/null || echo 0)

    log_success "ESLint security scan complete!"
    echo ""
    log_info "Summary:"
    echo "  Errors: ${ERRORS}"
    echo "  Warnings: ${WARNINGS}"
fi

log_info "Results in ${SCAN_DIR}/sast/"
