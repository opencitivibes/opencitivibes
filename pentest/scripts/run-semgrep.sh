#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/sast"

SOURCE_DIR="${SOURCE_DIR:-/app/source}"

log_info "Starting Semgrep security analysis..."

# ============================================================================
# Backend Analysis (Python)
# ============================================================================

log_info "Scanning Python backend..."

semgrep scan \
    --config /app/semgrep-rules/fastapi-security.yaml \
    --config p/python \
    --config p/security-audit \
    --json \
    --output "${SCAN_DIR}/sast/semgrep-backend.json" \
    "${SOURCE_DIR}/backend" \
    --exclude ".venv" \
    --exclude "tests" \
    --exclude "__pycache__" \
    2>&1 | tee "${SCAN_DIR}/sast/semgrep-backend.log"

# ============================================================================
# Frontend Analysis (TypeScript/React)
# ============================================================================

log_info "Scanning TypeScript frontend..."

semgrep scan \
    --config /app/semgrep-rules/react-security.yaml \
    --config p/typescript \
    --config p/react \
    --config p/security-audit \
    --json \
    --output "${SCAN_DIR}/sast/semgrep-frontend.json" \
    "${SOURCE_DIR}/frontend/src" \
    --exclude "node_modules" \
    --exclude ".next" \
    2>&1 | tee "${SCAN_DIR}/sast/semgrep-frontend.log"

# ============================================================================
# Combined Analysis
# ============================================================================

log_info "Running combined security scan..."

semgrep scan \
    --config /app/semgrep-rules/ \
    --config p/security-audit \
    --sarif \
    --output "${SCAN_DIR}/sast/semgrep-combined.sarif" \
    "${SOURCE_DIR}" \
    --exclude ".venv" \
    --exclude "node_modules" \
    --exclude ".next" \
    --exclude "__pycache__" \
    --exclude "tests" \
    2>/dev/null

# ============================================================================
# Summary
# ============================================================================

log_success "Semgrep scan complete!"

# Parse backend results
if [ -f "${SCAN_DIR}/sast/semgrep-backend.json" ]; then
    BACKEND_ERRORS=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' "${SCAN_DIR}/sast/semgrep-backend.json" 2>/dev/null || echo 0)
    BACKEND_WARNINGS=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' "${SCAN_DIR}/sast/semgrep-backend.json" 2>/dev/null || echo 0)

    echo ""
    log_info "Backend findings:"
    echo "  Errors: ${BACKEND_ERRORS}"
    echo "  Warnings: ${BACKEND_WARNINGS}"
fi

# Parse frontend results
if [ -f "${SCAN_DIR}/sast/semgrep-frontend.json" ]; then
    FRONTEND_ERRORS=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' "${SCAN_DIR}/sast/semgrep-frontend.json" 2>/dev/null || echo 0)
    FRONTEND_WARNINGS=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' "${SCAN_DIR}/sast/semgrep-frontend.json" 2>/dev/null || echo 0)

    echo ""
    log_info "Frontend findings:"
    echo "  Errors: ${FRONTEND_ERRORS}"
    echo "  Warnings: ${FRONTEND_WARNINGS}"
fi

log_info "Results in ${SCAN_DIR}/sast/"
