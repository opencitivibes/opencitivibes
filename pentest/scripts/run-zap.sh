#!/bin/bash
# OWASP ZAP Automation Script
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/zap"

log_info "Starting OWASP ZAP scan..."

SCAN_TYPE="${1:-baseline}"

case $SCAN_TYPE in
    "baseline")
        log_info "Running baseline scan..."
        if [ -f /app/config/zap-baseline.yaml ]; then
            zap -cmd -autorun /app/config/zap-baseline.yaml
        else
            # Run default baseline scan
            zap-baseline.py -t "${TARGET_API:-http://backend:8000}" \
                -J "${SCAN_DIR}/zap/baseline.json" \
                -r "${SCAN_DIR}/zap/baseline.html" \
                -w "${SCAN_DIR}/zap/baseline.md" \
                -I
        fi
        ;;
    "full")
        log_info "Running full scan..."
        zap -cmd -autorun /app/config/zap-config.yaml
        ;;
    "api")
        log_info "Running API scan..."
        TARGET="${TARGET_API:-http://backend:8000}"

        # Check if OpenAPI spec is available
        if curl -sf "${TARGET}/openapi.json" > /dev/null 2>&1; then
            log_info "Found OpenAPI specification, importing..."
            zap-api-scan.py -t "${TARGET}/openapi.json" \
                -f openapi \
                -J "${SCAN_DIR}/zap/api-scan.json" \
                -r "${SCAN_DIR}/zap/api-scan.html" \
                -w "${SCAN_DIR}/zap/api-scan.md" \
                -I
        else
            log_warning "No OpenAPI spec found, running generic API scan..."
            zap -cmd -quickurl "${TARGET}" \
                -quickprogress \
                -quickout "${SCAN_DIR}/zap/api-scan.html"
        fi
        ;;
    "auth")
        log_info "Running authenticated scan..."

        # First authenticate to get token
        log_info "Obtaining authentication token..."
        AUTH_RESPONSE=$(curl -sf -X POST "${TARGET_API:-http://backend:8000/api}/auth/login" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=${ADMIN_EMAIL:-admin@idees-montreal.ca}&password=${ADMIN_PASSWORD:-Admin2024!Mtl}")

        if [ -z "${AUTH_RESPONSE}" ]; then
            log_error "Failed to authenticate. Check credentials."
            exit 1
        fi

        TOKEN=$(echo "${AUTH_RESPONSE}" | jq -r '.access_token')

        if [ "${TOKEN}" == "null" ] || [ -z "${TOKEN}" ]; then
            log_error "Failed to extract access token from response"
            exit 1
        fi

        log_success "Token obtained successfully"

        # Run scan with authentication header
        zap -cmd \
            -config "replacer.full_list(0).description=auth" \
            -config "replacer.full_list(0).enabled=true" \
            -config "replacer.full_list(0).matchtype=REQ_HEADER" \
            -config "replacer.full_list(0).matchstr=Authorization" \
            -config "replacer.full_list(0).replacement=Bearer ${TOKEN}" \
            -autorun /app/config/zap-config.yaml

        # Copy results to scan directory
        cp /app/results/zap/* "${SCAN_DIR}/zap/" 2>/dev/null || true
        ;;
    "ajax")
        log_info "Running AJAX spider scan (for frontend SPA)..."
        TARGET="${TARGET_FRONTEND:-http://frontend:3000}"

        zap -cmd -quickurl "${TARGET}" \
            -quickprogress \
            -ajaxspider \
            -quickout "${SCAN_DIR}/zap/ajax-scan.html"
        ;;
    "seeded")
        log_info "Running seeded scan with discovered URLs..."
        URLS_FILE="${2:-${SCAN_DIR}/recon/normalized-urls.txt}"

        if [ ! -f "${URLS_FILE}" ]; then
            log_error "URLs file not found: ${URLS_FILE}"
            log_info "Run recon.sh or webapp-full-test.sh first to discover URLs"
            exit 1
        fi

        URL_COUNT=$(wc -l < "${URLS_FILE}")
        log_info "Loading ${URL_COUNT} URLs from ${URLS_FILE}"

        # Import session cookies if available
        SESSION_FILE="${SCAN_DIR}/recon/playwright-session.json"
        if [ -f "${SESSION_FILE}" ]; then
            log_info "Playwright session data available for import"
        fi

        # Create ZAP automation file with URL import
        cat > /tmp/zap-seeded-config.yaml << EOF
env:
  contexts:
    - name: "SeededContext"
      urls:
$(head -50 "${URLS_FILE}" | while read url; do echo "        - \"${url}\""; done)
      includePaths:
        - ".*"
  parameters:
    failOnError: false
    progressToStdout: true

jobs:
  - type: spider
    parameters:
      maxDuration: 5
      maxDepth: 3
  - type: passiveScan-wait
  - type: activeScan
    parameters:
      maxScanDurationInMins: 30
  - type: report
    parameters:
      template: "traditional-json"
      reportFile: "seeded-scan.json"
      reportDir: "${SCAN_DIR}/zap"
EOF

        log_info "Running ZAP with seeded URLs..."
        zap -cmd -autorun /tmp/zap-seeded-config.yaml 2>&1 | tee "${SCAN_DIR}/zap/seeded-scan.log"
        ;;
    *)
        log_error "Unknown scan type: $SCAN_TYPE"
        echo ""
        echo "Usage: $0 [baseline|full|api|auth|ajax|seeded <urls_file>]"
        echo ""
        echo "Scan types:"
        echo "  baseline  - Quick passive scan (default)"
        echo "  full      - Full active scan with custom policy"
        echo "  api       - API-focused scan using OpenAPI spec"
        echo "  auth      - Authenticated scan as admin user"
        echo "  ajax      - AJAX spider for SPA frontend"
        echo "  seeded    - Scan pre-discovered URLs from file"
        exit 1
        ;;
esac

log_success "ZAP scan complete!"
log_info "Results saved to: ${SCAN_DIR}/zap/"

# Display summary if JSON report exists
if [ -f "${SCAN_DIR}/zap/"*.json ]; then
    log_info "Scan summary:"
    for jsonfile in "${SCAN_DIR}/zap/"*.json; do
        if [ -f "${jsonfile}" ]; then
            HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode == "3")] | length' "${jsonfile}" 2>/dev/null || echo "?")
            MEDIUM=$(jq '[.site[]?.alerts[]? | select(.riskcode == "2")] | length' "${jsonfile}" 2>/dev/null || echo "?")
            LOW=$(jq '[.site[]?.alerts[]? | select(.riskcode == "1")] | length' "${jsonfile}" 2>/dev/null || echo "?")
            INFO=$(jq '[.site[]?.alerts[]? | select(.riskcode == "0")] | length' "${jsonfile}" 2>/dev/null || echo "?")

            echo "  $(basename ${jsonfile}):"
            echo "    High: ${HIGH}, Medium: ${MEDIUM}, Low: ${LOW}, Info: ${INFO}"
        fi
    done
fi

ls -la "${SCAN_DIR}/zap/"
