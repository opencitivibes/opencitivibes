#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

export SCAN_DIR="${SCAN_DIR:-/app/results}"

log_info "Starting report generation..."
log_info "Scan directory: ${SCAN_DIR}"

# ============================================================================
# Phase 1: Aggregate all findings
# ============================================================================

log_info "Phase 1: Aggregating findings from all sources..."
python /app/scripts/reporting/aggregate_findings.py

# ============================================================================
# Phase 2: Enrich with CVE data
# ============================================================================

log_info "Phase 2: Enriching with CVE data..."
python /app/scripts/reporting/cve_lookup.py

# ============================================================================
# Phase 3: Add detailed remediations
# ============================================================================

log_info "Phase 3: Adding remediation recommendations..."
python /app/scripts/reporting/remediation_engine.py

# ============================================================================
# Phase 4: Generate reports
# ============================================================================

log_info "Phase 4: Generating reports..."
python /app/scripts/reporting/generate_report.py

# ============================================================================
# Summary
# ============================================================================

log_success "Report generation complete!"
echo ""
log_info "Generated reports:"
ls -la "${SCAN_DIR}/reports/" 2>/dev/null

echo ""
log_info "Open ${SCAN_DIR}/reports/security_report.html in a browser for the full report"
log_info "Executive summary: ${SCAN_DIR}/reports/EXECUTIVE_SUMMARY.md"
