#!/usr/bin/env python3
"""
XSS Testing Script for OpenCitiVibes

Tests for Cross-Site Scripting in:
- Idea titles and descriptions
- Comments
- User display names
- Search queries

Uses dynamic credential discovery - no hardcoded credentials.
"""

import requests
import json
import os
import sys
from pathlib import Path
from datetime import datetime

# Add helpers to path
sys.path.insert(0, str(Path(__file__).parent / "helpers"))
from auth_discovery import get_authenticated_session, TARGET_API

SCAN_DIR = os.environ.get("SCAN_DIR", "/app/results/xss")

# XSS payloads to test
XSS_PAYLOADS = [
    '<script>alert("XSS")</script>',
    '<img src=x onerror=alert("XSS")>',
    '<svg onload=alert("XSS")>',
    '"><script>alert("XSS")</script>',
    "javascript:alert('XSS')",
    '<a href="javascript:alert(1)">click</a>',
    '<body onload=alert("XSS")>',
    '{{constructor.constructor("alert(1)")()}}',
    '${alert("XSS")}',
    '<iframe src="javascript:alert(1)">',
    '<math><mi//xlink:href="data:x,<script>alert(1)</script>">',
    '<div style="background:url(javascript:alert(1))">',
]


class XSSTester:
    def __init__(self):
        self.results = []
        self.token = None
        self.session = None
        self.user_info = {}
        Path(SCAN_DIR).mkdir(parents=True, exist_ok=True)

    def log(self, level: str, message: str):
        timestamp = datetime.now().isoformat()
        print(f"[{timestamp}] [{level}] {message}")
        self.results.append({"timestamp": timestamp, "level": level, "message": message})

    def get_token(self):
        """Get authentication token using dynamic discovery."""
        self.session, self.token, self.user_info = get_authenticated_session()
        if self.token:
            self.log("INFO", f"Authenticated as: {self.user_info.get('email')}")
            return True
        return False

    def test_idea_xss(self):
        """Test XSS in idea creation."""
        self.log("INFO", "Testing XSS in ideas...")

        for payload in XSS_PAYLOADS[:5]:  # Test subset to avoid spam
            response = requests.post(
                f"{TARGET_API}/ideas/",
                headers={
                    "Authorization": f"Bearer {self.token}",
                    "Content-Type": "application/json"
                },
                json={
                    "title": f"XSS Test {payload}",
                    "description": payload,
                    "category_id": 1,
                    "tags": []
                }
            )

            if response.status_code == 200:
                idea = response.json()
                # Check if payload is stored as-is (potential stored XSS)
                if payload in idea.get("title", "") or payload in idea.get("description", ""):
                    self.log("HIGH", f"Potential stored XSS in idea: {payload[:30]}...")

                    # Clean up - delete the test idea
                    requests.delete(
                        f"{TARGET_API}/ideas/{idea['id']}",
                        headers={"Authorization": f"Bearer {self.token}"}
                    )
                else:
                    self.log("INFO", f"Payload sanitized in idea creation (good)")
            elif response.status_code == 422:
                self.log("INFO", f"Payload rejected by validation (good)")

    def test_comment_xss(self):
        """Test XSS in comments."""
        self.log("INFO", "Testing XSS in comments...")

        # Get an idea to comment on
        ideas = requests.get(f"{TARGET_API}/ideas/leaderboard?limit=1").json()
        if not ideas:
            self.log("WARNING", "No ideas to test comments on")
            return

        idea_id = ideas[0]["id"]

        for payload in XSS_PAYLOADS[:5]:
            response = requests.post(
                f"{TARGET_API}/comments/{idea_id}",
                headers={
                    "Authorization": f"Bearer {self.token}",
                    "Content-Type": "application/json"
                },
                json={"content": payload}
            )

            if response.status_code in [200, 202]:
                comment = response.json() if response.status_code == 200 else {}
                if payload in str(comment):
                    self.log("HIGH", f"Potential stored XSS in comment: {payload[:30]}...")
                else:
                    self.log("INFO", "Comment payload sanitized (good)")

    def test_search_xss(self):
        """Test reflected XSS in search."""
        self.log("INFO", "Testing XSS in search...")

        for payload in XSS_PAYLOADS[:5]:
            response = requests.get(
                f"{TARGET_API}/search/ideas",
                params={"q": payload}
            )

            if response.status_code == 200:
                # Check if payload is reflected in response
                if payload in response.text:
                    self.log("HIGH", f"Potential reflected XSS in search: {payload[:30]}...")
                else:
                    self.log("INFO", "Search query sanitized (good)")

    def run_all_tests(self):
        self.log("INFO", "=" * 50)
        self.log("INFO", "XSS Security Testing Suite")
        self.log("INFO", "=" * 50)

        if not self.get_token():
            self.log("ERROR", "Failed to authenticate")
            return

        self.test_idea_xss()
        self.test_comment_xss()
        self.test_search_xss()

        # Save results
        results_file = Path(SCAN_DIR) / "xss-test-results.json"
        with open(results_file, "w") as f:
            json.dump(self.results, f, indent=2)

        self.log("INFO", f"Results saved to: {results_file}")


if __name__ == "__main__":
    tester = XSSTester()
    tester.run_all_tests()
