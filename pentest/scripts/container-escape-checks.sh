#!/bin/bash
# Container Escape Vector Analysis
# OpenCitiVibes Penetration Testing - Phase 5
#
# Checks for common container escape vectors and security misconfigurations.
# This script is READ-ONLY and does not attempt actual exploitation.

source /app/scripts/helpers/colors.sh 2>/dev/null || {
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
    log_info() { echo -e "[*] $1"; }
    log_success() { echo -e "${GREEN}[+]${NC} $1"; }
    log_warning() { echo -e "${YELLOW}[!]${NC} $1"; }
    log_error() { echo -e "${RED}[-]${NC} $1"; }
}

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
SOURCE_DIR="${SOURCE_DIR:-/app/source}"
mkdir -p "${SCAN_DIR}/exploits"

echo ""
log_info "Container Escape Vector Analysis"
log_info "================================="
echo ""

# Initialize report
REPORT="${SCAN_DIR}/exploits/container-escape-report.md"
FINDINGS=0

{
    echo "# Container Escape Vector Analysis"
    echo ""
    echo "**Date:** $(date)"
    echo "**Host:** $(hostname)"
    echo ""
    echo "---"
    echo ""
} > "${REPORT}"

# ============================================================================
# Check 1: Docker Socket Access
# ============================================================================

check_docker_socket() {
    log_info "[1/8] Checking Docker socket access..."

    {
        echo "## 1. Docker Socket Access"
        echo ""
    } >> "${REPORT}"

    if [ -S /var/run/docker.sock ]; then
        FINDINGS=$((FINDINGS + 1))
        {
            echo "**CRITICAL: Docker socket is mounted!**"
            echo ""
            echo "This allows complete escape from the container."
            echo ""
            echo "### Evidence"
            echo '```'
            ls -la /var/run/docker.sock
            echo '```'
            echo ""
            echo "### Proof of Concept (Dry Run)"
            echo '```bash'
            echo '# This would escape to host:'
            echo 'docker run -v /:/mnt --rm -it alpine chroot /mnt sh'
            echo '```'
            echo ""
            echo "### Remediation"
            echo "- Remove Docker socket mount from container"
            echo "- Use Docker-out-of-Docker pattern if Docker access needed"
            echo ""
        } >> "${REPORT}"
        log_error "CRITICAL: Docker socket mounted - escape possible!"
    else
        echo "Docker socket not accessible (good)" >> "${REPORT}"
        echo "" >> "${REPORT}"
        log_success "Docker socket not accessible"
    fi
}

# ============================================================================
# Check 2: Privileged Mode
# ============================================================================

check_privileged_mode() {
    log_info "[2/8] Checking privileged mode..."

    {
        echo "## 2. Privileged Mode"
        echo ""
    } >> "${REPORT}"

    # Check for privileged indicators
    PRIVILEGED=false

    # Check capabilities
    if command -v capsh &>/dev/null; then
        if capsh --print 2>/dev/null | grep -q "cap_sys_admin"; then
            PRIVILEGED=true
        fi
    fi

    # Check if we can access /dev/sda
    if [ -r /dev/sda ] 2>/dev/null; then
        PRIVILEGED=true
    fi

    # Check seccomp
    if grep -q "Seccomp:.*0" /proc/self/status 2>/dev/null; then
        PRIVILEGED=true
    fi

    if [ "$PRIVILEGED" = true ]; then
        FINDINGS=$((FINDINGS + 1))
        {
            echo "**CRITICAL: Container appears to be privileged!**"
            echo ""
            echo "### Capabilities"
            echo '```'
            if command -v capsh &>/dev/null; then
                capsh --print 2>/dev/null | grep -E "^Current|^Bounding"
            else
                cat /proc/self/status | grep Cap
            fi
            echo '```'
            echo ""
            echo "### Proof of Concept (Dry Run)"
            echo '```bash'
            echo '# Mount host filesystem:'
            echo 'mkdir /mnt/host && mount /dev/sda1 /mnt/host'
            echo '```'
            echo ""
            echo "### Remediation"
            echo "- Run container without --privileged flag"
            echo "- Use specific capabilities with --cap-add instead"
            echo ""
        } >> "${REPORT}"
        log_error "CRITICAL: Container is privileged"
    else
        echo "Container does not appear privileged (good)" >> "${REPORT}"
        echo "" >> "${REPORT}"
        log_success "Container not privileged"
    fi
}

# ============================================================================
# Check 3: Dangerous Capabilities
# ============================================================================

check_capabilities() {
    log_info "[3/8] Checking dangerous capabilities..."

    {
        echo "## 3. Dangerous Capabilities"
        echo ""
    } >> "${REPORT}"

    DANGEROUS_CAPS="CAP_SYS_ADMIN CAP_SYS_PTRACE CAP_NET_ADMIN CAP_DAC_OVERRIDE CAP_SETUID CAP_SETGID"
    FOUND_CAPS=""

    if command -v capsh &>/dev/null; then
        for cap in $DANGEROUS_CAPS; do
            if capsh --print 2>/dev/null | grep -q "$cap"; then
                FOUND_CAPS="${FOUND_CAPS}${cap} "
            fi
        done
    fi

    if [ -n "$FOUND_CAPS" ]; then
        FINDINGS=$((FINDINGS + 1))
        {
            echo "**HIGH: Dangerous capabilities detected**"
            echo ""
            echo "Found: \`${FOUND_CAPS}\`"
            echo ""
            echo "### All Capabilities"
            echo '```'
            if command -v capsh &>/dev/null; then
                capsh --print 2>/dev/null | grep -E "^Current|^Bounding"
            fi
            echo '```'
            echo ""
            echo "### Remediation"
            echo "- Remove unnecessary capabilities"
            echo "- Use --cap-drop=ALL and only add required capabilities"
            echo ""
        } >> "${REPORT}"
        log_warning "Dangerous capabilities found: ${FOUND_CAPS}"
    else
        echo "No dangerous capabilities found (good)" >> "${REPORT}"
        echo "" >> "${REPORT}"
        log_success "No dangerous capabilities"
    fi
}

# ============================================================================
# Check 4: SUID/SGID Binaries
# ============================================================================

check_suid_binaries() {
    log_info "[4/8] Checking SUID/SGID binaries..."

    {
        echo "## 4. SUID/SGID Binaries"
        echo ""
    } >> "${REPORT}"

    SUID_FILES=$(find / -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null | head -50)

    if [ -n "$SUID_FILES" ]; then
        {
            echo "### Found SUID/SGID Binaries"
            echo ""
            echo '```'
            echo "$SUID_FILES" | while read binary; do
                ls -la "$binary" 2>/dev/null
            done
            echo '```'
            echo ""
            echo "### GTFOBins Check"
            echo ""

            # Check for known exploitable binaries
            EXPLOITABLE=""
            for binary in python python3 perl ruby find vim nano less more nmap docker; do
                if echo "$SUID_FILES" | grep -q "/$binary$"; then
                    EXPLOITABLE="${EXPLOITABLE}${binary} "
                fi
            done

            if [ -n "$EXPLOITABLE" ]; then
                FINDINGS=$((FINDINGS + 1))
                echo "**HIGH: Potentially exploitable SUID binaries: ${EXPLOITABLE}**"
                echo ""
                echo "Check https://gtfobins.github.io/ for exploitation techniques"
            else
                echo "No commonly exploitable SUID binaries found"
            fi
            echo ""
        } >> "${REPORT}"
    else
        echo "No SUID/SGID binaries found" >> "${REPORT}"
        echo "" >> "${REPORT}"
    fi
    log_info "SUID/SGID check complete"
}

# ============================================================================
# Check 5: Compose File Analysis
# ============================================================================

check_compose_files() {
    log_info "[5/8] Analyzing Docker Compose files..."

    {
        echo "## 5. Docker Compose Security Analysis"
        echo ""
    } >> "${REPORT}"

    COMPOSE_FILES=$(find "${SOURCE_DIR}" -name "docker-compose*.yml" -o -name "docker-compose*.yaml" 2>/dev/null)

    if [ -n "$COMPOSE_FILES" ]; then
        for compose in $COMPOSE_FILES; do
            {
                echo "### $(basename $compose)"
                echo ""
            } >> "${REPORT}"

            # Check for docker.sock
            if grep -q "docker.sock" "$compose" 2>/dev/null; then
                FINDINGS=$((FINDINGS + 1))
                {
                    echo "**CRITICAL: Docker socket mounted**"
                    echo '```'
                    grep -n "docker.sock" "$compose"
                    echo '```'
                    echo ""
                } >> "${REPORT}"
            fi

            # Check for privileged
            if grep -q "privileged.*true" "$compose" 2>/dev/null; then
                FINDINGS=$((FINDINGS + 1))
                {
                    echo "**CRITICAL: Privileged mode enabled**"
                    echo '```'
                    grep -n "privileged" "$compose"
                    echo '```'
                    echo ""
                } >> "${REPORT}"
            fi

            # Check for dangerous cap_add
            if grep -q "cap_add" "$compose" 2>/dev/null; then
                for cap in SYS_ADMIN SYS_PTRACE NET_ADMIN; do
                    if grep -q "$cap" "$compose" 2>/dev/null; then
                        FINDINGS=$((FINDINGS + 1))
                        {
                            echo "**HIGH: Dangerous capability: ${cap}**"
                            echo '```'
                            grep -n "$cap" "$compose"
                            echo '```'
                            echo ""
                        } >> "${REPORT}"
                    fi
                done
            fi

            # Check for host network
            if grep -q "network_mode.*host" "$compose" 2>/dev/null; then
                FINDINGS=$((FINDINGS + 1))
                {
                    echo "**MEDIUM: Host network mode**"
                    echo '```'
                    grep -n "network_mode" "$compose"
                    echo '```'
                    echo ""
                } >> "${REPORT}"
            fi

            # Check for host PID
            if grep -q "pid.*host" "$compose" 2>/dev/null; then
                FINDINGS=$((FINDINGS + 1))
                {
                    echo "**HIGH: Host PID namespace**"
                    echo '```'
                    grep -n "pid" "$compose"
                    echo '```'
                    echo ""
                } >> "${REPORT}"
            fi
        done
    else
        echo "No Docker Compose files found in source directory" >> "${REPORT}"
        echo "" >> "${REPORT}"
    fi
}

# ============================================================================
# Check 6: Host Path Mounts
# ============================================================================

check_host_mounts() {
    log_info "[6/8] Checking host path mounts..."

    {
        echo "## 6. Host Path Mounts"
        echo ""
    } >> "${REPORT}"

    # Check mounted volumes
    MOUNTS=$(mount 2>/dev/null | grep -E "^/dev|type.*bind")

    if [ -n "$MOUNTS" ]; then
        {
            echo "### Current Mounts"
            echo '```'
            echo "$MOUNTS"
            echo '```'
            echo ""

            # Check for sensitive mounts
            for path in /etc /root /home /var/run; do
                if echo "$MOUNTS" | grep -q "$path"; then
                    FINDINGS=$((FINDINGS + 1))
                    echo "**MEDIUM: Sensitive host path mounted: ${path}**"
                    echo ""
                fi
            done
        } >> "${REPORT}"
    else
        echo "No significant host mounts detected" >> "${REPORT}"
        echo "" >> "${REPORT}"
    fi
}

# ============================================================================
# Check 7: Writable /proc or /sys
# ============================================================================

check_proc_sys() {
    log_info "[7/8] Checking /proc and /sys access..."

    {
        echo "## 7. Proc/Sys Access"
        echo ""
    } >> "${REPORT}"

    # Check if /proc/sys is writable
    if [ -w /proc/sys ] 2>/dev/null; then
        FINDINGS=$((FINDINGS + 1))
        {
            echo "**MEDIUM: /proc/sys is writable**"
            echo ""
            echo "This may allow kernel parameter modification"
            echo ""
        } >> "${REPORT}"
    fi

    # Check cgroups
    if [ -w /sys/fs/cgroup ] 2>/dev/null; then
        FINDINGS=$((FINDINGS + 1))
        {
            echo "**HIGH: cgroups writable - potential escape vector**"
            echo ""
            echo '```'
            ls -la /sys/fs/cgroup/ 2>/dev/null | head -10
            echo '```'
            echo ""
        } >> "${REPORT}"
    else
        echo "Standard /proc and /sys access (expected)" >> "${REPORT}"
        echo "" >> "${REPORT}"
    fi
}

# ============================================================================
# Check 8: Environment Variables with Secrets
# ============================================================================

check_env_secrets() {
    log_info "[8/8] Checking for secrets in environment..."

    {
        echo "## 8. Environment Variable Analysis"
        echo ""
    } >> "${REPORT}"

    # Look for potential secrets (redacted output)
    SECRET_VARS=$(env | grep -iE "password|secret|key|token|api" | sed 's/=.*/=***REDACTED***/')

    if [ -n "$SECRET_VARS" ]; then
        {
            echo "### Potentially Sensitive Variables"
            echo ""
            echo "The following environment variables may contain secrets:"
            echo '```'
            echo "$SECRET_VARS"
            echo '```'
            echo ""
            echo "### Remediation"
            echo "- Use Docker secrets or external secret management"
            echo "- Avoid passing secrets via environment variables"
            echo ""
        } >> "${REPORT}"
    else
        echo "No obviously sensitive environment variables detected" >> "${REPORT}"
        echo "" >> "${REPORT}"
    fi
}

# ============================================================================
# Generate Summary
# ============================================================================

generate_summary() {
    {
        echo "---"
        echo ""
        echo "## Summary"
        echo ""
        echo "**Total Findings:** ${FINDINGS}"
        echo ""

        if [ $FINDINGS -eq 0 ]; then
            echo "No container escape vectors detected. Container appears well-configured."
        elif [ $FINDINGS -le 2 ]; then
            echo "Some potential issues found. Review and address as appropriate."
        else
            echo "Multiple container security issues detected. Immediate review recommended."
        fi

        echo ""
        echo "---"
        echo ""
        echo "*Generated by OpenCitiVibes Container Security Scanner*"
    } >> "${REPORT}"
}

# ============================================================================
# Main
# ============================================================================

check_docker_socket
check_privileged_mode
check_capabilities
check_suid_binaries
check_compose_files
check_host_mounts
check_proc_sys
check_env_secrets
generate_summary

echo ""
log_success "Container Escape Analysis Complete!"
log_info "Findings: ${FINDINGS}"
log_info "Report: ${REPORT}"
echo ""

# Output the report
cat "${REPORT}"
