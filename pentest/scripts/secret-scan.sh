#!/bin/bash
# Secret Detection Scanning Script
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/secrets"

SOURCE_DIR="${SOURCE_DIR:-/app/source}"

log_info "Starting secret detection scan..."
log_info "Source directory: ${SOURCE_DIR}"

# Track findings
GITLEAKS_FINDINGS=0
TRUFFLEHOG_FINDINGS=0

# ============================================================================
# Gitleaks
# ============================================================================

log_info "============================================"
log_info "Running Gitleaks..."
log_info "============================================"

if command -v gitleaks &> /dev/null; then
    # Scan entire repository (including git history if available)
    if [ -d "${SOURCE_DIR}/.git" ]; then
        log_info "Scanning git repository with history..."
        gitleaks detect \
            --source="${SOURCE_DIR}" \
            --report-path="${SCAN_DIR}/secrets/gitleaks-git.json" \
            --report-format=json \
            --verbose 2>&1 | tee "${SCAN_DIR}/secrets/gitleaks-git.log"
    fi

    # Scan filesystem without git history
    log_info "Scanning filesystem (no git history)..."
    gitleaks detect \
        --source="${SOURCE_DIR}" \
        --report-path="${SCAN_DIR}/secrets/gitleaks.json" \
        --report-format=json \
        --no-git \
        --verbose 2>&1 | tee "${SCAN_DIR}/secrets/gitleaks.log"

    # Also generate CSV for easy review
    gitleaks detect \
        --source="${SOURCE_DIR}" \
        --report-path="${SCAN_DIR}/secrets/gitleaks.csv" \
        --report-format=csv \
        --no-git 2>/dev/null

    GITLEAKS_FINDINGS=$(jq 'length' "${SCAN_DIR}/secrets/gitleaks.json" 2>/dev/null || echo 0)
    log_info "Gitleaks findings: ${GITLEAKS_FINDINGS}"
else
    log_warning "Gitleaks not installed"
fi

# ============================================================================
# TruffleHog
# ============================================================================

log_info ""
log_info "============================================"
log_info "Running TruffleHog..."
log_info "============================================"

if command -v trufflehog &> /dev/null; then
    # Scan filesystem - verified secrets only
    log_info "Scanning for verified secrets..."
    trufflehog filesystem "${SOURCE_DIR}" \
        --json \
        --only-verified \
        2>/dev/null > "${SCAN_DIR}/secrets/trufflehog-verified.json"

    # Scan filesystem - all potential secrets
    log_info "Scanning for all potential secrets..."
    trufflehog filesystem "${SOURCE_DIR}" \
        --json \
        2>/dev/null > "${SCAN_DIR}/secrets/trufflehog-all.json"

    # If git repo, scan git history too
    if [ -d "${SOURCE_DIR}/.git" ]; then
        log_info "Scanning git history..."
        trufflehog git "file://${SOURCE_DIR}" \
            --json \
            2>/dev/null > "${SCAN_DIR}/secrets/trufflehog-git.json"
    fi

    TRUFFLEHOG_FINDINGS=$(wc -l < "${SCAN_DIR}/secrets/trufflehog-all.json" 2>/dev/null || echo 0)
    log_info "TruffleHog findings: ${TRUFFLEHOG_FINDINGS}"
else
    log_warning "TruffleHog not installed"
fi

# ============================================================================
# Custom Pattern Search
# ============================================================================

log_info ""
log_info "============================================"
log_info "Running custom pattern search..."
log_info "============================================"

{
    echo "# Custom Secret Pattern Search Results"
    echo "Date: $(date)"
    echo "Source: ${SOURCE_DIR}"
    echo ""
    echo "---"
    echo ""

    # API Keys patterns
    echo "## API Key Patterns"
    echo ""
    echo '```'
    grep -rn --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
        -E "(api[_-]?key|apikey|API_KEY)\s*[:=]\s*['\"][^'\"]+['\"]" \
        "${SOURCE_DIR}" 2>/dev/null | grep -v "node_modules" | grep -v ".venv" | grep -v "__pycache__" || echo "None found"
    echo '```'
    echo ""

    # JWT Secrets
    echo "## JWT Secret Patterns"
    echo ""
    echo '```'
    grep -rn --include="*.py" --include="*.env*" --include="*.yml" --include="*.yaml" \
        -E "(SECRET_KEY|JWT_SECRET|secret_key|jwt_secret)\s*[:=]\s*['\"][^'\"]+['\"]" \
        "${SOURCE_DIR}" 2>/dev/null | grep -v ".venv" || echo "None found"
    echo '```'
    echo ""

    # Database URLs/Connection Strings
    echo "## Database Connection Strings"
    echo ""
    echo '```'
    grep -rn --include="*.py" --include="*.env*" --include="*.yml" --include="*.yaml" --include="*.json" \
        -E "(postgres|mysql|mongodb|redis|sqlite)://[^[:space:]\"'<>]+" \
        "${SOURCE_DIR}" 2>/dev/null | grep -v ".venv" | grep -v "node_modules" || echo "None found"
    echo '```'
    echo ""

    # Private Keys
    echo "## Private Key Files"
    echo ""
    echo '```'
    find "${SOURCE_DIR}" -type f \( -name "*.pem" -o -name "*.key" -o -name "*.p12" -o -name "*.pfx" \) \
        2>/dev/null | grep -v ".venv" | grep -v "node_modules" || echo "None found"
    echo '```'
    echo ""

    echo "## Private Key Content"
    echo ""
    echo '```'
    grep -rln "-----BEGIN.*PRIVATE KEY-----" \
        "${SOURCE_DIR}" 2>/dev/null | grep -v ".venv" | grep -v "node_modules" || echo "None found"
    echo '```'
    echo ""

    # Hardcoded passwords (common patterns)
    echo "## Hardcoded Password Patterns"
    echo ""
    echo '```'
    grep -rn --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" \
        -E "(password|passwd|pwd)\s*[:=]\s*['\"][^'\"]{8,}['\"]" \
        "${SOURCE_DIR}" 2>/dev/null | \
        grep -v "node_modules" | \
        grep -v ".venv" | \
        grep -v "__pycache__" | \
        grep -v "test" | \
        grep -v "example" | \
        grep -v "placeholder" || echo "None found"
    echo '```'
    echo ""

    # AWS Credentials
    echo "## AWS Credential Patterns"
    echo ""
    echo '```'
    grep -rn --include="*.py" --include="*.ts" --include="*.env*" --include="*.yml" \
        -E "(AKIA[0-9A-Z]{16}|aws_access_key_id|aws_secret_access_key)" \
        "${SOURCE_DIR}" 2>/dev/null | grep -v ".venv" | grep -v "node_modules" || echo "None found"
    echo '```'
    echo ""

    # GitHub/GitLab Tokens
    echo "## GitHub/GitLab Token Patterns"
    echo ""
    echo '```'
    grep -rn --include="*.py" --include="*.ts" --include="*.env*" --include="*.yml" \
        -E "(ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}|github_pat_|glpat-)" \
        "${SOURCE_DIR}" 2>/dev/null | grep -v ".venv" | grep -v "node_modules" || echo "None found"
    echo '```'
    echo ""

    # Generic Tokens/Secrets
    echo "## Generic Token/Secret Patterns"
    echo ""
    echo '```'
    grep -rn --include="*.py" --include="*.ts" --include="*.tsx" --include="*.env*" \
        -iE "(token|secret|bearer)\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]" \
        "${SOURCE_DIR}" 2>/dev/null | \
        grep -v ".venv" | \
        grep -v "node_modules" | \
        grep -v "test" | \
        head -20 || echo "None found"
    echo '```'

} > "${SCAN_DIR}/secrets/custom-patterns.md"

# ============================================================================
# .env File Analysis
# ============================================================================

log_info "Analyzing .env files..."

{
    echo "# Environment File Analysis"
    echo "Date: $(date)"
    echo ""
    echo "---"
    echo ""

    find "${SOURCE_DIR}" -name ".env*" -type f \
        -not -path "*node_modules*" \
        -not -path "*.venv*" \
        -not -path "*__pycache__*" \
        2>/dev/null | while read envfile; do

        echo "## ${envfile}"
        echo ""

        # Check if file is in gitignore
        if [ -f "${SOURCE_DIR}/.gitignore" ]; then
            if grep -q "$(basename ${envfile})" "${SOURCE_DIR}/.gitignore" 2>/dev/null; then
                echo "Status: Listed in .gitignore (good)"
            else
                echo "**WARNING**: NOT in .gitignore - may be committed to repository!"
            fi
        fi
        echo ""

        echo "### Sensitive Variables Found:"
        echo ""
        grep -E "(SECRET|KEY|PASSWORD|TOKEN|CREDENTIAL|API_KEY|DATABASE_URL|DB_)" "${envfile}" 2>/dev/null | while read line; do
            # Mask the actual values
            varname=$(echo "${line}" | cut -d'=' -f1)
            echo "- \`${varname}=***REDACTED***\`"
        done
        echo ""

        echo "### All Variables (names only):"
        echo ""
        grep -v "^#" "${envfile}" 2>/dev/null | grep -v "^$" | cut -d'=' -f1 | while read var; do
            echo "- ${var}"
        done
        echo ""
        echo "---"
        echo ""
    done

} > "${SCAN_DIR}/secrets/env-analysis.md"

# ============================================================================
# Git History Secret Check
# ============================================================================

if [ -d "${SOURCE_DIR}/.git" ]; then
    log_info "Checking for secrets in git history..."

    {
        echo "# Git History Secret Analysis"
        echo "Date: $(date)"
        echo ""

        echo "## Recently Modified Sensitive Files"
        echo ""
        git -C "${SOURCE_DIR}" log --all --full-history --oneline -- "*.env" "*.pem" "*.key" "*secret*" "*credential*" 2>/dev/null | head -20 || echo "None found"
        echo ""

        echo "## Deleted Files That May Have Contained Secrets"
        echo ""
        git -C "${SOURCE_DIR}" log --all --full-history --diff-filter=D --oneline -- "*.env" "*.pem" "*.key" 2>/dev/null | head -20 || echo "None found"

    } > "${SCAN_DIR}/secrets/git-history-analysis.md"
fi

# ============================================================================
# Summary
# ============================================================================

log_success "Secret detection scan complete!"

echo ""
log_info "Summary:"
echo "  Gitleaks findings: ${GITLEAKS_FINDINGS}"
echo "  TruffleHog findings: ${TRUFFLEHOG_FINDINGS}"
echo ""

if [ "${GITLEAKS_FINDINGS}" -gt 0 ] || [ "${TRUFFLEHOG_FINDINGS}" -gt 0 ]; then
    log_warning "Potential secrets detected! Review the detailed reports."
fi

# Generate summary file
{
    echo "# Secret Detection Scan Summary"
    echo "Date: $(date)"
    echo "Source: ${SOURCE_DIR}"
    echo ""
    echo "## Findings"
    echo ""
    echo "| Scanner | Findings |"
    echo "|---------|----------|"
    echo "| Gitleaks | ${GITLEAKS_FINDINGS} |"
    echo "| TruffleHog | ${TRUFFLEHOG_FINDINGS} |"
    echo ""

    if [ "${GITLEAKS_FINDINGS}" -gt 0 ] && [ -f "${SCAN_DIR}/secrets/gitleaks.json" ]; then
        echo "## Gitleaks Top Findings"
        echo ""
        jq -r '.[] | "- **\(.RuleID)**: \(.File):\(.StartLine) - \(.Description)"' \
            "${SCAN_DIR}/secrets/gitleaks.json" 2>/dev/null | head -10
        echo ""
    fi

    echo "## Reports Generated"
    echo ""
    ls -la "${SCAN_DIR}/secrets/" | while read line; do
        echo "- ${line}"
    done

} > "${SCAN_DIR}/secrets/SUMMARY.md"

cat "${SCAN_DIR}/secrets/SUMMARY.md"

echo ""
log_info "Full results in: ${SCAN_DIR}/secrets/"
ls -la "${SCAN_DIR}/secrets/"
