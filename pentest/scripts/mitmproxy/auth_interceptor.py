"""
mitmproxy script to automatically inject authentication tokens
and log interesting requests for OpenCitiVibes testing.
"""

import json
import os
from datetime import datetime
from mitmproxy import http, ctx

# Load configuration
AUTH_TOKEN = os.environ.get("AUTH_TOKEN", "")
LOG_DIR = os.environ.get("SCAN_DIR", "/app/results")


class AuthInterceptor:
    def __init__(self):
        self.token = AUTH_TOKEN
        self.interesting_endpoints = [
            "/api/admin/",
            "/api/auth/",
            "/api/ideas/",
            "/api/comments/",
            "/api/flags/",
            "/api/moderation/",
        ]
        self.log_file = open(f"{LOG_DIR}/proxy/requests.jsonl", "a")

    def request(self, flow: http.HTTPFlow) -> None:
        """Intercept and modify requests."""
        # Inject auth token if not present
        if self.token and "Authorization" not in flow.request.headers:
            flow.request.headers["Authorization"] = f"Bearer {self.token}"
            ctx.log.info(f"Injected auth token into {flow.request.path}")

        # Log interesting requests
        if any(ep in flow.request.path for ep in self.interesting_endpoints):
            self._log_request(flow)

    def response(self, flow: http.HTTPFlow) -> None:
        """Intercept and analyze responses."""
        # Log authentication failures
        if flow.response.status_code == 401:
            ctx.log.warn(f"Auth failure: {flow.request.method} {flow.request.path}")

        # Log server errors
        if flow.response.status_code >= 500:
            ctx.log.error(f"Server error: {flow.request.method} {flow.request.path}")
            self._log_request(flow, include_response=True)

        # Check for sensitive data in response
        self._check_sensitive_data(flow)

    def _log_request(self, flow: http.HTTPFlow, include_response: bool = False) -> None:
        """Log request details to file."""
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "method": flow.request.method,
            "url": flow.request.pretty_url,
            "headers": dict(flow.request.headers),
            "body": flow.request.get_text()[:1000] if flow.request.content else None,
        }

        if include_response and flow.response:
            log_entry["response"] = {
                "status": flow.response.status_code,
                "headers": dict(flow.response.headers),
                "body": flow.response.get_text()[:1000] if flow.response.content else None,
            }

        self.log_file.write(json.dumps(log_entry) + "\n")
        self.log_file.flush()

    def _check_sensitive_data(self, flow: http.HTTPFlow) -> None:
        """Check for sensitive data exposure in responses."""
        if not flow.response or not flow.response.content:
            return

        content = flow.response.get_text().lower()

        sensitive_patterns = [
            "password",
            "secret_key",
            "private_key",
            "api_key",
            "access_token",
            "hashed_password",
        ]

        for pattern in sensitive_patterns:
            if pattern in content:
                ctx.log.warn(
                    f"Potential sensitive data '{pattern}' in response: "
                    f"{flow.request.path}"
                )


addons = [AuthInterceptor()]
