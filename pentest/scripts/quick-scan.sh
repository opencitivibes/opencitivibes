#!/bin/bash
# Quick vulnerability scan

source /app/scripts/helpers/colors.sh
print_banner

TARGET_API="${TARGET_API:-http://backend:8000/api}"
SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/scans"

log_info "Starting quick vulnerability scan..."

# 1. Nuclei scan with common templates
log_info "Running Nuclei with common templates..."
nuclei -u "${TARGET_API}" \
    -t cves/ \
    -t vulnerabilities/ \
    -t exposures/ \
    -t misconfiguration/ \
    -severity critical,high,medium \
    -o "${SCAN_DIR}/scans/nuclei-quick.txt" \
    -silent

# 2. Nikto scan
log_info "Running Nikto..."
nikto -h "${TARGET_API}/../" \
    -o "${SCAN_DIR}/scans/nikto.txt" \
    -Format txt \
    -Tuning x6 \
    -timeout 5 2>/dev/null

# 3. SSL/TLS scan (if HTTPS)
if [[ "${TARGET_API}" == https* ]]; then
    log_info "Running SSL scan..."
    testssl.sh --jsonfile "${SCAN_DIR}/scans/ssl.json" "${TARGET_API}" 2>/dev/null
fi

# 4. Summary
log_success "Quick scan complete!"
log_info "Results in: ${SCAN_DIR}/scans/"

# Parse and display critical findings
echo ""
log_info "Critical/High findings from Nuclei:"
grep -E "critical|high" "${SCAN_DIR}/scans/nuclei-quick.txt" 2>/dev/null || echo "  No critical/high findings"
