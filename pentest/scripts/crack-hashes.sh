#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/cracking"

log_info "Password Cracking Suite"

# ============================================================================
# Extract hashes from database (if accessible)
# ============================================================================

if [ -f "/app/data/opencitivibes.db" ] || [ -f "/app/data/idees_montreal.db" ]; then
    log_info "Extracting password hashes from database..."

    DB_FILE=$(ls /app/data/*.db 2>/dev/null | head -1)

    sqlite3 "${DB_FILE}" "SELECT email, hashed_password FROM users;" 2>/dev/null | \
        while IFS='|' read -r email hash; do
            echo "${email}:${hash}" >> "${SCAN_DIR}/cracking/user_hashes.txt"
        done

    log_success "Extracted hashes to ${SCAN_DIR}/cracking/user_hashes.txt"
fi

# ============================================================================
# Identify hash type
# ============================================================================

if [ -f "${SCAN_DIR}/cracking/user_hashes.txt" ]; then
    log_info "Identifying hash types..."

    # Check first hash
    SAMPLE_HASH=$(head -1 "${SCAN_DIR}/cracking/user_hashes.txt" | cut -d: -f2)

    if [[ "${SAMPLE_HASH}" == \$2* ]]; then
        log_info "Hash type: bcrypt"
        HASH_TYPE="3200"  # Hashcat mode for bcrypt
    elif [[ "${SAMPLE_HASH}" == \$argon2* ]]; then
        log_info "Hash type: Argon2"
        HASH_TYPE="13730"  # Hashcat mode for Argon2
    else
        log_warning "Unknown hash type, attempting auto-detection"
        HASH_TYPE="0"
    fi
fi

# ============================================================================
# John the Ripper
# ============================================================================

log_info "Running John the Ripper..."

if [ -f "${SCAN_DIR}/cracking/user_hashes.txt" ]; then
    # Extract just hashes for John
    cut -d: -f2 "${SCAN_DIR}/cracking/user_hashes.txt" > "${SCAN_DIR}/cracking/hashes_only.txt"

    # Run with common wordlist
    john --wordlist=/usr/share/wordlists/rockyou.txt \
        --format=bcrypt \
        "${SCAN_DIR}/cracking/hashes_only.txt" \
        2>&1 | tee "${SCAN_DIR}/cracking/john.log"

    # Show cracked passwords
    john --show "${SCAN_DIR}/cracking/hashes_only.txt" > "${SCAN_DIR}/cracking/john-cracked.txt"
fi

# ============================================================================
# Hashcat (GPU-accelerated if available)
# ============================================================================

log_info "Running Hashcat..."

if [ -f "${SCAN_DIR}/cracking/hashes_only.txt" ]; then
    # Hashcat with rules
    hashcat -m ${HASH_TYPE} \
        -a 0 \
        "${SCAN_DIR}/cracking/hashes_only.txt" \
        /usr/share/wordlists/rockyou.txt \
        -r /usr/share/hashcat/rules/best64.rule \
        -o "${SCAN_DIR}/cracking/hashcat-cracked.txt" \
        --force \
        2>&1 | tee "${SCAN_DIR}/cracking/hashcat.log" || true

    # Show results
    if [ -f "${SCAN_DIR}/cracking/hashcat-cracked.txt" ]; then
        log_success "Cracked passwords:"
        cat "${SCAN_DIR}/cracking/hashcat-cracked.txt"
    fi
fi

# ============================================================================
# Summary
# ============================================================================

log_success "Password cracking complete!"
log_info "Results in ${SCAN_DIR}/cracking/"
