#!/bin/bash
source /app/scripts/helpers/colors.sh

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/proxy"

log_info "Starting mitmproxy..."
log_info "Web interface: http://localhost:8082"
log_info "Proxy port: 8081"

# Get auth token if credentials are set
if [ -n "${ADMIN_EMAIL}" ] && [ -n "${ADMIN_PASSWORD}" ]; then
    log_info "Obtaining authentication token..."
    export AUTH_TOKEN=$(curl -s -X POST "http://backend:8000/api/auth/login" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=${ADMIN_EMAIL}&password=${ADMIN_PASSWORD}" | jq -r '.access_token')

    if [ -n "${AUTH_TOKEN}" ] && [ "${AUTH_TOKEN}" != "null" ]; then
        log_success "Token obtained successfully"
    else
        log_warning "Failed to obtain token, continuing without auto-auth"
    fi
fi

export SCAN_DIR

mitmproxy \
    --listen-host 0.0.0.0 \
    --listen-port 8081 \
    --web-host 0.0.0.0 \
    --web-port 8082 \
    --ssl-insecure \
    -s /app/scripts/mitmproxy/auth_interceptor.py
