#!/bin/bash
# Nuclei Vulnerability Scanner Automation Script
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/nuclei"

TARGET="${TARGET_API:-http://backend:8000}"

log_info "Starting Nuclei vulnerability scan..."
log_info "Target: ${TARGET}"

SCAN_TYPE="${1:-standard}"

case $SCAN_TYPE in
    "quick")
        log_info "Running quick scan (critical/high only)..."
        nuclei -u "${TARGET}" \
            -severity critical,high \
            -o "${SCAN_DIR}/nuclei/quick-scan.txt" \
            -je "${SCAN_DIR}/nuclei/quick-scan.json" \
            -silent \
            -rate-limit 100
        ;;
    "standard")
        log_info "Running standard scan..."
        nuclei -u "${TARGET}" \
            -t cves/ \
            -t vulnerabilities/ \
            -t exposures/ \
            -t misconfiguration/ \
            -t /app/nuclei-templates/opencitivibes/ \
            -severity critical,high,medium \
            -o "${SCAN_DIR}/nuclei/standard-scan.txt" \
            -je "${SCAN_DIR}/nuclei/standard-scan.json" \
            -rate-limit 50
        ;;
    "full")
        log_info "Running full scan (all templates)..."
        nuclei -u "${TARGET}" \
            -t /app/nuclei-templates/ \
            -o "${SCAN_DIR}/nuclei/full-scan.txt" \
            -je "${SCAN_DIR}/nuclei/full-scan.json" \
            -rate-limit 30
        ;;
    "custom")
        log_info "Running custom OpenCitiVibes templates only..."
        nuclei -u "${TARGET}" \
            -t /app/nuclei-templates/opencitivibes/ \
            -o "${SCAN_DIR}/nuclei/custom-scan.txt" \
            -je "${SCAN_DIR}/nuclei/custom-scan.json" \
            -v
        ;;
    "api")
        log_info "Running API-focused scan..."
        # Build target list from OpenAPI if available
        OPENAPI_URL="${TARGET}/openapi.json"

        if curl -sf "${OPENAPI_URL}" > /tmp/openapi.json 2>/dev/null; then
            log_info "Found OpenAPI spec, extracting endpoints..."
            jq -r '.paths | keys[]' /tmp/openapi.json | while read endpoint; do
                echo "${TARGET}${endpoint}"
            done > /tmp/api-targets.txt

            nuclei -l /tmp/api-targets.txt \
                -t /app/nuclei-templates/opencitivibes/ \
                -t exposures/apis/ \
                -t vulnerabilities/generic/ \
                -o "${SCAN_DIR}/nuclei/api-scan.txt" \
                -je "${SCAN_DIR}/nuclei/api-scan.json" \
                -rate-limit 50
        else
            log_warning "No OpenAPI spec found, running generic API scan..."
            nuclei -u "${TARGET}" \
                -t /app/nuclei-templates/opencitivibes/ \
                -t exposures/apis/ \
                -o "${SCAN_DIR}/nuclei/api-scan.txt" \
                -je "${SCAN_DIR}/nuclei/api-scan.json" \
                -rate-limit 50
        fi
        ;;
    "jwt")
        log_info "Running JWT-focused scan..."
        nuclei -u "${TARGET}" \
            -t /app/nuclei-templates/opencitivibes/jwt-algo-confusion.yaml \
            -t http/vulnerabilities/generic/jwt/ \
            -o "${SCAN_DIR}/nuclei/jwt-scan.txt" \
            -je "${SCAN_DIR}/nuclei/jwt-scan.json" \
            -v
        ;;
    "auth")
        log_info "Running authentication-focused scan..."
        nuclei -u "${TARGET}" \
            -t /app/nuclei-templates/opencitivibes/admin-access.yaml \
            -t /app/nuclei-templates/opencitivibes/idor-ideas.yaml \
            -t /app/nuclei-templates/opencitivibes/rate-limit-bypass.yaml \
            -o "${SCAN_DIR}/nuclei/auth-scan.txt" \
            -je "${SCAN_DIR}/nuclei/auth-scan.json" \
            -v
        ;;
    "seeded")
        log_info "Running scan with seed URLs..."
        URLS_FILE="${2:-${SCAN_DIR}/recon/normalized-urls.txt}"

        if [ ! -f "${URLS_FILE}" ]; then
            log_error "URLs file not found: ${URLS_FILE}"
            log_info "Run recon.sh or webapp-full-test.sh first to discover URLs"
            exit 1
        fi

        URL_COUNT=$(wc -l < "${URLS_FILE}")
        log_info "Scanning ${URL_COUNT} URLs from ${URLS_FILE}"

        nuclei -l "${URLS_FILE}" \
            -t /app/nuclei-templates/opencitivibes/ \
            -t cves/ \
            -t vulnerabilities/ \
            -severity critical,high,medium \
            -o "${SCAN_DIR}/nuclei/seeded-scan.txt" \
            -je "${SCAN_DIR}/nuclei/seeded-scan.json" \
            -rate-limit 30 \
            -concurrency 10
        ;;
    *)
        log_error "Unknown scan type: $SCAN_TYPE"
        echo ""
        echo "Usage: $0 [quick|standard|full|custom|api|jwt|auth|seeded <urls_file>]"
        echo ""
        echo "Scan types:"
        echo "  quick    - Critical/High severity only (fast)"
        echo "  standard - Standard scan with custom templates (default)"
        echo "  full     - Full scan with all templates (slow)"
        echo "  custom   - OpenCitiVibes custom templates only"
        echo "  api      - API-focused scan using OpenAPI spec"
        echo "  jwt      - JWT vulnerability focused scan"
        echo "  auth     - Authentication/authorization focused scan"
        echo "  seeded   - Scan pre-discovered URLs from file"
        exit 1
        ;;
esac

# Summary
log_success "Nuclei scan complete!"

# Count findings from JSON output
if ls "${SCAN_DIR}/nuclei/"*.json 1> /dev/null 2>&1; then
    echo ""
    log_info "Findings Summary:"

    for jsonfile in "${SCAN_DIR}/nuclei/"*.json; do
        if [ -f "${jsonfile}" ] && [ -s "${jsonfile}" ]; then
            CRITICAL=$(grep -c '"severity":"critical"' "${jsonfile}" 2>/dev/null || echo 0)
            HIGH=$(grep -c '"severity":"high"' "${jsonfile}" 2>/dev/null || echo 0)
            MEDIUM=$(grep -c '"severity":"medium"' "${jsonfile}" 2>/dev/null || echo 0)
            LOW=$(grep -c '"severity":"low"' "${jsonfile}" 2>/dev/null || echo 0)
            INFO=$(grep -c '"severity":"info"' "${jsonfile}" 2>/dev/null || echo 0)

            echo ""
            echo "  $(basename ${jsonfile}):"
            [ "${CRITICAL}" -gt 0 ] && echo -e "    ${RED}Critical: ${CRITICAL}${NC}"
            [ "${HIGH}" -gt 0 ] && echo -e "    ${YELLOW}High: ${HIGH}${NC}"
            [ "${MEDIUM}" -gt 0 ] && echo "    Medium: ${MEDIUM}"
            [ "${LOW}" -gt 0 ] && echo "    Low: ${LOW}"
            [ "${INFO}" -gt 0 ] && echo "    Info: ${INFO}"
        fi
    done
fi

echo ""
log_info "Results saved to: ${SCAN_DIR}/nuclei/"
ls -la "${SCAN_DIR}/nuclei/"
