#!/bin/bash
# Unified CVE Scanning with SBOM Generation and KEV Correlation
# OpenCitiVibes Penetration Testing - Phase 5.5
#
# This script orchestrates:
# 1. SBOM generation (Syft/Trivy)
# 2. Vulnerability scanning (Trivy/Grype)
# 3. OSV.dev correlation
# 4. CISA KEV correlation
# 5. Unified report generation

source /app/scripts/helpers/colors.sh 2>/dev/null || {
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
    log_info() { echo -e "${BLUE}[*]${NC} $1"; }
    log_success() { echo -e "${GREEN}[+]${NC} $1"; }
    log_warning() { echo -e "${YELLOW}[!]${NC} $1"; }
    log_error() { echo -e "${RED}[-]${NC} $1"; }
}

# Configuration
SCAN_ID="${SCAN_ID:-$(date +%Y%m%d_%H%M%S)}"
SCAN_DIR="${SCAN_DIR:-/app/results/${SCAN_ID}}"
SOURCE_DIR="${SOURCE_DIR:-/app/source}"

mkdir -p "${SCAN_DIR}/cve" "${SCAN_DIR}/sbom"

echo ""
log_info "=============================================="
log_info "  Unified CVE Scanning Pipeline"
log_info "  Scan ID: ${SCAN_ID}"
log_info "=============================================="
echo ""

START_TIME=$(date +%s)
CRITICAL_COUNT=0
HIGH_COUNT=0
KEV_COUNT=0

# ============================================================================
# Phase 1: Generate SBOMs
# ============================================================================

generate_sboms() {
    log_info "[1/5] Generating SBOMs..."

    # Backend SBOM
    if [ -d "${SOURCE_DIR}/backend" ]; then
        log_info "  Generating backend SBOM..."
        if command -v syft &> /dev/null; then
            syft dir:"${SOURCE_DIR}/backend" \
                -o cyclonedx-json="${SCAN_DIR}/sbom/sbom-backend.json" \
                -o spdx-json="${SCAN_DIR}/sbom/sbom-backend-spdx.json" \
                2>/dev/null
            log_success "  Backend SBOM: ${SCAN_DIR}/sbom/sbom-backend.json"
        else
            trivy fs "${SOURCE_DIR}/backend" \
                --format cyclonedx \
                --output "${SCAN_DIR}/sbom/sbom-backend.json" \
                2>/dev/null
            log_success "  Backend SBOM (Trivy): ${SCAN_DIR}/sbom/sbom-backend.json"
        fi
    fi

    # Frontend SBOM
    if [ -d "${SOURCE_DIR}/frontend" ]; then
        log_info "  Generating frontend SBOM..."
        if command -v syft &> /dev/null; then
            syft dir:"${SOURCE_DIR}/frontend" \
                -o cyclonedx-json="${SCAN_DIR}/sbom/sbom-frontend.json" \
                -o spdx-json="${SCAN_DIR}/sbom/sbom-frontend-spdx.json" \
                2>/dev/null
            log_success "  Frontend SBOM: ${SCAN_DIR}/sbom/sbom-frontend.json"
        else
            trivy fs "${SOURCE_DIR}/frontend" \
                --format cyclonedx \
                --output "${SCAN_DIR}/sbom/sbom-frontend.json" \
                2>/dev/null
            log_success "  Frontend SBOM (Trivy): ${SCAN_DIR}/sbom/sbom-frontend.json"
        fi
    fi
}

# ============================================================================
# Phase 2: Trivy Vulnerability Scanning
# ============================================================================

scan_with_trivy() {
    log_info "[2/5] Scanning with Trivy..."

    # Backend
    if [ -d "${SOURCE_DIR}/backend" ]; then
        trivy fs "${SOURCE_DIR}/backend" \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output "${SCAN_DIR}/cve/trivy-backend.json" \
            2>/dev/null

        # Count findings
        if [ -f "${SCAN_DIR}/cve/trivy-backend.json" ]; then
            BACKEND_CRITICAL=$(cat "${SCAN_DIR}/cve/trivy-backend.json" | \
                jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' 2>/dev/null || echo 0)
            BACKEND_HIGH=$(cat "${SCAN_DIR}/cve/trivy-backend.json" | \
                jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' 2>/dev/null || echo 0)
            CRITICAL_COUNT=$((CRITICAL_COUNT + BACKEND_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + BACKEND_HIGH))
            log_success "  Backend: ${BACKEND_CRITICAL} critical, ${BACKEND_HIGH} high"
        fi
    fi

    # Frontend
    if [ -d "${SOURCE_DIR}/frontend" ]; then
        trivy fs "${SOURCE_DIR}/frontend" \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output "${SCAN_DIR}/cve/trivy-frontend.json" \
            2>/dev/null

        if [ -f "${SCAN_DIR}/cve/trivy-frontend.json" ]; then
            FRONTEND_CRITICAL=$(cat "${SCAN_DIR}/cve/trivy-frontend.json" | \
                jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' 2>/dev/null || echo 0)
            FRONTEND_HIGH=$(cat "${SCAN_DIR}/cve/trivy-frontend.json" | \
                jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' 2>/dev/null || echo 0)
            CRITICAL_COUNT=$((CRITICAL_COUNT + FRONTEND_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + FRONTEND_HIGH))
            log_success "  Frontend: ${FRONTEND_CRITICAL} critical, ${FRONTEND_HIGH} high"
        fi
    fi
}

# ============================================================================
# Phase 3: Grype Cross-validation
# ============================================================================

scan_with_grype() {
    log_info "[3/5] Cross-validating with Grype..."

    if ! command -v grype &> /dev/null; then
        log_warning "  Grype not installed, skipping..."
        return
    fi

    # Scan SBOMs with Grype for cross-validation
    for sbom in "${SCAN_DIR}"/sbom/sbom-*.json; do
        if [ -f "$sbom" ] && [[ ! "$sbom" == *"-spdx.json" ]]; then
            name=$(basename "$sbom" .json)
            grype sbom:"$sbom" \
                --output json \
                --file "${SCAN_DIR}/cve/grype-${name}.json" \
                2>/dev/null
            log_success "  Grype scan: ${name}"
        fi
    done
}

# ============================================================================
# Phase 4: OSV Correlation
# ============================================================================

correlate_osv() {
    log_info "[4/5] OSV.dev correlation..."

    if [ -f "/app/scripts/cve/sbom_correlate.py" ]; then
        python3 /app/scripts/cve/sbom_correlate.py \
            --sbom-dir "${SCAN_DIR}/sbom" \
            --output "${SCAN_DIR}/cve/osv-findings.json" \
            2>/dev/null || true

        if [ -f "${SCAN_DIR}/cve/osv-findings.json" ]; then
            OSV_COUNT=$(cat "${SCAN_DIR}/cve/osv-findings.json" | jq '. | length' 2>/dev/null || echo 0)
            log_success "  OSV findings: ${OSV_COUNT}"
        fi
    else
        log_warning "  OSV correlator not found, skipping..."
    fi
}

# ============================================================================
# Phase 5: KEV Correlation
# ============================================================================

correlate_kev() {
    log_info "[5/5] CISA KEV correlation..."

    if [ -f "/app/scripts/cve/kev_correlate.py" ]; then
        python3 /app/scripts/cve/kev_correlate.py \
            --scan-dir "${SCAN_DIR}/cve" \
            --json > "${SCAN_DIR}/cve/kev-correlation.json" \
            2>/dev/null || true

        if [ -f "${SCAN_DIR}/cve/kev-correlation.json" ]; then
            KEV_COUNT=$(cat "${SCAN_DIR}/cve/kev-correlation.json" | jq '.kev_matches' 2>/dev/null || echo 0)
            if [ "$KEV_COUNT" -gt 0 ]; then
                log_error "  KEV matches found: ${KEV_COUNT} (ACTIVELY EXPLOITED!)"
            else
                log_success "  No KEV matches (good)"
            fi
        fi
    else
        log_warning "  KEV correlator not found, skipping..."
    fi
}

# ============================================================================
# Generate Summary
# ============================================================================

generate_summary() {
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))

    SUMMARY_FILE="${SCAN_DIR}/cve/SUMMARY.json"

    cat > "${SUMMARY_FILE}" << EOF
{
    "scan_id": "${SCAN_ID}",
    "timestamp": "$(date -Iseconds)",
    "duration_seconds": ${DURATION},
    "findings": {
        "critical": ${CRITICAL_COUNT},
        "high": ${HIGH_COUNT},
        "kev_matches": ${KEV_COUNT}
    },
    "artifacts": {
        "sboms": $(find "${SCAN_DIR}/sbom" -name "*.json" 2>/dev/null | wc -l),
        "scan_results": $(find "${SCAN_DIR}/cve" -name "*.json" 2>/dev/null | wc -l)
    },
    "exit_code": $([ ${CRITICAL_COUNT} -gt 0 ] && echo 2 || ([ ${HIGH_COUNT} -gt 5 ] && echo 1 || echo 0))
}
EOF

    echo ""
    log_info "=============================================="
    log_info "  CVE Scan Summary"
    log_info "=============================================="
    echo ""
    log_info "Duration: ${DURATION} seconds"
    log_info "SBOMs generated: $(find "${SCAN_DIR}/sbom" -name "*.json" 2>/dev/null | wc -l)"
    echo ""

    if [ ${CRITICAL_COUNT} -gt 0 ]; then
        log_error "CRITICAL: ${CRITICAL_COUNT}"
    else
        log_success "CRITICAL: 0"
    fi

    if [ ${HIGH_COUNT} -gt 0 ]; then
        log_warning "HIGH: ${HIGH_COUNT}"
    else
        log_success "HIGH: 0"
    fi

    if [ ${KEV_COUNT} -gt 0 ]; then
        log_error "KEV MATCHES: ${KEV_COUNT} (Actively exploited!)"
    fi

    echo ""
    log_info "Results: ${SCAN_DIR}/cve/"
    log_info "Summary: ${SUMMARY_FILE}"
    echo ""
}

# ============================================================================
# Main
# ============================================================================

main() {
    generate_sboms
    scan_with_trivy
    scan_with_grype
    correlate_osv
    correlate_kev
    generate_summary

    # Exit with appropriate code for CI
    if [ ${KEV_COUNT} -gt 0 ] || [ ${CRITICAL_COUNT} -gt 0 ]; then
        exit 2
    elif [ ${HIGH_COUNT} -gt 5 ]; then
        exit 1
    else
        exit 0
    fi
}

main "$@"
