#!/bin/bash
# Dependency Vulnerability Audit Script
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/dependencies"

SOURCE_DIR="${SOURCE_DIR:-/app/source}"

log_info "Starting dependency vulnerability audit..."
log_info "Source directory: ${SOURCE_DIR}"

# Track overall vulnerability counts
PYTHON_VULNS=0
NODE_VULNS=0
EXIT_CODE=0

# ============================================================================
# Python Dependencies (Backend)
# ============================================================================

log_info "============================================"
log_info "Scanning Python dependencies..."
log_info "============================================"

BACKEND_DIR="${SOURCE_DIR}/backend"

if [ -d "${BACKEND_DIR}" ]; then
    cd "${BACKEND_DIR}"

    # pip-audit scan - must use -r flag to scan APPLICATION requirements, not pentest container
    log_info "Running pip-audit on backend dependencies..."
    if command -v pip-audit &> /dev/null; then
        # Generate requirements from pyproject.toml using uv if available in source
        if [ -f "pyproject.toml" ]; then
            # Extract dependencies from pyproject.toml and create requirements file
            log_info "Extracting dependencies from pyproject.toml..."
            python3 -c "
import tomllib
with open('pyproject.toml', 'rb') as f:
    data = tomllib.load(f)
deps = data.get('project', {}).get('dependencies', [])
for dep in deps:
    print(dep)
" > /tmp/backend-requirements.txt 2>/dev/null || true

            if [ -s /tmp/backend-requirements.txt ]; then
                pip-audit -r /tmp/backend-requirements.txt \
                    --format json \
                    --output "${SCAN_DIR}/dependencies/pip-audit.json" 2>/dev/null || true

                pip-audit -r /tmp/backend-requirements.txt \
                    --format columns \
                    2>&1 | tee "${SCAN_DIR}/dependencies/pip-audit.txt" || true
            fi
        fi

        # Also try with requirements.txt if exists
        if [ -f "requirements.txt" ]; then
            pip-audit -r requirements.txt \
                --format json \
                --output "${SCAN_DIR}/dependencies/pip-audit-requirements.json" 2>/dev/null || true
        fi

        # Check uv.lock if exists (more accurate)
        if [ -f "uv.lock" ]; then
            log_info "Found uv.lock - extracting locked dependencies..."
            # uv export to requirements format
            if command -v uv &> /dev/null; then
                uv export --no-hashes --format requirements-txt > /tmp/backend-locked.txt 2>/dev/null || true
                if [ -s /tmp/backend-locked.txt ]; then
                    pip-audit -r /tmp/backend-locked.txt \
                        --format json \
                        --output "${SCAN_DIR}/dependencies/pip-audit-locked.json" 2>/dev/null || true
                fi
            fi
        fi

        PYTHON_VULNS=$(jq 'length' "${SCAN_DIR}/dependencies/pip-audit.json" 2>/dev/null || echo 0)
    else
        log_warning "pip-audit not installed"
    fi

    # safety scan - scan APPLICATION requirements
    # Use policy file to report unpinned vulnerabilities (not ignore them)
    log_info "Running safety scan on backend dependencies..."
    SAFETY_POLICY="/app/config/safety-policy.yml"
    if command -v safety &> /dev/null; then
        if [ -s /tmp/backend-requirements.txt ]; then
            safety scan --target /tmp/backend-requirements.txt \
                --policy-file "${SAFETY_POLICY}" \
                --output json \
                > "${SCAN_DIR}/dependencies/safety.json" 2>/dev/null || true

            safety scan --target /tmp/backend-requirements.txt \
                --policy-file "${SAFETY_POLICY}" \
                --detailed-output \
                2>&1 | tee "${SCAN_DIR}/dependencies/safety.txt" || true
        fi
    else
        log_warning "safety not installed"
    fi

    # Bandit for security issues in Python code
    log_info "Running Bandit security linter..."
    if command -v bandit &> /dev/null; then
        bandit -r . \
            -f json \
            -o "${SCAN_DIR}/dependencies/bandit.json" \
            --exclude .venv,venv,tests,__pycache__ 2>/dev/null || true

        bandit -r . \
            -f txt \
            --exclude .venv,venv,tests,__pycache__ \
            2>&1 | tee "${SCAN_DIR}/dependencies/bandit.txt" || true
    else
        log_warning "bandit not installed"
    fi

    log_info "Python vulnerabilities found: ${PYTHON_VULNS}"
else
    log_warning "Backend directory not found at ${BACKEND_DIR}"
fi

# ============================================================================
# Node.js Dependencies (Frontend)
# ============================================================================

log_info ""
log_info "============================================"
log_info "Scanning Node.js dependencies..."
log_info "============================================"

FRONTEND_DIR="${SOURCE_DIR}/frontend"

if [ -d "${FRONTEND_DIR}" ]; then
    cd "${FRONTEND_DIR}"

    # pnpm audit
    log_info "Running pnpm audit..."
    if command -v pnpm &> /dev/null; then
        pnpm audit --json > "${SCAN_DIR}/dependencies/pnpm-audit.json" 2>/dev/null || true
        pnpm audit 2>&1 | tee "${SCAN_DIR}/dependencies/pnpm-audit.txt" || true

        NODE_VULNS=$(jq '.metadata.vulnerabilities.total // 0' "${SCAN_DIR}/dependencies/pnpm-audit.json" 2>/dev/null || echo 0)
    else
        log_warning "pnpm not installed"
    fi

    # npm audit as fallback/comparison
    log_info "Running npm audit..."
    if command -v npm &> /dev/null; then
        npm audit --json > "${SCAN_DIR}/dependencies/npm-audit.json" 2>/dev/null || true
        npm audit 2>&1 | tee "${SCAN_DIR}/dependencies/npm-audit.txt" || true
    else
        log_warning "npm not installed"
    fi

    # Snyk if available (more comprehensive)
    if command -v snyk &> /dev/null; then
        log_info "Running Snyk analysis..."
        snyk test --json > "${SCAN_DIR}/dependencies/snyk.json" 2>/dev/null || true
    fi

    log_info "Node.js vulnerabilities found: ${NODE_VULNS}"
else
    log_warning "Frontend directory not found at ${FRONTEND_DIR}"
fi

# ============================================================================
# License Compliance Check
# ============================================================================

log_info ""
log_info "============================================"
log_info "Checking license compliance..."
log_info "============================================"

if command -v pip-licenses &> /dev/null && [ -d "${BACKEND_DIR}" ]; then
    cd "${BACKEND_DIR}"
    pip-licenses --format=json --output-file="${SCAN_DIR}/dependencies/python-licenses.json" 2>/dev/null || true
    pip-licenses --format=markdown --output-file="${SCAN_DIR}/dependencies/python-licenses.md" 2>/dev/null || true
fi

if command -v license-checker &> /dev/null && [ -d "${FRONTEND_DIR}" ]; then
    cd "${FRONTEND_DIR}"
    npx license-checker --json > "${SCAN_DIR}/dependencies/node-licenses.json" 2>/dev/null || true
fi

# ============================================================================
# Summary Report
# ============================================================================

log_success "Dependency audit complete!"
echo ""

# Generate summary
{
    echo "# Dependency Vulnerability Audit Summary"
    echo "Date: $(date)"
    echo "Source: ${SOURCE_DIR}"
    echo ""
    echo "---"
    echo ""
    echo "## Python (Backend)"
    echo ""
    echo "- Vulnerabilities found: ${PYTHON_VULNS}"
    echo ""

    if [ -f "${SCAN_DIR}/dependencies/pip-audit.txt" ] && [ -s "${SCAN_DIR}/dependencies/pip-audit.txt" ]; then
        echo "### pip-audit Results:"
        echo ""
        echo '```'
        cat "${SCAN_DIR}/dependencies/pip-audit.txt"
        echo '```'
    fi

    if [ -f "${SCAN_DIR}/dependencies/bandit.txt" ] && [ -s "${SCAN_DIR}/dependencies/bandit.txt" ]; then
        echo ""
        echo "### Bandit Security Issues:"
        echo ""
        echo '```'
        head -100 "${SCAN_DIR}/dependencies/bandit.txt"
        echo '```'
    fi

    echo ""
    echo "---"
    echo ""
    echo "## Node.js (Frontend)"
    echo ""
    echo "- Vulnerabilities found: ${NODE_VULNS}"
    echo ""

    if [ -f "${SCAN_DIR}/dependencies/pnpm-audit.json" ] && [ -s "${SCAN_DIR}/dependencies/pnpm-audit.json" ]; then
        echo "### Critical/High Vulnerabilities:"
        echo ""
        jq -r '.advisories | to_entries[]? | select(.value.severity == "high" or .value.severity == "critical") | "- **\(.value.severity | ascii_upcase)**: \(.value.module_name) - \(.value.title)"' \
            "${SCAN_DIR}/dependencies/pnpm-audit.json" 2>/dev/null || echo "None or unable to parse"
    fi

    echo ""
    echo "---"
    echo ""
    echo "## Scan Output Files"
    echo ""
    ls -la "${SCAN_DIR}/dependencies/" 2>/dev/null | while read line; do
        echo "- ${line}"
    done

} > "${SCAN_DIR}/dependencies/SUMMARY.md"

cat "${SCAN_DIR}/dependencies/SUMMARY.md"

echo ""
log_info "Full results in: ${SCAN_DIR}/dependencies/"

# Set exit code based on findings
if [ "${PYTHON_VULNS}" -gt 0 ] || [ "${NODE_VULNS}" -gt 0 ]; then
    log_warning "Vulnerabilities detected! Review the detailed reports."
    exit 1
fi

exit 0
