#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

export SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/exploits"

log_info "Exploitation and Post-Exploitation Suite"
log_info "Scan directory: ${SCAN_DIR}"

# ============================================================================
# Phase 1: JWT Exploitation
# ============================================================================

log_info "Phase 1: JWT Exploitation..."
python /app/exploits/jwt_alg_confusion.py \
    --target "${TARGET_API}" \
    --username "${ADMIN_EMAIL}" \
    --password "${ADMIN_PASSWORD}" \
    2>&1 | tee "${SCAN_DIR}/exploits/jwt-exploit.log"

# ============================================================================
# Phase 2: SQL Injection Exploitation
# ============================================================================

log_info "Phase 2: SQL Injection Exploitation..."

# Get token for authenticated testing
TOKEN=$(curl -s -X POST "${TARGET_API}/auth/login" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "username=${ADMIN_EMAIL}&password=${ADMIN_PASSWORD}" | jq -r '.access_token')

python /app/exploits/sqli_exploit.py \
    --target "${TARGET_API}" \
    --token "${TOKEN}" \
    2>&1 | tee "${SCAN_DIR}/exploits/sqli-exploit.log"

# ============================================================================
# Phase 3: Password Cracking
# ============================================================================

log_info "Phase 3: Password Cracking..."
/app/scripts/crack-hashes.sh 2>&1 | tee "${SCAN_DIR}/exploits/password-crack.log"

# ============================================================================
# Phase 4: Privilege Escalation Testing
# ============================================================================

log_info "Phase 4: Privilege Escalation Testing..."
/app/scripts/privesc-test.sh 2>&1 | tee "${SCAN_DIR}/exploits/privesc.log"

# ============================================================================
# Phase 5: Evidence Collection
# ============================================================================

log_info "Phase 5: Evidence Collection..."
python /app/scripts/collect-evidence.py 2>&1 | tee "${SCAN_DIR}/exploits/evidence.log"

# ============================================================================
# Summary
# ============================================================================

log_success "Exploitation chain complete!"
log_info "Results: ${SCAN_DIR}/exploits/"

{
    echo "# Exploitation Summary"
    echo "Date: $(date)"
    echo ""
    echo "## Phases Completed"
    echo "- [x] JWT Exploitation"
    echo "- [x] SQL Injection Exploitation"
    echo "- [x] Password Cracking"
    echo "- [x] Privilege Escalation"
    echo "- [x] Evidence Collection"
    echo ""
    echo "## Files Generated"
    ls -la "${SCAN_DIR}/exploits/"
} > "${SCAN_DIR}/exploits/SUMMARY.md"

cat "${SCAN_DIR}/exploits/SUMMARY.md"
