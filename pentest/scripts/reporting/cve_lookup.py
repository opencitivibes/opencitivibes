#!/usr/bin/env python3
"""
CVE Database integration for vulnerability correlation.
"""

import json
import os
import re
import requests
from pathlib import Path
from typing import Dict, List, Optional
from datetime import datetime

NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0"
SCAN_DIR = os.environ.get("SCAN_DIR", "/app/results")


class CVEDatabase:
    def __init__(self, cache_dir: Optional[str] = None):
        self.cache_dir = Path(cache_dir or f"{SCAN_DIR}/cve_cache")
        self.cache_dir.mkdir(parents=True, exist_ok=True)

    def lookup_cve(self, cve_id: str) -> Optional[Dict]:
        """Lookup CVE details from NVD."""
        # Check cache first
        cache_file = self.cache_dir / f"{cve_id}.json"
        if cache_file.exists():
            with open(cache_file, "r") as f:
                return json.load(f)

        # Query NVD API
        try:
            response = requests.get(
                NVD_API_URL,
                params={"cveId": cve_id},
                headers={"Accept": "application/json"},
                timeout=30
            )

            if response.status_code == 200:
                data = response.json()
                if data.get("vulnerabilities"):
                    cve_data = data["vulnerabilities"][0]["cve"]

                    result = {
                        "id": cve_id,
                        "description": cve_data.get("descriptions", [{}])[0].get("value", ""),
                        "published": cve_data.get("published", ""),
                        "lastModified": cve_data.get("lastModified", ""),
                        "cvss": self._extract_cvss(cve_data),
                        "references": [ref.get("url") for ref in cve_data.get("references", [])],
                        "weaknesses": [
                            w.get("description", [{}])[0].get("value", "")
                            for w in cve_data.get("weaknesses", [])
                        ]
                    }

                    # Cache result
                    with open(cache_file, "w") as f:
                        json.dump(result, f, indent=2)

                    return result

        except Exception as e:
            print(f"Error looking up {cve_id}: {e}")

        return None

    def _extract_cvss(self, cve_data: Dict) -> Dict:
        """Extract CVSS information from CVE data."""
        metrics = cve_data.get("metrics", {})

        # Try CVSSv3.1 first, then v3.0, then v2
        for version in ["cvssMetricV31", "cvssMetricV30", "cvssMetricV2"]:
            if version in metrics and metrics[version]:
                cvss = metrics[version][0].get("cvssData", {})
                return {
                    "version": cvss.get("version", ""),
                    "score": cvss.get("baseScore", 0),
                    "severity": cvss.get("baseSeverity", ""),
                    "vector": cvss.get("vectorString", "")
                }

        return {}

    def enrich_findings(self, findings: List[Dict]) -> List[Dict]:
        """Enrich findings with CVE data."""
        enriched = []

        for finding in findings:
            # Look for CVE references
            cve_pattern = r"CVE-\d{4}-\d{4,7}"

            # Check in various fields
            text_to_search = " ".join([
                finding.get("title", ""),
                finding.get("description", ""),
                " ".join(finding.get("references", []))
            ])

            cves = re.findall(cve_pattern, text_to_search)

            if cves:
                finding["cves"] = []
                for cve_id in set(cves):
                    cve_data = self.lookup_cve(cve_id)
                    if cve_data:
                        finding["cves"].append(cve_data)

                        # Update severity if CVE has higher score
                        if cve_data.get("cvss", {}).get("score", 0) >= 9.0:
                            finding["severity"] = "CRITICAL"
                        elif cve_data.get("cvss", {}).get("score", 0) >= 7.0:
                            if finding["severity"] not in ["CRITICAL"]:
                                finding["severity"] = "HIGH"

            enriched.append(finding)

        return enriched


def main():
    # Load aggregated findings
    findings_file = Path(SCAN_DIR) / "aggregated_findings.json"
    if not findings_file.exists():
        print("Run aggregate_findings.py first")
        return

    with open(findings_file, "r") as f:
        data = json.load(f)

    # Enrich with CVE data
    db = CVEDatabase()
    enriched_findings = db.enrich_findings(data.get("findings", []))

    # Save enriched findings
    data["findings"] = enriched_findings
    data["enriched_at"] = datetime.now().isoformat()

    output_file = Path(SCAN_DIR) / "enriched_findings.json"
    with open(output_file, "w") as f:
        json.dump(data, f, indent=2)

    print(f"Enriched findings saved to: {output_file}")


if __name__ == "__main__":
    main()
