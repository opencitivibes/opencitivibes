#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

export SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/sast"

log_info "Starting comprehensive SAST analysis..."
log_info "Results directory: ${SCAN_DIR}/sast"

# ============================================================================
# Run all SAST tools
# ============================================================================

log_info "Phase 1: Bandit (Python security)"
/app/scripts/run-bandit.sh

log_info "Phase 2: Semgrep (Multi-language)"
/app/scripts/run-semgrep.sh

log_info "Phase 3: ESLint Security (TypeScript/React)"
/app/scripts/run-eslint-security.sh

log_info "Phase 4: Custom Pattern Analysis"
python /app/scripts/analyze-python-patterns.py

# ============================================================================
# Generate Combined Report
# ============================================================================

log_info "Generating combined SAST report..."

{
    echo "# SAST Analysis Report"
    echo "Date: $(date)"
    echo "Scan ID: ${SCAN_DIR##*/}"
    echo ""
    echo "## Summary"
    echo ""
    echo "### Bandit (Python)"
    if [ -f "${SCAN_DIR}/sast/bandit-report.json" ]; then
        HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' "${SCAN_DIR}/sast/bandit-report.json" 2>/dev/null || echo 0)
        MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' "${SCAN_DIR}/sast/bandit-report.json" 2>/dev/null || echo 0)
        echo "- High: ${HIGH}"
        echo "- Medium: ${MEDIUM}"
    fi
    echo ""
    echo "### Semgrep"
    if [ -f "${SCAN_DIR}/sast/semgrep-backend.json" ]; then
        ERRORS=$(jq '.results | length' "${SCAN_DIR}/sast/semgrep-backend.json" 2>/dev/null || echo 0)
        echo "- Backend findings: ${ERRORS}"
    fi
    if [ -f "${SCAN_DIR}/sast/semgrep-frontend.json" ]; then
        ERRORS=$(jq '.results | length' "${SCAN_DIR}/sast/semgrep-frontend.json" 2>/dev/null || echo 0)
        echo "- Frontend findings: ${ERRORS}"
    fi
    echo ""
    echo "### ESLint Security"
    if [ -f "${SCAN_DIR}/sast/eslint-security.json" ]; then
        ERRORS=$(jq '[.[].messages[] | select(.severity == 2)] | length' "${SCAN_DIR}/sast/eslint-security.json" 2>/dev/null || echo 0)
        echo "- Security errors: ${ERRORS}"
    fi
    echo ""
    echo "### Custom Analysis"
    if [ -f "${SCAN_DIR}/sast/custom-python-analysis.json" ]; then
        TOTAL=$(jq '.total_findings' "${SCAN_DIR}/sast/custom-python-analysis.json" 2>/dev/null || echo 0)
        echo "- Total findings: ${TOTAL}"
    fi
    echo ""
    echo "## Files Generated"
    ls -la "${SCAN_DIR}/sast/"

} > "${SCAN_DIR}/sast/SAST-SUMMARY.md"

log_success "SAST analysis complete!"
cat "${SCAN_DIR}/sast/SAST-SUMMARY.md"
