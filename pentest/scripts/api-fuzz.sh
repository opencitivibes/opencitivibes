#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/fuzzing"

TARGET_API="${TARGET_API:-http://backend:8000/api}"

log_info "Starting API fuzzing..."

# Get authentication token
TOKEN=$(curl -s -X POST "${TARGET_API}/auth/login" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "username=${ADMIN_EMAIL}&password=${ADMIN_PASSWORD}" | jq -r '.access_token')

# ============================================================================
# Directory/Endpoint Discovery
# ============================================================================

log_info "Fuzzing for hidden endpoints..."

ffuf -u "${TARGET_API}/FUZZ" \
    -w /usr/share/seclists/Discovery/Web-Content/api/api-endpoints.txt \
    -w /app/wordlists/project-specific/opencitivibes-paths.txt \
    -H "Authorization: Bearer ${TOKEN}" \
    -mc 200,201,204,301,302,307,401,403,405 \
    -o "${SCAN_DIR}/fuzzing/endpoints.json" \
    -of json \
    -t 50 \
    -rate 100

# ============================================================================
# Parameter Fuzzing
# ============================================================================

log_info "Fuzzing for hidden parameters..."

# GET parameter fuzzing on ideas endpoint
ffuf -u "${TARGET_API}/ideas/?FUZZ=test" \
    -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt \
    -H "Authorization: Bearer ${TOKEN}" \
    -mc 200 \
    -fs 0 \
    -o "${SCAN_DIR}/fuzzing/params-ideas.json" \
    -of json \
    -t 50 \
    -rate 100

# ============================================================================
# IDOR Testing via Fuzzing
# ============================================================================

log_info "Testing for IDOR vulnerabilities..."

# Generate number sequence for ID fuzzing
seq 1 100 > /tmp/ids.txt

# Fuzz idea IDs
ffuf -u "${TARGET_API}/ideas/FUZZ" \
    -w /tmp/ids.txt \
    -H "Authorization: Bearer ${TOKEN}" \
    -mc 200 \
    -o "${SCAN_DIR}/fuzzing/idor-ideas.json" \
    -of json \
    -t 20

# Fuzz user IDs (admin endpoint)
ffuf -u "${TARGET_API}/admin/users/FUZZ" \
    -w /tmp/ids.txt \
    -H "Authorization: Bearer ${TOKEN}" \
    -mc 200 \
    -o "${SCAN_DIR}/fuzzing/idor-users.json" \
    -of json \
    -t 20

# ============================================================================
# HTTP Method Fuzzing
# ============================================================================

log_info "Fuzzing HTTP methods..."

METHODS="GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD,TRACE,CONNECT"

for method in $(echo $METHODS | tr ',' '\n'); do
    ffuf -u "${TARGET_API}/ideas/1" \
        -X "${method}" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -mc 200,201,204,405 \
        -o "${SCAN_DIR}/fuzzing/methods-${method}.json" \
        -of json \
        -t 10
done

# ============================================================================
# Content-Type Fuzzing
# ============================================================================

log_info "Fuzzing Content-Types..."

cat > /tmp/content-types.txt << 'EOF'
application/json
application/xml
text/xml
text/plain
application/x-www-form-urlencoded
multipart/form-data
application/javascript
text/html
EOF

ffuf -u "${TARGET_API}/auth/login" \
    -X POST \
    -H "Content-Type: FUZZ" \
    -d "username=test&password=test" \
    -w /tmp/content-types.txt \
    -mc all \
    -o "${SCAN_DIR}/fuzzing/content-types.json" \
    -of json

# ============================================================================
# Summary
# ============================================================================

log_success "API fuzzing complete!"
log_info "Results in: ${SCAN_DIR}/fuzzing/"

# Count findings
ENDPOINTS_FOUND=$(jq '.results | length' "${SCAN_DIR}/fuzzing/endpoints.json" 2>/dev/null || echo 0)
log_info "Endpoints discovered: ${ENDPOINTS_FOUND}"
