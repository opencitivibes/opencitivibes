#!/bin/bash
# SBOM (Software Bill of Materials) Generation Script
# Uses Syft to generate CycloneDX SBOMs
# OpenCitiVibes Penetration Testing - Phase 1

source /app/scripts/helpers/colors.sh

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
SOURCE_DIR="${SOURCE_DIR:-/app/source}"
mkdir -p "${SCAN_DIR}/sbom"

log_info "Generating Software Bill of Materials..."

# Check if syft is available
if ! command -v syft &> /dev/null; then
    log_warning "Syft not installed. Using Trivy for SBOM generation."
    USE_TRIVY=true
else
    USE_TRIVY=false
fi

generate_sbom() {
    local component=$1
    local target=$2
    local output="${SCAN_DIR}/sbom/sbom-${component}.json"

    log_info "Generating SBOM for ${component}..."

    if [ "$USE_TRIVY" = true ]; then
        trivy fs --format cyclonedx --output "${output}" "${target}" 2>/dev/null
    else
        if [[ "$target" == image:* ]]; then
            syft "${target}" -o cyclonedx-json="${output}" 2>/dev/null
        else
            syft dir:"${target}" -o cyclonedx-json="${output}" 2>/dev/null
        fi
    fi

    if [ -f "${output}" ] && [ -s "${output}" ]; then
        log_success "Generated SBOM for ${component}"
        return 0
    else
        log_warning "Failed to generate SBOM for ${component}"
        return 1
    fi
}

# Generate SBOMs for each component
log_info "Scanning backend..."
if [ -d "${SOURCE_DIR}/backend" ]; then
    generate_sbom "backend" "${SOURCE_DIR}/backend"
else
    log_warning "Backend directory not found: ${SOURCE_DIR}/backend"
fi

log_info "Scanning frontend..."
if [ -d "${SOURCE_DIR}/frontend" ]; then
    generate_sbom "frontend" "${SOURCE_DIR}/frontend"
else
    log_warning "Frontend directory not found: ${SOURCE_DIR}/frontend"
fi

# Generate image SBOMs if Docker is available
if command -v docker &> /dev/null; then
    log_info "Checking for container images..."

    for IMAGE in "idees-montreal-backend:latest" "idees-montreal-frontend:latest" "opencitivibes-backend:latest" "opencitivibes-frontend:latest"; do
        if docker image inspect "${IMAGE}" &> /dev/null 2>&1; then
            IMAGE_SAFE=$(echo "${IMAGE}" | tr ':/' '__')
            log_info "Found image: ${IMAGE}"
            generate_sbom "image-${IMAGE_SAFE}" "image:${IMAGE}"
        fi
    done
else
    log_info "Docker not available, skipping container image SBOMs"
fi

# Generate packages summary CSV
log_info "Generating packages summary..."
{
    echo "package,version,component,type"
    for sbom in "${SCAN_DIR}/sbom/"sbom-*.json; do
        if [ -f "${sbom}" ]; then
            component=$(basename "${sbom}" .json | sed 's/sbom-//')
            jq -r --arg c "${component}" \
                '.components[]? | [.name, .version, $c, .type] | @csv' \
                "${sbom}" 2>/dev/null
        fi
    done
} > "${SCAN_DIR}/sbom/packages.csv"

# Count packages
TOTAL_PACKAGES=$(wc -l < "${SCAN_DIR}/sbom/packages.csv")
TOTAL_PACKAGES=$((TOTAL_PACKAGES - 1))  # Subtract header

# Generate summary
{
    echo "# SBOM Generation Summary"
    echo ""
    echo "**Date:** $(date)"
    echo "**Source Directory:** ${SOURCE_DIR}"
    echo ""
    echo "## Generated SBOMs"
    echo ""
    echo "| Component | File | Packages |"
    echo "|-----------|------|----------|"

    for sbom in "${SCAN_DIR}/sbom/"sbom-*.json; do
        if [ -f "${sbom}" ]; then
            component=$(basename "${sbom}" .json | sed 's/sbom-//')
            pkg_count=$(jq '.components | length' "${sbom}" 2>/dev/null || echo 0)
            echo "| ${component} | $(basename ${sbom}) | ${pkg_count} |"
        fi
    done

    echo ""
    echo "**Total Packages:** ${TOTAL_PACKAGES}"
    echo ""
    echo "## Files"
    echo ""
    echo "- SBOM files: \`sbom/sbom-*.json\`"
    echo "- Package list: \`sbom/packages.csv\`"

} > "${SCAN_DIR}/sbom/SUMMARY.md"

log_success "SBOM generation complete!"
log_info "Total packages discovered: ${TOTAL_PACKAGES}"
log_info "Results saved to: ${SCAN_DIR}/sbom/"
ls -la "${SCAN_DIR}/sbom/"
