#!/bin/bash
source /app/scripts/helpers/colors.sh
print_banner

SCAN_DIR="${SCAN_DIR:-/app/results/$(date +%Y%m%d_%H%M%S)}"
mkdir -p "${SCAN_DIR}/sqlmap"

TARGET_API="${TARGET_API:-http://backend:8000/api}"

log_info "Starting SQL Injection testing with SQLMap..."

# Get authentication token
log_info "Obtaining authentication token..."
TOKEN=$(curl -s -X POST "${TARGET_API}/auth/login" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "username=${ADMIN_EMAIL}&password=${ADMIN_PASSWORD}" | jq -r '.access_token')

if [ -z "${TOKEN}" ] || [ "${TOKEN}" == "null" ]; then
    log_error "Failed to obtain authentication token"
    exit 1
fi

log_success "Token obtained"

# ============================================================================
# Test Endpoints with Query Parameters
# ============================================================================

declare -a ENDPOINTS=(
    "GET|/ideas/?category_id=1|category_id"
    "GET|/ideas/leaderboard?category_id=1&skip=0&limit=10|category_id"
    "GET|/search/ideas?q=test|q"
    "GET|/comments/1|idea_id"
    "GET|/admin/users?search=admin|search"
    "GET|/admin/ideas/pending?skip=0&limit=10|skip"
)

for endpoint_spec in "${ENDPOINTS[@]}"; do
    IFS='|' read -r METHOD ENDPOINT PARAM <<< "${endpoint_spec}"

    log_info "Testing: ${METHOD} ${ENDPOINT} (param: ${PARAM})"

    sqlmap -u "${TARGET_API}${ENDPOINT}" \
        --method="${METHOD}" \
        --headers="Authorization: Bearer ${TOKEN}" \
        --param="${PARAM}" \
        --batch \
        --level=3 \
        --risk=2 \
        --technique=BEUSTQ \
        --output-dir="${SCAN_DIR}/sqlmap" \
        --forms \
        --crawl=2 \
        --threads=5 \
        --timeout=30 \
        --retries=2 \
        --tamper=space2comment,between \
        2>&1 | tee -a "${SCAN_DIR}/sqlmap/sqlmap.log"
done

# ============================================================================
# Test POST Endpoints with JSON Body
# ============================================================================

log_info "Testing POST endpoints..."

# Ideas creation
cat > /tmp/idea_payload.json << 'EOF'
{
    "title": "Test Idea*",
    "description": "Test description",
    "category_id": 1,
    "tags": ["test"]
}
EOF

sqlmap -u "${TARGET_API}/ideas/" \
    --method=POST \
    --headers="Authorization: Bearer ${TOKEN}" \
    --headers="Content-Type: application/json" \
    --data='{"title":"test*","description":"test","category_id":1}' \
    --batch \
    --level=2 \
    --risk=2 \
    --output-dir="${SCAN_DIR}/sqlmap" \
    --threads=5 \
    2>&1 | tee -a "${SCAN_DIR}/sqlmap/sqlmap.log"

# Comments creation
sqlmap -u "${TARGET_API}/comments/1" \
    --method=POST \
    --headers="Authorization: Bearer ${TOKEN}" \
    --headers="Content-Type: application/json" \
    --data='{"content":"test comment*"}' \
    --batch \
    --level=2 \
    --risk=2 \
    --output-dir="${SCAN_DIR}/sqlmap" \
    2>&1 | tee -a "${SCAN_DIR}/sqlmap/sqlmap.log"

# Search endpoint
sqlmap -u "${TARGET_API}/search/ideas" \
    --method=GET \
    --headers="Authorization: Bearer ${TOKEN}" \
    --data="q=test*" \
    --batch \
    --level=3 \
    --risk=2 \
    --output-dir="${SCAN_DIR}/sqlmap" \
    2>&1 | tee -a "${SCAN_DIR}/sqlmap/sqlmap.log"

# ============================================================================
# Summary
# ============================================================================

log_success "SQL Injection testing complete!"
log_info "Results in: ${SCAN_DIR}/sqlmap/"

# Check for vulnerabilities found
if grep -q "is vulnerable" "${SCAN_DIR}/sqlmap/sqlmap.log" 2>/dev/null; then
    log_warning "SQL Injection vulnerabilities found! Review results."
else
    log_info "No SQL Injection vulnerabilities detected"
fi
