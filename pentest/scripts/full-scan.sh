#!/bin/bash
# Master Orchestration Script - Full Security Scan
# OpenCitiVibes Penetration Testing - Phase 2

source /app/scripts/helpers/colors.sh

# ============================================================================
# Command Line Options
# ============================================================================

CLEAN_OLD_RESULTS=false
KEEP_LAST_N=0
POSITIONAL_ARGS=()

usage() {
    echo "Usage: $0 [OPTIONS] [SCAN_MODE]"
    echo ""
    echo "Scan Modes:"
    echo "  quick    - Dependencies + secrets only (fast)"
    echo "  standard - Core phases without ZAP/exploitation"
    echo "  full     - All phases including ZAP and exploitation tests (default)"
    echo "  custom   - Specify phases: recon,deps,secrets,container,sbom,nuclei,schemathesis,zap,sast,frontend,exploit,cve"
    echo ""
    echo "Options:"
    echo "  --clean           Remove ALL previous scan results before starting"
    echo "  --keep-last N     Keep only the last N scan results (removes older ones)"
    echo "  --help            Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 --clean full         # Fresh start, full scan"
    echo "  $0 --clean standard     # Fresh start, standard scan"
    echo "  $0 --keep-last 3 full   # Keep 3 most recent, run full scan"
    echo "  $0                      # Keep all results, run full scan (default)"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --clean)
            CLEAN_OLD_RESULTS=true
            shift
            ;;
        --keep-last)
            KEEP_LAST_N="$2"
            shift 2
            ;;
        --help)
            usage
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

# Restore positional arguments
set -- "${POSITIONAL_ARGS[@]}"

# ============================================================================
# Configuration
# ============================================================================

RESULTS_BASE="${RESULTS_DIR:-/app/results}"

# Clean old results if requested
if [ "$CLEAN_OLD_RESULTS" = true ]; then
    log_warning "Removing ALL previous scan results..."
    # Remove everything except .gitkeep
    find "${RESULTS_BASE}" -mindepth 1 -maxdepth 1 -type d -exec rm -rf {} \; 2>/dev/null
    find "${RESULTS_BASE}" -mindepth 1 -maxdepth 1 -type f ! -name ".gitkeep" -delete 2>/dev/null
    log_success "Previous results cleaned"
elif [ "$KEEP_LAST_N" -gt 0 ] 2>/dev/null; then
    log_info "Keeping only the last ${KEEP_LAST_N} scan results..."
    # List directories sorted by name (oldest first), skip the last N, delete the rest
    DIRS_TO_DELETE=$(find "${RESULTS_BASE}" -maxdepth 1 -type d -name "20*" | sort | head -n -${KEEP_LAST_N})
    if [ -n "$DIRS_TO_DELETE" ]; then
        echo "$DIRS_TO_DELETE" | xargs rm -rf 2>/dev/null
        log_success "Old scan results cleaned (kept last ${KEEP_LAST_N})"
    fi
fi

# Create timestamped scan directory
export SCAN_ID=$(date +%Y%m%d_%H%M%S)
export SCAN_DIR="${RESULTS_BASE}/${SCAN_ID}"
mkdir -p "${SCAN_DIR}"

# Initialize log
LOG_FILE="${SCAN_DIR}/scan.log"
exec > >(tee -a "${LOG_FILE}") 2>&1

# Track timing and results
START_TIME=$(date +%s)
declare -A PHASE_STATUS
CRITICAL_FINDINGS=0
HIGH_FINDINGS=0

# ============================================================================
# Functions
# ============================================================================

run_phase() {
    local phase_num=$1
    local phase_name=$2
    local script=$3
    local args=${4:-""}

    echo ""
    log_info "============================================"
    log_info "Phase ${phase_num}: ${phase_name}"
    log_info "============================================"
    echo ""

    local phase_start=$(date +%s)

    if [ -f "${script}" ]; then
        if ${script} ${args}; then
            PHASE_STATUS["${phase_name}"]="COMPLETED"
            log_success "Phase ${phase_num} completed successfully"
        else
            PHASE_STATUS["${phase_name}"]="COMPLETED_WITH_FINDINGS"
            log_warning "Phase ${phase_num} completed with findings"
        fi
    else
        PHASE_STATUS["${phase_name}"]="SKIPPED"
        log_warning "Script not found: ${script}"
    fi

    local phase_end=$(date +%s)
    local phase_duration=$((phase_end - phase_start))
    log_info "Phase ${phase_num} duration: ${phase_duration}s"
}

aggregate_findings() {
    log_info "Aggregating findings from all scans..."

    # Count critical findings
    CRITICAL_FINDINGS=$(grep -rh '"severity":"critical"\|"Severity":"CRITICAL"\|severity:.*critical' \
        "${SCAN_DIR}" --include="*.json" 2>/dev/null | wc -l || echo 0)

    # Count high findings
    HIGH_FINDINGS=$(grep -rh '"severity":"high"\|"Severity":"HIGH"\|severity:.*high' \
        "${SCAN_DIR}" --include="*.json" 2>/dev/null | wc -l || echo 0)
}

generate_summary() {
    local end_time=$(date +%s)
    local total_duration=$((end_time - START_TIME))

    {
        echo "# OpenCitiVibes Security Scan Summary"
        echo ""
        echo "## Scan Information"
        echo ""
        echo "| Field | Value |"
        echo "|-------|-------|"
        echo "| Scan ID | ${SCAN_ID} |"
        echo "| Start Time | $(date -d @${START_TIME}) |"
        echo "| End Time | $(date -d @${end_time}) |"
        echo "| Duration | ${total_duration} seconds |"
        echo "| Results Directory | ${SCAN_DIR} |"
        echo ""

        echo "## Phase Status"
        echo ""
        echo "| Phase | Status |"
        echo "|-------|--------|"
        for phase in "${!PHASE_STATUS[@]}"; do
            echo "| ${phase} | ${PHASE_STATUS[$phase]} |"
        done
        echo ""

        echo "## Findings Summary"
        echo ""
        echo "| Severity | Count |"
        echo "|----------|-------|"
        echo "| Critical | ${CRITICAL_FINDINGS} |"
        echo "| High | ${HIGH_FINDINGS} |"
        echo ""

        if [ "${CRITICAL_FINDINGS}" -gt 0 ]; then
            echo "## Critical Findings"
            echo ""
            echo '```'
            grep -rh '"severity":"critical"\|"Severity":"CRITICAL"' \
                "${SCAN_DIR}" --include="*.json" 2>/dev/null | head -20
            echo '```'
            echo ""
        fi

        if [ "${HIGH_FINDINGS}" -gt 0 ]; then
            echo "## High Findings"
            echo ""
            echo '```'
            grep -rh '"severity":"high"\|"Severity":"HIGH"' \
                "${SCAN_DIR}" --include="*.json" 2>/dev/null | head -20
            echo '```'
            echo ""
        fi

        echo "## Generated Reports"
        echo ""
        find "${SCAN_DIR}" -type f \( -name "*.json" -o -name "*.txt" -o -name "*.md" -o -name "*.html" \) \
            2>/dev/null | sort | while read file; do
            echo "- ${file}"
        done
        echo ""

        echo "## Next Steps"
        echo ""
        echo "1. Review critical and high findings immediately"
        echo "2. Verify false positives manually"
        echo "3. Create remediation tickets for confirmed vulnerabilities"
        echo "4. Re-scan after fixes are applied"
        echo ""

        echo "---"
        echo ""
        echo "*Generated by OpenCitiVibes Penetration Testing Suite*"

    } > "${SCAN_DIR}/SUMMARY.md"
}

# ============================================================================
# Main
# ============================================================================

print_banner

echo "=============================================="
echo "  Full Security Scan Started"
echo "  Scan ID: ${SCAN_ID}"
echo "  Time: $(date)"
echo "=============================================="
echo ""

log_info "Results directory: ${SCAN_DIR}"
log_info "Log file: ${LOG_FILE}"
echo ""

# Parse arguments
SCAN_MODE="${1:-full}"

case $SCAN_MODE in
    "quick")
        log_info "Running QUICK scan (dependencies + secrets only)"
        PHASES="deps,secrets"
        ;;
    "standard")
        log_info "Running STANDARD scan (core phases without ZAP/exploitation)"
        PHASES="recon,deps,secrets,container,sbom,nuclei,schemathesis,sast,frontend"
        ;;
    "full")
        log_info "Running FULL scan (all phases)"
        PHASES="recon,deps,secrets,container,sbom,nuclei,schemathesis,zap,sast,frontend,exploit,cve"
        ;;
    "custom")
        PHASES="${2:-recon,deps,secrets}"
        log_info "Running CUSTOM scan with phases: ${PHASES}"
        ;;
    *)
        log_error "Unknown scan mode: ${SCAN_MODE}"
        usage
        exit 1
        ;;
esac

# ============================================================================
# Execute Phases
# ============================================================================

# Phase 1: Reconnaissance
if [[ "${PHASES}" == *"recon"* ]]; then
    run_phase 1 "Reconnaissance" "/app/scripts/recon.sh"
fi

# Phase 2: Dependency Scanning
if [[ "${PHASES}" == *"deps"* ]]; then
    run_phase 2 "Dependency Vulnerability Scanning" "/app/scripts/dep-audit.sh"
fi

# Phase 3: Secret Detection
if [[ "${PHASES}" == *"secrets"* ]]; then
    run_phase 3 "Secret Detection" "/app/scripts/secret-scan.sh"
fi

# Phase 4: Container Security
if [[ "${PHASES}" == *"container"* ]]; then
    run_phase 4 "Container Security Scanning" "/app/scripts/container-scan.sh"
fi

# Phase 4.5: SBOM Generation
if [[ "${PHASES}" == *"sbom"* ]]; then
    run_phase "4.5" "SBOM Generation" "/app/scripts/generate-sbom.sh"
fi

# Phase 5: Nuclei Vulnerability Scan
if [[ "${PHASES}" == *"nuclei"* ]]; then
    run_phase 5 "Nuclei Vulnerability Scanning" "/app/scripts/run-nuclei.sh" "standard"
fi

# Phase 5.5: Schemathesis API Fuzzing
if [[ "${PHASES}" == *"schemathesis"* ]]; then
    run_phase "5.5" "Schemathesis API Fuzzing" "/app/scripts/run-schemathesis.sh" "standard"
fi

# Phase 6: OWASP ZAP Scan
if [[ "${PHASES}" == *"zap"* ]]; then
    run_phase 6 "OWASP ZAP Dynamic Scanning" "/app/scripts/run-zap.sh" "api"
fi

# Phase 7: SAST (Static Application Security Testing)
if [[ "${PHASES}" == *"sast"* ]]; then
    echo ""
    log_info "============================================"
    log_info "Phase 7: Static Application Security Testing"
    log_info "============================================"
    echo ""

    PHASE_START=$(date +%s)
    SAST_SUCCESS=true

    # Run Semgrep on backend
    log_info "Running Semgrep on backend..."
    mkdir -p "${SCAN_DIR}/sast"
    if [ -f "/app/scripts/run-semgrep.sh" ]; then
        /app/scripts/run-semgrep.sh 2>&1 | tee "${SCAN_DIR}/sast/semgrep.log" || SAST_SUCCESS=false
    fi

    # Run Bandit on backend
    log_info "Running Bandit on backend..."
    if [ -f "/app/scripts/run-bandit.sh" ]; then
        /app/scripts/run-bandit.sh 2>&1 | tee "${SCAN_DIR}/sast/bandit.log" || SAST_SUCCESS=false
    fi

    PHASE_END=$(date +%s)
    log_info "Phase 7 duration: $((PHASE_END - PHASE_START))s"

    if [ "$SAST_SUCCESS" = true ]; then
        PHASE_STATUS["SAST Analysis"]="COMPLETED"
        log_success "Phase 7 completed successfully"
    else
        PHASE_STATUS["SAST Analysis"]="COMPLETED_WITH_FINDINGS"
        log_warning "Phase 7 completed with findings"
    fi
fi

# Phase 8: Frontend Security Testing
if [[ "${PHASES}" == *"frontend"* ]]; then
    echo ""
    log_info "============================================"
    log_info "Phase 8: Frontend Security Testing"
    log_info "============================================"
    echo ""

    PHASE_START=$(date +%s)
    mkdir -p "${SCAN_DIR}/frontend"

    if [ -f "/app/scripts/frontend-security-test.py" ]; then
        python3 /app/scripts/frontend-security-test.py \
            --url "${TARGET_FRONTEND:-http://frontend:3000}" \
            --output "${SCAN_DIR}/frontend" 2>&1 | tee "${SCAN_DIR}/frontend/test.log"

        if [ $? -eq 0 ]; then
            PHASE_STATUS["Frontend Security"]="COMPLETED"
            log_success "Phase 8 completed successfully"
        else
            PHASE_STATUS["Frontend Security"]="COMPLETED_WITH_FINDINGS"
            log_warning "Phase 8 completed with findings"
        fi
    else
        PHASE_STATUS["Frontend Security"]="SKIPPED"
        log_warning "Script not found: /app/scripts/frontend-security-test.py"
    fi

    PHASE_END=$(date +%s)
    log_info "Phase 8 duration: $((PHASE_END - PHASE_START))s"
fi

# Phase 9: Exploitation Tests (Safe Mode - --no-exec)
if [[ "${PHASES}" == *"exploit"* ]]; then
    echo ""
    log_info "============================================"
    log_info "Phase 9: Exploitation Tests (Safe Mode)"
    log_info "============================================"
    echo ""

    PHASE_START=$(date +%s)
    mkdir -p "${SCAN_DIR}/exploits"
    EXPLOIT_SUCCESS=true

    # Container escape detection (read-only analysis)
    log_info "Running container escape checks..."
    if [ -f "/app/scripts/container-escape-checks.sh" ]; then
        /app/scripts/container-escape-checks.sh 2>&1 | tee "${SCAN_DIR}/exploits/container-escape.log" || true
    fi

    # JWT testing in dry-run mode (requires a token)
    log_info "JWT vulnerability analysis (dry-run)..."
    if [ -f "/app/scripts/jwt-test.py" ]; then
        # Try to get a token for analysis
        if [ -n "${ADMIN_EMAIL}" ] && [ -n "${ADMIN_PASSWORD}" ]; then
            TOKEN=$(curl -sf -X POST "${TARGET_API:-http://backend:8000}/api/auth/login" \
                -H "Content-Type: application/x-www-form-urlencoded" \
                -d "username=${ADMIN_EMAIL}&password=${ADMIN_PASSWORD}" 2>/dev/null | jq -r '.access_token // empty')

            if [ -n "${TOKEN}" ]; then
                python3 /app/scripts/jwt-test.py \
                    --token "${TOKEN}" \
                    --no-exec \
                    --output "${SCAN_DIR}/exploits" 2>&1 | tee "${SCAN_DIR}/exploits/jwt-test.log" || EXPLOIT_SUCCESS=false
            else
                log_warning "Could not obtain JWT token for analysis"
            fi
        else
            log_warning "ADMIN_EMAIL/ADMIN_PASSWORD not set, skipping JWT test"
        fi
    fi

    PHASE_END=$(date +%s)
    log_info "Phase 9 duration: $((PHASE_END - PHASE_START))s"

    if [ "$EXPLOIT_SUCCESS" = true ]; then
        PHASE_STATUS["Exploitation Tests"]="COMPLETED"
        log_success "Phase 9 completed successfully"
    else
        PHASE_STATUS["Exploitation Tests"]="COMPLETED_WITH_FINDINGS"
        log_warning "Phase 9 completed with findings"
    fi
fi

# Phase 10: CVE Correlation (OSV + KEV)
if [[ "${PHASES}" == *"cve"* ]]; then
    echo ""
    log_info "============================================"
    log_info "Phase 10: CVE Intelligence & KEV Correlation"
    log_info "============================================"
    echo ""

    PHASE_START=$(date +%s)
    mkdir -p "${SCAN_DIR}/cve"

    # Run unified CVE scan if available
    if [ -f "/app/scripts/cve-scan-unified.sh" ]; then
        /app/scripts/cve-scan-unified.sh 2>&1 | tee "${SCAN_DIR}/cve/unified-scan.log"

        if [ $? -eq 0 ]; then
            PHASE_STATUS["CVE Correlation"]="COMPLETED"
            log_success "Phase 10 completed successfully"
        else
            PHASE_STATUS["CVE Correlation"]="COMPLETED_WITH_FINDINGS"
            log_warning "Phase 10 completed with findings"
        fi
    else
        # Fallback to individual scripts
        log_info "Running SBOM-to-CVE correlation..."
        if [ -f "/app/scripts/cve/sbom_correlate.py" ]; then
            python3 /app/scripts/cve/sbom_correlate.py 2>&1 | tee "${SCAN_DIR}/cve/sbom-correlate.log" || true
        fi

        log_info "Running KEV correlation..."
        if [ -f "/app/scripts/cve/kev_correlate.py" ]; then
            python3 /app/scripts/cve/kev_correlate.py --scan-dir "${SCAN_DIR}" 2>&1 | tee "${SCAN_DIR}/cve/kev-correlate.log" || true
        fi

        PHASE_STATUS["CVE Correlation"]="COMPLETED"
        log_success "Phase 10 completed"
    fi

    PHASE_END=$(date +%s)
    log_info "Phase 10 duration: $((PHASE_END - PHASE_START))s"
fi

# ============================================================================
# Generate Final Report
# ============================================================================

echo ""
log_info "============================================"
log_info "Generating Final Report"
log_info "============================================"
echo ""

aggregate_findings
generate_summary

# Run Python aggregator and report generator with the specific scan directory
log_info "Running comprehensive report generation..."
if command -v python3 &> /dev/null; then
    # Aggregate findings from THIS scan only
    python3 /app/scripts/reporting/aggregate_findings.py --scan-dir "${SCAN_DIR}" 2>/dev/null || \
        log_warning "Aggregate findings script failed"

    # Generate reports from THIS scan only
    python3 /app/scripts/reporting/generate_report.py --scan-dir "${SCAN_DIR}" 2>/dev/null || \
        log_warning "Report generation script failed"
else
    log_warning "Python3 not available for advanced reporting"
fi

# ============================================================================
# Completion
# ============================================================================

END_TIME=$(date +%s)
TOTAL_DURATION=$((END_TIME - START_TIME))

echo ""
log_success "=============================================="
log_success "  Full Security Scan Complete"
log_success "=============================================="
echo ""
log_info "Scan ID: ${SCAN_ID}"
log_info "Duration: ${TOTAL_DURATION} seconds"
log_info "Results: ${SCAN_DIR}/"
log_info "Summary: ${SCAN_DIR}/SUMMARY.md"
log_info "Log: ${LOG_FILE}"
echo ""

# Display summary
if [ "${CRITICAL_FINDINGS}" -gt 0 ]; then
    log_error "CRITICAL FINDINGS: ${CRITICAL_FINDINGS}"
fi

if [ "${HIGH_FINDINGS}" -gt 0 ]; then
    log_warning "HIGH FINDINGS: ${HIGH_FINDINGS}"
fi

echo ""
log_info "Phase Status Summary:"
for phase in "${!PHASE_STATUS[@]}"; do
    case ${PHASE_STATUS[$phase]} in
        "COMPLETED")
            echo -e "  ${GREEN}[+]${NC} ${phase}: ${PHASE_STATUS[$phase]}"
            ;;
        "COMPLETED_WITH_FINDINGS")
            echo -e "  ${YELLOW}[!]${NC} ${phase}: ${PHASE_STATUS[$phase]}"
            ;;
        "SKIPPED")
            echo -e "  ${RED}[-]${NC} ${phase}: ${PHASE_STATUS[$phase]}"
            ;;
    esac
done

echo ""
cat "${SCAN_DIR}/SUMMARY.md"

# Exit with appropriate code
if [ "${CRITICAL_FINDINGS}" -gt 0 ]; then
    exit 2
elif [ "${HIGH_FINDINGS}" -gt 0 ]; then
    exit 1
else
    exit 0
fi
