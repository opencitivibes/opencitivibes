#!/bin/bash
set -e

# ============================================================================
# OpenCitiVibes Pentest Container Entrypoint
# ============================================================================

echo "=============================================="
echo "  OpenCitiVibes Penetration Testing Container"
echo "=============================================="
echo ""

# Display environment info
echo "[*] Python version: $(python --version)"
echo "[*] Node.js version: $(node --version)"
echo "[*] Go version: $(go version)"
echo ""

# Check network connectivity to targets
echo "[*] Checking network connectivity..."

if ping -c 1 backend &>/dev/null; then
    echo "    [+] Backend reachable at backend:8000"
else
    echo "    [-] Backend not reachable (expected in standalone mode)"
fi

if ping -c 1 frontend &>/dev/null; then
    echo "    [+] Frontend reachable at frontend:3000"
else
    echo "    [-] Frontend not reachable (expected in standalone mode)"
fi

echo ""

# Create results directories with timestamp
SCAN_ID=$(date +%Y%m%d_%H%M%S)
export SCAN_DIR="${RESULTS_DIR}/${SCAN_ID}"
mkdir -p "${SCAN_DIR}"/{scans,exploits,evidence,reports}

echo "[*] Scan directory: ${SCAN_DIR}"
echo ""

# Initialize log file
LOG_FILE="${SCAN_DIR}/pentest.log"
echo "Penetration test started at $(date)" > "${LOG_FILE}"

# Export useful environment variables
export TARGET_BACKEND="http://backend:8000"
export TARGET_FRONTEND="http://frontend:3000"
export TARGET_API="${TARGET_BACKEND}/api"

# Source any custom environment
if [ -f /app/config/.env ]; then
    source /app/config/.env
fi

echo "[*] Environment variables set:"
echo "    TARGET_BACKEND=${TARGET_BACKEND}"
echo "    TARGET_FRONTEND=${TARGET_FRONTEND}"
echo "    TARGET_API=${TARGET_API}"
echo ""

# Display available tools
echo "[*] Available tools:"
echo "    Scanning: nmap, masscan, nikto, nuclei, zap"
echo "    Web: sqlmap, ffuf, gobuster, dirb, wfuzz"
echo "    JWT: jwt_tool, python-jose"
echo "    SAST: bandit, semgrep, pip-audit"
echo "    Container: trivy, grype"
echo "    Secrets: gitleaks, trufflehog"
echo "    Password: hydra, john, hashcat"
echo "    Exploitation: metasploit, impacket"
echo ""

echo "[*] Custom scripts available in /app/scripts/"
ls -la /app/scripts/*.sh 2>/dev/null || echo "    No custom scripts found"
echo ""

# Verify optional tools
echo "[*] Optional tools status:"
command -v playwright &>/dev/null && echo "    [+] Playwright: $(playwright --version 2>/dev/null || echo 'installed')" || echo "    [-] Playwright: not installed"
command -v schemathesis &>/dev/null && echo "    [+] Schemathesis: $(schemathesis --version 2>/dev/null | head -1 || echo 'installed')" || echo "    [-] Schemathesis: not installed"
command -v syft &>/dev/null && echo "    [+] Syft: $(syft version 2>/dev/null | head -1 || echo 'installed')" || echo "    [-] Syft: not installed (using Trivy for SBOM)"
echo ""

# Export additional environment variables
export PLAYWRIGHT_HEADLESS=${PLAYWRIGHT_HEADLESS:-true}
export SCHEMA_FILE=${SCHEMA_FILE:-http://backend:8000/openapi.json}
export SBOM_OUTPUT=${SBOM_OUTPUT:-/app/results/$SCAN_ID/sbom}

echo "[*] Ready for testing. Starting shell..."
echo "=============================================="

# Execute command or start interactive shell
exec "$@"
