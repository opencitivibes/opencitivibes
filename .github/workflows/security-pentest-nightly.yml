name: Security - Nightly Full Scan

# Comprehensive penetration testing
# Runs nightly or on-demand

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:
    inputs:
      scan_mode:
        description: 'Scan mode'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - full
      target_branch:
        description: 'Branch to scan'
        required: false
        default: 'main'

permissions:
  contents: read
  security-events: write
  issues: write
  actions: read

env:
  SCAN_MODE: ${{ github.event.inputs.scan_mode || 'standard' }}
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'main' }}

jobs:
  prepare:
    name: Prepare Environment
    runs-on: ubuntu-latest
    outputs:
      scan_id: ${{ steps.scan-id.outputs.id }}
    steps:
      - name: Generate Scan ID
        id: scan-id
        run: echo "id=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: Validate Docker Compose files
        run: |
          if [ -f Docker/docker-compose.dev.yml ]; then
            docker compose -f Docker/docker-compose.dev.yml config > /dev/null
            echo "Docker Compose validated successfully"
          fi

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Analysis Tools
        run: |
          pip install bandit semgrep safety

      - name: Run Bandit
        continue-on-error: true
        run: |
          bandit -r backend/ \
            -f json \
            -o bandit-results.json \
            --exclude ".venv,tests,__pycache__" \
            -ll || true

      - name: Run Semgrep (Extended)
        continue-on-error: true
        run: |
          semgrep scan \
            --config p/python \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --config p/secrets \
            --json \
            --output semgrep-extended.json \
            backend/ frontend/src/ \
            --exclude ".venv" \
            --exclude "node_modules" \
            --exclude ".next" \
            --exclude "__pycache__" || true

      - name: Upload SAST Results
        uses: actions/upload-artifact@v4
        with:
          name: sast-results-${{ needs.prepare.outputs.scan_id }}
          path: |
            bandit-results.json
            semgrep-extended.json
          retention-days: 90

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Audit Python Dependencies
        continue-on-error: true
        run: |
          pip install pip-audit safety
          if [ -f backend/requirements.txt ]; then
            pip-audit -r backend/requirements.txt --format json --output pip-audit.json || true
            safety check -r backend/requirements.txt --json --output safety.json || true
          fi

      - name: Audit Node Dependencies
        continue-on-error: true
        run: |
          npm install -g pnpm
          if [ -f frontend/package.json ]; then
            cd frontend
            pnpm install --frozen-lockfile || pnpm install
            pnpm audit --json > ../pnpm-audit.json 2>&1 || true
          fi

      - name: Upload Audit Results
        uses: actions/upload-artifact@v4
        with:
          name: audit-results-${{ needs.prepare.outputs.scan_id }}
          path: |
            pip-audit.json
            safety.json
            pnpm-audit.json
          retention-days: 90
          if-no-files-found: ignore

  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: Run Trivy (Full)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-full.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          timeout: '15m'

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'cyclonedx'
          output: 'sbom-full.json'
          timeout: '10m'

      - name: Build and Scan Docker Images
        continue-on-error: true
        run: |
          if [ -f backend/Dockerfile ]; then
            docker build -t ocv-backend:scan backend/
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
              aquasec/trivy image --format json --output trivy-backend-image.json \
              ocv-backend:scan || true
          fi

      - name: Upload Container Results
        uses: actions/upload-artifact@v4
        with:
          name: container-results-${{ needs.prepare.outputs.scan_id }}
          path: |
            trivy-*.json
            sbom-*.json
          retention-days: 90

  dynamic-scan:
    name: Dynamic Scanning
    runs-on: ubuntu-latest
    needs: [prepare, static-analysis]
    if: github.event.inputs.scan_mode != 'quick'
    services:
      backend:
        image: python:3.13-slim
        ports:
          - 8000:8000
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: Setup Environment
        run: |
          # Note: In production, start actual application containers
          echo "Dynamic scanning would run here with live application"

      - name: Run Nuclei
        continue-on-error: true
        uses: projectdiscovery/nuclei-action@main
        with:
          target: http://localhost:8000
          templates: community-templates
          output: nuclei-results.json
          json: true

      - name: Upload Dynamic Results
        uses: actions/upload-artifact@v4
        with:
          name: dynamic-results-${{ needs.prepare.outputs.scan_id }}
          path: nuclei-results.json
          retention-days: 90
          if-no-files-found: ignore

  aggregate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [prepare, static-analysis, dependency-audit, container-security]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: scan-results/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install reporting dependencies
        run: pip install jinja2

      - name: Aggregate Findings
        id: aggregate
        run: |
          CRITICAL=0
          HIGH=0
          MEDIUM=0

          # Count from all JSON files
          for file in scan-results/*/*.json; do
            if [ -f "$file" ]; then
              C=$(jq '[.. | .Severity? // .severity? // empty | select(. == "CRITICAL" or . == "critical" or . == "ERROR")] | length' "$file" 2>/dev/null || echo 0)
              H=$(jq '[.. | .Severity? // .severity? // empty | select(. == "HIGH" or . == "high" or . == "WARNING")] | length' "$file" 2>/dev/null || echo 0)
              M=$(jq '[.. | .Severity? // .severity? // empty | select(. == "MEDIUM" or . == "medium")] | length' "$file" 2>/dev/null || echo 0)
              CRITICAL=$((CRITICAL + C))
              HIGH=$((HIGH + H))
              MEDIUM=$((MEDIUM + M))
            fi
          done

          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT

          # Create summary JSON
          cat > scan-results/SUMMARY.json << EOF
          {
            "scan_id": "${{ needs.prepare.outputs.scan_id }}",
            "scan_mode": "${{ env.SCAN_MODE }}",
            "branch": "${{ env.TARGET_BRANCH }}",
            "timestamp": "$(date -Iseconds)",
            "findings": {
              "critical": ${CRITICAL},
              "high": ${HIGH},
              "medium": ${MEDIUM}
            }
          }
          EOF

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: pentest-report-${{ needs.prepare.outputs.scan_id }}
          path: scan-results/
          retention-days: 90

      - name: Create Issue for Critical Findings
        if: steps.aggregate.outputs.critical > 0
        uses: actions/github-script@v7
        with:
          script: |
            const critical = parseInt('${{ steps.aggregate.outputs.critical }}');
            const high = parseInt('${{ steps.aggregate.outputs.high }}');
            const scanId = '${{ needs.prepare.outputs.scan_id }}';

            const body = `## Security Scan Alert

            **Scan ID:** ${scanId}
            **Branch:** ${{ env.TARGET_BRANCH }}
            **Mode:** ${{ env.SCAN_MODE }}

            ### Findings Summary

            | Severity | Count |
            |----------|-------|
            | Critical | ${critical} |
            | High | ${high} |

            ### Required Actions

            1. Review the scan artifacts attached to this workflow run
            2. Triage findings and identify false positives
            3. Create remediation tickets for confirmed vulnerabilities
            4. Re-run scan after fixes are applied

            ### Artifacts

            [Download scan results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *Automated alert from OpenCitiVibes Security Scan*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Security] ${critical} Critical Finding(s) - ${scanId}`,
              body: body,
              labels: ['security', 'critical', 'automated']
            });

      - name: Post Workflow Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Security Scan Summary

          | Metric | Value |
          |--------|-------|
          | Scan ID | ${{ needs.prepare.outputs.scan_id }} |
          | Mode | ${{ env.SCAN_MODE }} |
          | Branch | ${{ env.TARGET_BRANCH }} |
          | Critical | ${{ steps.aggregate.outputs.critical }} |
          | High | ${{ steps.aggregate.outputs.high }} |
          | Medium | ${{ steps.aggregate.outputs.medium }} |

          [Download full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: Set Exit Code
        if: steps.aggregate.outputs.critical > 0
        run: exit 1
