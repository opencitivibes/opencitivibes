name: Security - Quick Pentest

# Runs on pull requests to main/develop
# Fast security checks (~5 min) that can block merges
# Temporarily disabled - enable after CI is stable

on:
  workflow_dispatch: # Allow manual trigger only
  # pull_request:
  #   branches: [main, develop]
  #   paths:
  #     - 'backend/**'
  #     - 'frontend/**'
  #     - 'requirements*.txt'
  #     - 'package.json'
  #     - 'pnpm-lock.yaml'

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: security-quick-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_NOTIFY_USER_LIST: ${{ github.event.pull_request.user.login }}

      - name: Upload Gitleaks Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 7
          if-no-files-found: ignore

  sast-backend:
    name: SAST - Backend
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep on Backend
        run: |
          semgrep scan \
            --config p/python \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --json \
            --output semgrep-backend.json \
            backend/ \
            --exclude ".venv" \
            --exclude "__pycache__" \
            --exclude "tests" || true

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-backend
          path: semgrep-backend.json
          retention-days: 7

  sast-frontend:
    name: SAST - Frontend
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep on Frontend
        run: |
          semgrep scan \
            --config p/typescript \
            --config p/react \
            --config p/nextjs \
            --json \
            --output semgrep-frontend.json \
            frontend/src/ \
            --exclude "node_modules" \
            --exclude ".next" || true

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-frontend
          path: semgrep-frontend.json
          retention-days: 7

  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Scan Python Dependencies
        continue-on-error: true
        run: |
          if [ -f backend/requirements.txt ]; then
            cd backend && pip-audit --requirement requirements.txt --format json --output ../pip-audit.json || true
          fi

      - name: Scan Node Dependencies
        continue-on-error: true
        run: |
          if [ -f frontend/package.json ]; then
            cd frontend
            npm install -g pnpm
            pnpm audit --json > ../pnpm-audit.json 2>&1 || true
          fi

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            pip-audit.json
            pnpm-audit.json
          retention-days: 7
          if-no-files-found: ignore

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-fs.json'
          severity: 'CRITICAL,HIGH'
          timeout: '10m'

      - name: Run Trivy SBOM generation
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'cyclonedx'
          output: 'sbom.json'
          timeout: '5m'

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-fs.json
            sbom.json
          retention-days: 7

  aggregate-and-comment:
    name: Aggregate and Report
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-backend, sast-frontend, dependency-scan, trivy-scan]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/

      - name: Generate Summary
        id: summary
        run: |
          CRITICAL=0
          HIGH=0
          SECRETS=0

          # Count Semgrep errors (backend)
          if [ -f reports/semgrep-backend/semgrep-backend.json ]; then
            SEMGREP_C=$(jq '[.results[]? | select(.extra.severity == "ERROR")] | length' reports/semgrep-backend/semgrep-backend.json 2>/dev/null || echo 0)
            CRITICAL=$((CRITICAL + SEMGREP_C))
          fi

          # Count Semgrep errors (frontend)
          if [ -f reports/semgrep-frontend/semgrep-frontend.json ]; then
            SEMGREP_F=$(jq '[.results[]? | select(.extra.severity == "ERROR")] | length' reports/semgrep-frontend/semgrep-frontend.json 2>/dev/null || echo 0)
            CRITICAL=$((CRITICAL + SEMGREP_F))
          fi

          # Count Trivy findings
          if [ -f reports/trivy-reports/trivy-fs.json ]; then
            TRIVY_C=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' reports/trivy-reports/trivy-fs.json 2>/dev/null || echo 0)
            TRIVY_H=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' reports/trivy-reports/trivy-fs.json 2>/dev/null || echo 0)
            CRITICAL=$((CRITICAL + TRIVY_C))
            HIGH=$((HIGH + TRIVY_H))
          fi

          # Check for secrets
          if [ -f reports/gitleaks-report/results.sarif ]; then
            SECRETS=$(jq '.runs[0].results | length' reports/gitleaks-report/results.sarif 2>/dev/null || echo 0)
          fi

          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "secrets=${SECRETS}" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const critical = parseInt('${{ steps.summary.outputs.critical }}') || 0;
            const high = parseInt('${{ steps.summary.outputs.high }}') || 0;
            const secrets = parseInt('${{ steps.summary.outputs.secrets }}') || 0;

            let status = ':white_check_mark: **PASSED**';
            let statusEmoji = ':white_check_mark:';

            if (secrets > 0) {
              status = ':rotating_light: **BLOCKED** - Secrets detected in code!';
              statusEmoji = ':rotating_light:';
            } else if (critical > 0) {
              status = ':x: **BLOCKED** - Critical vulnerabilities found';
              statusEmoji = ':x:';
            } else if (high > 5) {
              status = ':warning: **WARNING** - Multiple high-severity findings';
              statusEmoji = ':warning:';
            }

            const body = `## ${statusEmoji} Security Scan Results

            ${status}

            | Severity | Count |
            |----------|-------|
            | Secrets | ${secrets} |
            | Critical | ${critical} |
            | High | ${high} |

            ---

            <details>
            <summary>Scan Details</summary>

            - **Gitleaks**: Secret detection in code and history
            - **Semgrep**: Static analysis (Python + TypeScript)
            - **Trivy**: Dependency vulnerabilities
            - **pip-audit**: Python package vulnerabilities
            - **pnpm audit**: Node package vulnerabilities

            </details>

            [View full artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *Automated security scan by OpenCitiVibes Pentest Framework*`;

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (e) {
              console.log('Could not post comment:', e.message);
            }

      - name: Fail on Critical or Secrets
        if: steps.summary.outputs.critical > 0 || steps.summary.outputs.secrets > 0
        run: |
          echo "Critical findings or secrets detected!"
          exit 1
